{% extends "base.html" %}

{% block title %}{{ t('materials.title') }} - {{ t('site.title') }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">
            <i class="fas fa-boxes mr-2"></i>{{ t('materials.title') }}
        </h1>
        {% if current_user.is_admin %}
        <button onclick="showAddMaterialModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
            <i class="fas fa-plus mr-2"></i>{{ t('materials.add_material') }}
        </button>
        {% endif %}
    </div>

    <!-- Filters and grid (same as previous template) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ t('materials.search') }}
                </label>
                <input type="text" id="search-input" placeholder="{{ t('materials.search_placeholder') }}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ t('materials.type') }}</label>
                <select id="type-filter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="">{{ t('materials.all_types') }}</option>
                    <option value="corda">{{ t('materials.type_corda') }}</option>
                    <option value="serving">{{ t('materials.type_serving') }}</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ t('materials.low_stock') }}</label>
                <input type="number" id="low-stock-input" placeholder="< 50" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div class="flex items-end">
                <button onclick="loadMaterials()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition"><i class="fas fa-filter mr-2"></i>{{ t('materials.apply_filters') }}</button>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center py-8 hidden">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
        <p class="mt-2 text-gray-600 dark:text-gray-400">{{ t('common.loading') }}</p>
    </div>

    <div id="materials-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <div id="no-results" class="text-center py-8 hidden"><i class="fas fa-box-open text-6xl text-gray-400"></i><p class="mt-4 text-gray-600 dark:text-gray-400">{{ t('materials.no_results') }}</p></div>
</div>

{% if current_user.is_admin %}
<!-- Add/Edit Material Modal -->
<div id="material-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4" id="modal-title">
            {{ t('materials.add_material') }}
        </h2>

        <form id="material-form" onsubmit="saveMaterial(event)">
            <input type="hidden" id="material-id">

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ t('materials.material_name') }}*
                </label>
                <input type="text" id="materiale" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ t('materials.color') }}*
                </label>
                <input type="text" id="colore" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ t('materials.thickness') }}*
                </label>
                <input type="text" id="spessore" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {{ t('materials.remaining_grams') }}*
                    </label>
                    <input type="text" id="rimasto" required
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {{ t('materials.cost_euro') }}*
                    </label>
                    <input type="text" id="costo" required
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ t('materials.type') }}*
                </label>
                <select id="tipo" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="corda">{{ t('materials.type_corda') }}</option>
                    <option value="serving">{{ t('materials.type_serving') }}</option>
                </select>
            </div>

            <div class="flex gap-2">
                <button type="button" onclick="closeMaterialModal()" 
                    class="flex-1 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-lg transition">
                    {{ t('common.cancel') }}
                </button>
                <button type="submit" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    {{ t('common.save') }}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Consume Material Modal -->
<div id="consume-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">
            {{ t('materials.consume_material') }}
        </h2>

        <p class="text-gray-600 dark:text-gray-400 mb-4" id="consume-material-name"></p>

        <form onsubmit="consumeMaterial(event)">
            <input type="hidden" id="consume-material-id">

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ t('materials.quantity_grams') }}*
                </label>
                <input type="text" id="consume-quantity" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            </div>

            <div class="flex gap-2">
                <button type="button" onclick="closeConsumeModal()" 
                    class="flex-1 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-lg transition">
                    {{ t('common.cancel') }}
                </button>
                <button type="submit" 
                    class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition">
                    {{ t('materials.consume') }}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentMaterials = [];

// Helper function to parse decimal with both comma and dot support
function parseDecimal(value) {
    if (typeof value === 'number') return value;
    if (!value) return 0;
    // Replace comma with dot for parsing
    return parseFloat(value.toString().replace(',', '.')) || 0;
}

// Load materials on page load
document.addEventListener('DOMContentLoaded', () => {
    loadMaterials();
});

async function loadMaterials() {
    const loading = document.getElementById('loading');
    const grid = document.getElementById('materials-grid');
    const noResults = document.getElementById('no-results');

    loading.classList.remove('hidden');
    grid.innerHTML = '';
    noResults.classList.add('hidden');

    try {
        const params = new URLSearchParams();
        
        const search = document.getElementById('search-input').value;
        if (search) params.append('q', search);
        
        const tipo = document.getElementById('type-filter').value;
        if (tipo) params.append('tipo', tipo);
        
        const lowStock = document.getElementById('low-stock-input').value;
        if (lowStock) params.append('low_stock_lt', lowStock);

        const response = await fetch(`/api/materiali?${params.toString()}`);
        const materials = await response.json();

        currentMaterials = materials;

        if (materials.length === 0) {
            noResults.classList.remove('hidden');
        } else {
            materials.forEach(material => {
                grid.appendChild(createMaterialCard(material));
            });
        }
    } catch (error) {
        console.error('Error loading materials:', error);
        showNotification('{{ t("materials.error_loading") }}', 'error');
    } finally {
        loading.classList.add('hidden');
    }
}

function createMaterialCard(material) {
    const card = document.createElement('div');
    card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 hover:shadow-lg transition';

    const lowStock = material.rimasto < 50;
    const stockClass = lowStock ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';
    
    const tipoLabel = material.tipo === 'corda' ? '{{ t("materials.type_corda") }}' : '{{ t("materials.type_serving") }}';
    const tipoColor = material.tipo === 'corda' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';

    card.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <div>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">${material.materiale}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">${material.colore} - ${material.spessore}</p>
            </div>
            <span class="px-2 py-1 text-xs font-semibold rounded ${tipoColor}">
                ${tipoLabel}
            </span>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
            <div>
                <span class="text-gray-600 dark:text-gray-400">{{ t('materials.remaining') }}:</span>
                <span class="${stockClass} font-semibold">${material.rimasto.toFixed(2)}g</span>
            </div>
            <div>
                <span class="text-gray-600 dark:text-gray-400">{{ t('materials.cost') }}:</span>
                <span class="font-semibold">€${material.costo.toFixed(2)}</span>
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="showConsumeModal(${material.id}, '${material.materiale} ${material.colore}')" 
                class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm transition">
                <i class="fas fa-minus mr-1"></i>{{ t('materials.consume') }}
            </button>
            {% if current_user.is_admin %}
            <button onclick="editMaterial(${material.id})" 
                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition">
                <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteMaterial(${material.id})" 
                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    `;

    return card;
}

function showAddMaterialModal() {
    document.getElementById('modal-title').textContent = '{{ t("materials.add_material") }}';
    document.getElementById('material-id').value = '';
    document.getElementById('material-form').reset();
    document.getElementById('material-modal').classList.remove('hidden');
}

function closeMaterialModal() {
    document.getElementById('material-modal').classList.add('hidden');
}

function editMaterial(id) {
    const material = currentMaterials.find(m => m.id === id);
    if (!material) return;

    document.getElementById('modal-title').textContent = '{{ t("materials.edit_material") }}';
    document.getElementById('material-id').value = material.id;
    document.getElementById('materiale').value = material.materiale;
    document.getElementById('colore').value = material.colore;
    document.getElementById('spessore').value = material.spessore;
    document.getElementById('rimasto').value = material.rimasto;
    document.getElementById('costo').value = material.costo;
    document.getElementById('tipo').value = material.tipo;
    document.getElementById('material-modal').classList.remove('hidden');
}

async function saveMaterial(event) {
    event.preventDefault();

    const id = document.getElementById('material-id').value;
    const data = {
        materiale: document.getElementById('materiale').value,
        colore: document.getElementById('colore').value,
        spessore: document.getElementById('spessore').value,
        rimasto: parseDecimal(document.getElementById('rimasto').value),
        costo: parseDecimal(document.getElementById('costo').value),
        tipo: document.getElementById('tipo').value
    };

    try {
        const url = id ? `/api/materiali/${id}` : '/api/materiali';
        const method = id ? 'PATCH' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            showNotification(id ? '{{ t("materials.updated") }}' : '{{ t("materials.created") }}', 'success');
            closeMaterialModal();
            loadMaterials();
        } else {
            const error = await response.json();
            showNotification(error.error || '{{ t("materials.error_saving") }}', 'error');
        }
    } catch (error) {
        console.error('Error saving material:', error);
        showNotification('{{ t("materials.error_saving") }}', 'error');
    }
}

async function deleteMaterial(id) {
    if (!confirm('{{ t("materials.confirm_delete") }}')) return;

    try {
        const response = await fetch(`/api/materiali/${id}`, { method: 'DELETE' });

        if (response.ok) {
            showNotification('{{ t("materials.deleted") }}', 'success');
            loadMaterials();
        } else {
            const error = await response.json();
            showNotification(error.error || '{{ t("materials.error_deleting") }}', 'error');
        }
    } catch (error) {
        console.error('Error deleting material:', error);
        showNotification('{{ t("materials.error_deleting") }}', 'error');
    }
}

function showConsumeModal(id, name) {
    document.getElementById('consume-material-id').value = id;
    document.getElementById('consume-material-name').textContent = name;
    document.getElementById('consume-quantity').value = '';
    document.getElementById('consume-modal').classList.remove('hidden');
}

function closeConsumeModal() {
    document.getElementById('consume-modal').classList.add('hidden');
}

async function consumeMaterial(event) {
    event.preventDefault();

    const id = document.getElementById('consume-material-id').value;
    const quantita = parseDecimal(document.getElementById('consume-quantity').value);

    try {
        const response = await fetch(`/api/materiali/${id}/consume`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantita })
        });

        if (response.ok) {
            showNotification('{{ t("materials.consumed_success") }}', 'success');
            closeConsumeModal();
            loadMaterials();
        } else if (response.status === 409) {
            showNotification('{{ t("materials.insufficient_stock") }}', 'error');
        } else {
            const error = await response.json();
            showNotification(error.error || '{{ t("materials.error_consuming") }}', 'error');
        }
    } catch (error) {
        console.error('Error consuming material:', error);
        showNotification('{{ t("materials.error_consuming") }}', 'error');
    }
}
</script>
{% endif %}

{% endblock %}
