{% extends "base.html" %}

{% block title %}Competition Subscriptions - Admin - {{ super() }}{% endblock %}

{% block content %}
<section class="py-12 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Back Button -->
        <div class="mb-8">
            <a href="{{ url_for('main.admin') }}" 
               class="inline-flex items-center text-primary hover:text-primary-dark transition">
                <i class="fas fa-arrow-left mr-2"></i>Back to Admin Panel
            </a>
        </div>
        
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-900 dark:text-white">
            <i class="fas fa-clipboard-list text-primary mr-3"></i>Competition Subscriptions
        </h1>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
            <nav class="flex -mb-px">
                <button id="tab-subscriptions" 
                        onclick="switchTab('subscriptions')"
                        class="tab-button active px-6 py-3 text-sm font-medium border-b-2 border-primary text-primary">
                    <i class="fas fa-users mr-2"></i>Subscriptions
                </button>
                <button id="tab-interest" 
                        onclick="switchTab('interest')"
                        class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 hover:border-gray-300">
                    <i class="fas fa-star mr-2"></i>Interest Expressions
                </button>
            </nav>
        </div>

        <!-- Subscriptions Tab -->
        <div id="subscriptions-content" class="tab-content">
            <!-- Loading State -->
            <div id="subscriptions-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Loading subscriptions...</p>
            </div>

            <!-- Subscriptions List -->
            <div id="subscriptions-list" class="hidden space-y-6">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="subscriptions-empty" class="hidden text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                <p class="text-gray-600 dark:text-gray-400">No subscriptions found</p>
            </div>
        </div>

        <!-- Interest Tab -->
        <div id="interest-content" class="tab-content hidden">
            <!-- Loading State -->
            <div id="interest-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Loading interest expressions...</p>
            </div>

            <!-- Interest List -->
            <div id="interest-list" class="hidden space-y-6">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="interest-empty" class="hidden text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                <p class="text-gray-600 dark:text-gray-400">No interest expressions found</p>
            </div>
        </div>
    </div>
</section>

<script>
let currentTab = 'subscriptions';
let allSubscriptions = [];
let allInterests = [];
let allCompetitions = {};
let allInviti = {};
let allAthletes = {};

// Tab switching
function switchTab(tab) {
    currentTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-primary', 'text-primary');
        btn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    });
    document.getElementById(`tab-${tab}`).classList.add('active', 'border-primary', 'text-primary');
    document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`${tab}-content`).classList.remove('hidden');
}

// Load data on page load
document.addEventListener('DOMContentLoaded', async function() {
    await loadData();
});

async function loadData() {
    try {
        // Load all subscriptions using mass export
        const subsResp = await fetch('/archery/api/iscrizioni?export=full');
        if (subsResp.ok) {
            allSubscriptions = await subsResp.json();
            console.log('Loaded subscriptions:', allSubscriptions.length);
        }

        // Load all interest expressions using mass export
        const interestResp = await fetch('/archery/api/interesse?export=full');
        if (interestResp.ok) {
            allInterests = await interestResp.json();
            console.log('Loaded interests:', allInterests.length);
        }

        // Load competitions
        const gareResp = await fetch('/archery/api/gare?future=true&limit=500');
        if (gareResp.ok) {
            const competitions = await gareResp.json();
            competitions.forEach(comp => {
                allCompetitions[comp.codice] = comp;
            });
            console.log('Loaded competitions:', Object.keys(allCompetitions).length);
        }

        // Load inviti (subscription dates)
        const invitiResp = await fetch('/archery/api/inviti?export=full');
        if (invitiResp.ok) {
            const inviti = await invitiResp.json();
            inviti.forEach(invito => {
                allInviti[invito.codice] = invito;
            });
            console.log('Loaded inviti:', Object.keys(allInviti).length);
        }

        renderSubscriptions();
        renderInterest();
    } catch (error) {
        console.log('Error loading data:', error);
    }
}

function renderSubscriptions() {
    const loading = document.getElementById('subscriptions-loading');
    const list = document.getElementById('subscriptions-list');
    const empty = document.getElementById('subscriptions-empty');
    
    loading.classList.add('hidden');
    
    // All subscriptions are actual subscriptions (no turno=0 hack anymore)
    const subscriptions = allSubscriptions.filter(sub => sub.stato !== 'cancellato');
    
    if (subscriptions.length === 0) {
        empty.classList.remove('hidden');
        return;
    }
    
    // Group by competition
    const byCompetition = {};
    subscriptions.forEach(sub => {
        if (!byCompetition[sub.codice_gara]) {
            byCompetition[sub.codice_gara] = [];
        }
        byCompetition[sub.codice_gara].push(sub);
    });
    
    // Render each competition
    list.innerHTML = '';
    Object.keys(byCompetition).sort().forEach(codiceGara => {
        const subs = byCompetition[codiceGara];
        const competition = allCompetitions[codiceGara];
        
        // Sort subscriptions by turn
        subs.sort((a, b) => a.turno - b.turno);
        
        const competitionCard = document.createElement('div');
        competitionCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-6';
        
        const invito = allInviti[codiceGara];
        const subscriptionDatesHtml = invito ? `
            <div class="flex flex-wrap gap-4 mb-4 text-sm">
                <div class="flex items-center text-green-600 dark:text-green-400">
                    <i class="fas fa-door-open mr-2"></i>
                    <span><strong>Apertura:</strong> ${formatDate(invito.data_apertura_iscrizioni)}</span>
                </div>
                <div class="flex items-center text-red-600 dark:text-red-400">
                    <i class="fas fa-door-closed mr-2"></i>
                    <span><strong>Chiusura:</strong> ${formatDate(invito.data_chiusura_iscrizioni)}</span>
                </div>
            </div>
        ` : '';
        
        const competitionInfo = competition ? 
            `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                ${competition.nome}
                <span class="text-sm font-mono text-gray-500 dark:text-gray-400 ml-2">${codiceGara}</span>
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mb-2">
                <i class="fas fa-calendar mr-2"></i>${formatDate(competition.data_inizio)}
                <i class="fas fa-map-marker-alt ml-4 mr-2"></i>${competition.luogo || 'N/A'}
            </p>
            ${subscriptionDatesHtml}` :
            `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                Competition ${codiceGara}
            </h2>
            ${subscriptionDatesHtml}`;
        
        const subsHtml = subs.map(sub => {
            let statusColor = 'gray';
            let statusIcon = 'paper-plane';
            if (sub.stato === 'confermato') {
                statusColor = 'green';
                statusIcon = 'check-circle';
            } else if (sub.stato === 'in attesa') {
                statusColor = 'yellow';
                statusIcon = 'clock';
            }
            
            return `
                <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-3">Turno ${sub.turno}</td>
                    <td class="px-4 py-3">${sub.tessera_atleta}</td>
                    <td class="px-4 py-3">${sub.nome_atleta || 'N/A'}</td>
                    <td class="px-4 py-3">${sub.categoria || 'N/A'}</td>
                    <td class="px-4 py-3">${sub.classe || 'N/A'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full bg-${statusColor}-100 text-${statusColor}-800 dark:bg-${statusColor}-900/30 dark:text-${statusColor}-300">
                            <i class="fas fa-${statusIcon} mr-1"></i>${sub.stato}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${sub.note || '-'}</td>
                    <td class="px-4 py-3">
                        <select onchange="updateSubscriptionStatus(${sub.id}, this.value)" 
                                class="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="in attesa" ${sub.stato === 'in attesa' ? 'selected' : ''}>In attesa</option>
                            <option value="confermato" ${sub.stato === 'confermato' ? 'selected' : ''}>Confermato</option>
                            <option value="cancellato" ${sub.stato === 'cancellato' ? 'selected' : ''}>Cancellato</option>
                        </select>
                    </td>
                </tr>
            `;
        }).join('');
        
        competitionCard.innerHTML = `
            ${competitionInfo}
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-users mr-2"></i><strong>${subs.length}</strong> iscrizioni
                </p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                            <tr>
                                <th class="px-4 py-2">Turno</th>
                                <th class="px-4 py-2">Tessera</th>
                                <th class="px-4 py-2">Atleta</th>
                                <th class="px-4 py-2">Categoria</th>
                                <th class="px-4 py-2">Classe</th>
                                <th class="px-4 py-2">Stato</th>
                                <th class="px-4 py-2">Note</th>
                                <th class="px-4 py-2">Azioni</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-900 dark:text-gray-300">
                            ${subsHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        list.appendChild(competitionCard);
    });
    
    list.classList.remove('hidden');
}

function renderInterest() {
    const loading = document.getElementById('interest-loading');
    const list = document.getElementById('interest-list');
    const empty = document.getElementById('interest-empty');
    
    loading.classList.add('hidden');
    
    // Use the separate interests array (from ARC_interesse table)
    const interestExpressions = allInterests.filter(int => int.stato === 'attivo');
    
    if (interestExpressions.length === 0) {
        empty.classList.remove('hidden');
        return;
    }
    
    // Group by competition
    const byCompetition = {};
    interestExpressions.forEach(sub => {
        if (!byCompetition[sub.codice_gara]) {
            byCompetition[sub.codice_gara] = [];
        }
        byCompetition[sub.codice_gara].push(sub);
    });
    
    // Render each competition
    list.innerHTML = '';
    Object.keys(byCompetition).sort().forEach(codiceGara => {
        const interests = byCompetition[codiceGara];
        const competition = allCompetitions[codiceGara];
        
        const competitionCard = document.createElement('div');
        competitionCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-6';
        
        const invito = allInviti[codiceGara];
        const subscriptionDatesHtml = invito ? `
            <div class="flex flex-wrap gap-4 mb-4 text-sm">
                <div class="flex items-center text-green-600 dark:text-green-400">
                    <i class="fas fa-door-open mr-2"></i>
                    <span><strong>Apertura:</strong> ${formatDate(invito.data_apertura_iscrizioni)}</span>
                </div>
                <div class="flex items-center text-red-600 dark:text-red-400">
                    <i class="fas fa-door-closed mr-2"></i>
                    <span><strong>Chiusura:</strong> ${formatDate(invito.data_chiusura_iscrizioni)}</span>
                </div>
            </div>
        ` : '';
        
        const competitionInfo = competition ? 
            `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                ${competition.nome}
                <span class="text-sm font-mono text-gray-500 dark:text-gray-400 ml-2">${codiceGara}</span>
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mb-2">
                <i class="fas fa-calendar mr-2"></i>${formatDate(competition.data_inizio)}
                <i class="fas fa-map-marker-alt ml-4 mr-2"></i>${competition.luogo || 'N/A'}
            </p>
            ${subscriptionDatesHtml}` :
            `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                Competition ${codiceGara}
            </h2>
            ${subscriptionDatesHtml}`;
        
        const interestHtml = interests.map(sub => `
            <tr class="border-b border-gray-200 dark:border-gray-700">
                <td class="px-4 py-3">
                    <input type="checkbox" 
                           class="interest-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                           data-interest-id="${sub.id}"
                           data-competition-code="${codiceGara}">
                </td>
                <td class="px-4 py-3">${sub.tessera_atleta}</td>
                <td class="px-4 py-3">${sub.nome_atleta || 'N/A'}</td>
                <td class="px-4 py-3">${sub.categoria || 'N/A'}</td>
                <td class="px-4 py-3">${sub.classe || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${sub.note || '-'}</td>
            </tr>
        `).join('');
        
        competitionCard.innerHTML = `
            ${competitionInfo}
            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        <i class="fas fa-star mr-2 text-yellow-600"></i><strong>${interests.length}</strong> espressioni di interesse
                    </p>
                    <button onclick="convertSelectedInterests('${codiceGara}')"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 flex items-center gap-2">
                        <i class="fas fa-exchange-alt"></i>
                        Converti Selezionati
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-yellow-100 dark:bg-yellow-900/30 text-gray-700 dark:text-gray-300">
                            <tr>
                                <th class="px-4 py-2">
                                    <input type="checkbox" 
                                           class="select-all-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary"
                                           onchange="toggleAllInterests('${codiceGara}', this.checked)">
                                </th>
                                <th class="px-4 py-2">Tessera</th>
                                <th class="px-4 py-2">Atleta</th>
                                <th class="px-4 py-2">Categoria</th>
                                <th class="px-4 py-2">Classe</th>
                                <th class="px-4 py-2">Note</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-900 dark:text-gray-300">
                            ${interestHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        list.appendChild(competitionCard);
    });
    
    list.classList.remove('hidden');
}

function toggleAllInterests(codiceGara, checked) {
    document.querySelectorAll(`.interest-checkbox[data-competition-code="${codiceGara}"]`).forEach(checkbox => {
        checkbox.checked = checked;
    });
}

async function convertSelectedInterests(codiceGara) {
    const checkboxes = document.querySelectorAll(`.interest-checkbox[data-competition-code="${codiceGara}"]:checked`);
    
    if (checkboxes.length === 0) {
        alert('Seleziona almeno un\'espressione di interesse da convertire');
        return;
    }
    
    if (!confirm(`Confermi la conversione di ${checkboxes.length} espressioni di interesse in iscrizioni?`)) {
        return;
    }
    
    const invito = allInviti[codiceGara];
    let successCount = 0;
    let errorCount = 0;
    
    for (const checkbox of checkboxes) {
        const interestId = parseInt(checkbox.dataset.interestId);
        const interest = allInterests.find(i => i.id === interestId);
        
        if (!interest) {
            errorCount++;
            continue;
        }
        
        try {
            // Create subscription
            const subscriptionData = {
                codice_gara: interest.codice_gara,
                tessera_atleta: interest.tessera_atleta,
                categoria: interest.categoria,
                classe: interest.classe || '',
                turno: invito?.turno_default || 1,
                stato: 'confermato',
                note: interest.note || ''
            };
            
            const createResp = await fetch('/archery/api/iscrizioni', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(subscriptionData)
            });
            
            if (createResp.ok) {
                // Delete interest expression
                const deleteResp = await fetch(`/archery/api/interesse/${interestId}`, {
                    method: 'DELETE'
                });
                
                if (deleteResp.ok) {
                    successCount++;
                    // Remove from local array
                    const index = allInterests.findIndex(i => i.id === interestId);
                    if (index !== -1) {
                        allInterests.splice(index, 1);
                    }
                } else {
                    errorCount++;
                    console.error(`Failed to delete interest ${interestId}`);
                }
            } else {
                errorCount++;
                const error = await createResp.json();
                console.error(`Failed to create subscription for interest ${interestId}:`, error);
            }
        } catch (error) {
            errorCount++;
            console.error(`Error converting interest ${interestId}:`, error);
        }
    }
    
    // Show results
    if (successCount > 0) {
        alert(`✅ Convertiti con successo: ${successCount}\n${errorCount > 0 ? `⚠️ Errori: ${errorCount}` : ''}`);
        // Reload data
        await loadData();
    } else {
        alert(`❌ Nessuna conversione riuscita. Errori: ${errorCount}`);
    }
}

async function updateSubscriptionStatus(subscriptionId, newStatus) {
    try {
        // Find the subscription to get its details
        const sub = allSubscriptions.find(s => s.id === subscriptionId);
        if (!sub) {
            throw new Error('Subscription not found');
        }
        
        // Prepare update data with all required fields
        const updateData = {
            stato: newStatus,
            note: sub.note || '',
            turno: sub.turno,
            categoria: sub.categoria,
            classe: sub.classe || ''
        };
        
        const response = await fetch(`/archery/api/iscrizioni/${subscriptionId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            // Update local data
            sub.stato = newStatus;
            
            // Show notification
            showNotification('Stato aggiornato con successo', 'success');
            
            // Re-render
            renderSubscriptions();
            
            // If subscription is confirmed, check if there's a matching interest to clean up
            if (newStatus === 'confermato') {
                await cleanupMatchingInterest(sub);
            }
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update status');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
    }
}

async function cleanupMatchingInterest(subscription) {
    // Find matching interest expression
    const matchingInterest = allInterests.find(int => 
        int.codice_gara === subscription.codice_gara &&
        int.tessera_atleta === subscription.tessera_atleta &&
        int.stato === 'attivo'
    );
    
    if (matchingInterest) {
        try {
            const response = await fetch(`/archery/api/interesse/${matchingInterest.id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                console.log(`Cleaned up interest expression ${matchingInterest.id} for athlete ${subscription.tessera_atleta}`);
                // Remove from local array
                const index = allInterests.findIndex(i => i.id === matchingInterest.id);
                if (index !== -1) {
                    allInterests.splice(index, 1);
                }
                // Re-render interest tab if it's active
                if (currentTab === 'interest') {
                    renderInterest();
                }
            }
        } catch (error) {
            console.error('Error cleaning up interest expression:', error);
            // Don't show error to user - this is a background cleanup
        }
    }
}

function showNotification(message, type) {
    // Simple notification - you can enhance this
    alert(message);
}

function formatDate(dateStr) {
    if (!dateStr) return 'TBA';
    const [year, month, day] = dateStr.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    const monthShort = date.toLocaleDateString('it-IT', { month: 'short' });
    return `${day}-${monthShort.charAt(0).toUpperCase() + monthShort.slice(1)}-${year}`;
}
</script>

<style>
.tab-button.active {
    border-color: var(--color-primary);
    color: var(--color-primary);
}
</style>
{% endblock %}
