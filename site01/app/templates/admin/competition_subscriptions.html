{% extends "base.html" %}

{% block title %}Competition Subscriptions - Admin - {{ super() }}{% endblock %}

{% block content %}
<section class="py-12 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Back Button -->
        <div class="mb-8">
            <a href="{{ url_for('main.admin') }}" 
               class="inline-flex items-center text-primary hover:text-primary-dark transition">
                <i class="fas fa-arrow-left mr-2"></i>Back to Admin Panel
            </a>
        </div>
        
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-900 dark:text-white">
            <i class="fas fa-clipboard-list text-primary mr-3"></i>Competition Subscriptions
        </h1>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
            <nav class="flex -mb-px">
                <button id="tab-subscriptions" 
                        onclick="switchTab('subscriptions')"
                        class="tab-button active px-6 py-3 text-sm font-medium border-b-2 border-primary text-primary">
                    <i class="fas fa-users mr-2"></i>Subscriptions
                </button>
                <button id="tab-interest" 
                        onclick="switchTab('interest')"
                        class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 hover:border-gray-300">
                    <i class="fas fa-star mr-2"></i>Interest Expressions
                </button>
            </nav>
        </div>

        <!-- Subscriptions Tab -->
        <div id="subscriptions-content" class="tab-content">
            <!-- Loading State -->
            <div id="subscriptions-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Loading subscriptions...</p>
            </div>

            <!-- Subscriptions List -->
            <div id="subscriptions-list" class="hidden space-y-6">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="subscriptions-empty" class="hidden text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                <p class="text-gray-600 dark:text-gray-400">No subscriptions found</p>
            </div>
        </div>

        <!-- Interest Tab -->
        <div id="interest-content" class="tab-content hidden">
            <!-- Loading State -->
            <div id="interest-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Loading interest expressions...</p>
            </div>

            <!-- Interest List -->
            <div id="interest-list" class="hidden space-y-6">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="interest-empty" class="hidden text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                <p class="text-gray-600 dark:text-gray-400">No interest expressions found</p>
            </div>
        </div>
    </div>
    
    <!-- Edit Subscription Modal -->
    <div id="edit-subscription-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-edit mr-2"></i>Modifica Iscrizione
                    </h3>
                    <button onclick="closeEditSubscriptionModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="edit-subscription-form" class="space-y-4">
                    <input type="hidden" id="edit-sub-id">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tessera</label>
                            <input type="text" id="edit-sub-tessera" readonly
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno</label>
                            <input type="number" id="edit-sub-turno" required min="1"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                            <input type="text" id="edit-sub-categoria" required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Classe</label>
                            <input type="text" id="edit-sub-classe"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Note</label>
                        <textarea id="edit-sub-note" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stato</label>
                        <select id="edit-sub-stato" required
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="in attesa">In attesa</option>
                            <option value="confermato">Confermato</option>
                            <option value="lista d'attesa">Lista d'attesa</option>
                            <option value="attesa cancellazione">Attesa cancellazione</option>
                            <option value="modifica richiesta">Modifica richiesta</option>
                            <option value="cancellato">Cancellato</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeEditSubscriptionModal()"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg">
                            Annulla
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                            <i class="fas fa-save mr-2"></i>Salva Modifiche
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Interest Modal -->
    <div id="edit-interest-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-edit mr-2"></i>Modifica Espressione di Interesse
                    </h3>
                    <button onclick="closeEditInterestModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="edit-interest-form" class="space-y-4">
                    <input type="hidden" id="edit-int-id">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tessera</label>
                        <input type="text" id="edit-int-tessera" readonly
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                            <input type="text" id="edit-int-categoria" required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Classe</label>
                            <input type="text" id="edit-int-classe"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Note</label>
                        <textarea id="edit-int-note" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeEditInterestModal()"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg">
                            Annulla
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                            <i class="fas fa-save mr-2"></i>Salva Modifiche
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
let currentTab = 'subscriptions';
let allSubscriptions = [];
let allInterests = [];
let allCompetitions = {};
let allInviti = {};
let allAthletes = {};

// Tab switching
function switchTab(tab) {
    currentTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-primary', 'text-primary');
        btn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    });
    document.getElementById(`tab-${tab}`).classList.add('active', 'border-primary', 'text-primary');
    document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`${tab}-content`).classList.remove('hidden');
}

// Load data on page load
document.addEventListener('DOMContentLoaded', async function() {
    await loadData();
});

async function loadData() {
    try {
        // Load all subscriptions using mass export
        const subsResp = await fetch('/archery/api/iscrizioni?export=full');
        if (subsResp.ok) {
            allSubscriptions = await subsResp.json();
            console.log('Loaded subscriptions:', allSubscriptions.length);
        }

        // Load all interest expressions using mass export
        const interestResp = await fetch('/archery/api/interesse?export=full');
        if (interestResp.ok) {
            allInterests = await interestResp.json();
            console.log('Loaded interests:', allInterests.length);
        }

        // Load competitions
        const gareResp = await fetch('/archery/api/gare?future=true&limit=500');
        if (gareResp.ok) {
            const competitions = await gareResp.json();
            competitions.forEach(comp => {
                allCompetitions[comp.codice] = comp;
            });
            console.log('Loaded competitions:', Object.keys(allCompetitions).length);
        }

        // Load inviti (subscription dates)
        const invitiResp = await fetch('/archery/api/inviti?export=full');
        if (invitiResp.ok) {
            const inviti = await invitiResp.json();
            inviti.forEach(invito => {
                allInviti[invito.codice] = invito;
            });
            console.log('Loaded inviti:', Object.keys(allInviti).length);
        }

        renderSubscriptions();
        renderInterest();
    } catch (error) {
        console.log('Error loading data:', error);
    }
}

function renderSubscriptions() {
    const loading = document.getElementById('subscriptions-loading');
    const list = document.getElementById('subscriptions-list');
    const empty = document.getElementById('subscriptions-empty');
    
    loading.classList.add('hidden');
    
    // All subscriptions are actual subscriptions (no turno=0 hack anymore)
    const subscriptions = allSubscriptions.filter(sub => sub.stato !== 'cancellato');
    
    if (subscriptions.length === 0) {
        empty.classList.remove('hidden');
        return;
    }
    
    // Group by competition
    const byCompetition = {};
    subscriptions.forEach(sub => {
        if (!byCompetition[sub.codice_gara]) {
            byCompetition[sub.codice_gara] = [];
        }
        byCompetition[sub.codice_gara].push(sub);
    });
    
    // Render each competition
    list.innerHTML = '';
    Object.keys(byCompetition).sort().forEach(codiceGara => {
        const subs = byCompetition[codiceGara];
        const competition = allCompetitions[codiceGara];
        
        // Sort subscriptions by turn
        subs.sort((a, b) => a.turno - b.turno);
        
        const competitionCard = document.createElement('div');
        competitionCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-6';
        
        const invito = allInviti[codiceGara];
        const subscriptionDatesHtml = invito ? `
            <div class="flex flex-wrap gap-4 mb-4 text-sm">
                <div class="flex items-center text-green-600 dark:text-green-400">
                    <i class="fas fa-door-open mr-2"></i>
                    <span><strong>Apertura:</strong> ${formatDate(invito.data_apertura_iscrizioni)}</span>
                </div>
                <div class="flex items-center text-red-600 dark:text-red-400">
                    <i class="fas fa-door-closed mr-2"></i>
                    <span><strong>Chiusura:</strong> ${formatDate(invito.data_chiusura_iscrizioni)}</span>
                </div>
            </div>
        ` : '';
        
        const competitionInfo = competition ? 
            `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                ${competition.nome}
                <span class="text-sm font-mono text-gray-500 dark:text-gray-400 ml-2">${codiceGara}</span>
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mb-2">
                <i class="fas fa-calendar mr-2"></i>${formatDate(competition.data_inizio)}
                <i class="fas fa-map-marker-alt ml-4 mr-2"></i>${competition.luogo || 'N/A'}
            </p>
            ${subscriptionDatesHtml}` :
            `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                Competition ${codiceGara}
            </h2>
            ${subscriptionDatesHtml}`;
        
        const subsHtml = subs.map(sub => {
            let statusColor = 'gray';
            let statusIcon = 'paper-plane';
            if (sub.stato === 'confermato') {
                statusColor = 'green';
                statusIcon = 'check-circle';
            } else if (sub.stato === 'in attesa') {
                statusColor = 'yellow';
                statusIcon = 'clock';
            }
            
            return `
                <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-3">Turno ${sub.turno}</td>
                    <td class="px-4 py-3">${sub.tessera_atleta}</td>
                    <td class="px-4 py-3">${sub.nome_atleta || 'N/A'}</td>
                    <td class="px-4 py-3">${sub.categoria || 'N/A'}</td>
                    <td class="px-4 py-3">${sub.classe || 'N/A'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full bg-${statusColor}-100 text-${statusColor}-800 dark:bg-${statusColor}-900/30 dark:text-${statusColor}-300">
                            <i class="fas fa-${statusIcon} mr-1"></i>${sub.stato}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${sub.note || '-'}</td>
                    <td class="px-4 py-3">
                        <select onchange="updateSubscriptionStatus(${sub.id}, this.value)" 
                                class="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="in attesa" ${sub.stato === 'in attesa' ? 'selected' : ''}>In attesa</option>
                            <option value="confermato" ${sub.stato === 'confermato' ? 'selected' : ''}>Confermato</option>
                            <option value="lista d'attesa" ${sub.stato === "lista d'attesa" ? 'selected' : ''}>Lista d'attesa</option>
                            <option value="attesa cancellazione" ${sub.stato === 'attesa cancellazione' ? 'selected' : ''}>Attesa cancellazione</option>
                            <option value="modifica richiesta" ${sub.stato === 'modifica richiesta' ? 'selected' : ''}>Modifica richiesta</option>
                            <option value="cancellato" ${sub.stato === 'cancellato' ? 'selected' : ''}>Cancellato</option>
                        </select>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="editSubscription(${sub.id})" 
                                class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                                title="Modifica iscrizione">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        competitionCard.innerHTML = `
            ${competitionInfo}
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-users mr-2"></i><strong>${subs.length}</strong> iscrizioni
                </p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                            <tr>
                                <th class="px-4 py-2">Turno</th>
                                <th class="px-4 py-2">Tessera</th>
                                <th class="px-4 py-2">Atleta</th>
                                <th class="px-4 py-2">Categoria</th>
                                <th class="px-4 py-2">Classe</th>
                                <th class="px-4 py-2">Stato</th>
                                <th class="px-4 py-2">Note</th>
                                <th class="px-4 py-2">Azioni</th>
                                <th class="px-4 py-2 text-right">Modifica</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-900 dark:text-gray-300">
                            ${subsHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        list.appendChild(competitionCard);
    });
    
    list.classList.remove('hidden');
}

function renderInterest() {
    const loading = document.getElementById('interest-loading');
    const list = document.getElementById('interest-list');
    const empty = document.getElementById('interest-empty');
    
    loading.classList.add('hidden');
    
    // Use the separate interests array (from ARC_interesse table)
    const interestExpressions = allInterests.filter(int => int.stato === 'attivo');
    
    if (interestExpressions.length === 0) {
        empty.classList.remove('hidden');
        return;
    }
    
    // Group by competition
    const byCompetition = {};
    interestExpressions.forEach(sub => {
        if (!byCompetition[sub.codice_gara]) {
            byCompetition[sub.codice_gara] = [];
        }
        byCompetition[sub.codice_gara].push(sub);
    });
    
    // Render each competition
    list.innerHTML = '';
    Object.keys(byCompetition).sort().forEach(codiceGara => {
        const interests = byCompetition[codiceGara];
        const competition = allCompetitions[codiceGara];
        
        const competitionCard = document.createElement('div');
        competitionCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-6';
        
        const invito = allInviti[codiceGara];
        const subscriptionDatesHtml = invito ? `
            <div class="flex flex-wrap gap-4 mb-4 text-sm">
                <div class="flex items-center text-green-600 dark:text-green-400">
                    <i class="fas fa-door-open mr-2"></i>
                    <span><strong>Apertura:</strong> ${formatDate(invito.data_apertura_iscrizioni)}</span>
                </div>
                <div class="flex items-center text-red-600 dark:text-red-400">
                    <i class="fas fa-door-closed mr-2"></i>
                    <span><strong>Chiusura:</strong> ${formatDate(invito.data_chiusura_iscrizioni)}</span>
                </div>
            </div>
        ` : '';
        
        const competitionInfo = competition ? 
            `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                ${competition.nome}
                <span class="text-sm font-mono text-gray-500 dark:text-gray-400 ml-2">${codiceGara}</span>
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mb-2">
                <i class="fas fa-calendar mr-2"></i>${formatDate(competition.data_inizio)}
                <i class="fas fa-map-marker-alt ml-4 mr-2"></i>${competition.luogo || 'N/A'}
            </p>
            ${subscriptionDatesHtml}` :
            `<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                Competition ${codiceGara}
            </h2>
            ${subscriptionDatesHtml}`;
        
        const interestHtml = interests.map(sub => `
            <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="px-4 py-3">
                    <input type="checkbox" 
                           class="interest-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                           data-interest-id="${sub.id}"
                           data-competition-code="${codiceGara}">
                </td>
                <td class="px-4 py-3">${sub.tessera_atleta}</td>
                <td class="px-4 py-3">${sub.nome_atleta || 'N/A'}</td>
                <td class="px-4 py-3">${sub.categoria || 'N/A'}</td>
                <td class="px-4 py-3">${sub.classe || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${sub.note || '-'}</td>
                <td class="px-4 py-3 text-right space-x-2">
                    <button onclick="editInterest(${sub.id})" 
                            class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                            title="Modifica espressione di interesse">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteInterest(${sub.id})" 
                            class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition-colors"
                            title="Elimina espressione di interesse">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        competitionCard.innerHTML = `
            ${competitionInfo}
            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        <i class="fas fa-star mr-2 text-yellow-600"></i><strong>${interests.length}</strong> espressioni di interesse
                    </p>
                    <div class="flex gap-2">
                        <button onclick="deleteSelectedInterests('${codiceGara}')"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 flex items-center gap-2">
                            <i class="fas fa-trash-alt"></i>
                            Elimina Selezionati
                        </button>
                        <button onclick="convertSelectedInterests('${codiceGara}')"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 flex items-center gap-2">
                            <i class="fas fa-exchange-alt"></i>
                            Converti Selezionati
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-yellow-100 dark:bg-yellow-900/30 text-gray-700 dark:text-gray-300">
                            <tr>
                                <th class="px-4 py-2">
                                    <input type="checkbox" 
                                           class="select-all-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary"
                                           onchange="toggleAllInterests('${codiceGara}', this.checked)">
                                </th>
                                <th class="px-4 py-2">Tessera</th>
                                <th class="px-4 py-2">Atleta</th>
                                <th class="px-4 py-2">Categoria</th>
                                <th class="px-4 py-2">Classe</th>
                                <th class="px-4 py-2">Note</th>
                                <th class="px-4 py-2 text-right">Azioni</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-900 dark:text-gray-300">
                            ${interestHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        list.appendChild(competitionCard);
    });
    
    list.classList.remove('hidden');
}

function toggleAllInterests(codiceGara, checked) {
    document.querySelectorAll(`.interest-checkbox[data-competition-code="${codiceGara}"]`).forEach(checkbox => {
        checkbox.checked = checked;
    });
}

async function deleteInterest(interestId) {
    const interest = allInterests.find(i => i.id === interestId);
    
    if (!interest) {
        alert('Espressione di interesse non trovata');
        return;
    }
    
    const athleteName = interest.nome_atleta || interest.tessera_atleta;
    
    if (!confirm(`Confermi l'eliminazione dell'espressione di interesse di ${athleteName}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/archery/api/interesse/${interestId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Remove from local array
            const index = allInterests.findIndex(i => i.id === interestId);
            if (index !== -1) {
                allInterests.splice(index, 1);
            }
            
            // Re-render
            renderInterest();
            showNotification('Espressione di interesse eliminata con successo', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Errore durante l\'eliminazione');
        }
    } catch (error) {
        console.error('Error deleting interest:', error);
        showNotification('Errore durante l\'eliminazione: ' + error.message, 'error');
    }
}

async function convertSelectedInterests(codiceGara) {
    const checkboxes = document.querySelectorAll(`.interest-checkbox[data-competition-code="${codiceGara}"]:checked`);
    
    if (checkboxes.length === 0) {
        alert('Seleziona almeno un\'espressione di interesse da convertire');
        return;
    }
    
    if (!confirm(`Confermi la conversione di ${checkboxes.length} espressioni di interesse in iscrizioni?`)) {
        return;
    }
    
    const invito = allInviti[codiceGara];
    let successCount = 0;
    let errorCount = 0;
    
    for (const checkbox of checkboxes) {
        const interestId = parseInt(checkbox.dataset.interestId);
        const interest = allInterests.find(i => i.id === interestId);
        
        if (!interest) {
            errorCount++;
            continue;
        }
        
        try {
            // Create subscription
            const subscriptionData = {
                codice_gara: interest.codice_gara,
                tessera_atleta: interest.tessera_atleta,
                categoria: interest.categoria,
                classe: interest.classe || '',
                turno: invito?.turno_default || 1,
                stato: 'confermato',
                note: interest.note || ''
            };
            
            const createResp = await fetch('/archery/api/iscrizioni', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(subscriptionData)
            });
            
            if (createResp.ok) {
                // Delete interest expression
                const deleteResp = await fetch(`/archery/api/interesse/${interestId}`, {
                    method: 'DELETE'
                });
                
                if (deleteResp.ok) {
                    successCount++;
                    // Remove from local array
                    const index = allInterests.findIndex(i => i.id === interestId);
                    if (index !== -1) {
                        allInterests.splice(index, 1);
                    }
                } else {
                    errorCount++;
                    console.error(`Failed to delete interest ${interestId}`);
                }
            } else {
                errorCount++;
                const error = await createResp.json();
                console.error(`Failed to create subscription for interest ${interestId}:`, error);
            }
        } catch (error) {
            errorCount++;
            console.error(`Error converting interest ${interestId}:`, error);
        }
    }
    
    // Show results
    if (successCount > 0) {
        alert(`✅ Convertiti con successo: ${successCount}\n${errorCount > 0 ? `⚠️ Errori: ${errorCount}` : ''}`);
        // Reload data
        await loadData();
    } else {
        alert(`❌ Nessuna conversione riuscita. Errori: ${errorCount}`);
    }
}

async function updateSubscriptionStatus(subscriptionId, newStatus) {
    try {
        // Find the subscription to get its details
        const sub = allSubscriptions.find(s => s.id === subscriptionId);
        if (!sub) {
            throw new Error('Subscription not found');
        }
        
        // Prepare update data with all required fields
        const updateData = {
            stato: newStatus,
            note: sub.note || '',
            turno: sub.turno,
            categoria: sub.categoria,
            classe: sub.classe || ''
        };
        
        const response = await fetch(`/archery/api/iscrizioni/${subscriptionId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            // Update local data
            sub.stato = newStatus;
            
            // Show notification
            showNotification('Stato aggiornato con successo', 'success');
            
            // Re-render
            renderSubscriptions();
            
            // If subscription is confirmed, check if there's a matching interest to clean up
            if (newStatus === 'confermato') {
                await cleanupMatchingInterest(sub);
            }
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update status');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
    }
}

async function cleanupMatchingInterest(subscription) {
    // Find matching interest expression
    const matchingInterest = allInterests.find(int => 
        int.codice_gara === subscription.codice_gara &&
        int.tessera_atleta === subscription.tessera_atleta &&
        int.stato === 'attivo'
    );
    
    if (matchingInterest) {
        try {
            const response = await fetch(`/archery/api/interesse/${matchingInterest.id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                console.log(`Cleaned up interest expression ${matchingInterest.id} for athlete ${subscription.tessera_atleta}`);
                // Remove from local array
                const index = allInterests.findIndex(i => i.id === matchingInterest.id);
                if (index !== -1) {
                    allInterests.splice(index, 1);
                }
                // Re-render interest tab if it's active
                if (currentTab === 'interest') {
                    renderInterest();
                }
            }
        } catch (error) {
            console.error('Error cleaning up interest expression:', error);
            // Don't show error to user - this is a background cleanup
        }
    }
}

function showNotification(message, type) {
    // Simple notification - you can enhance this
    alert(message);
}

function formatDate(dateStr) {
    if (!dateStr) return 'TBA';
    const [year, month, day] = dateStr.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    const monthShort = date.toLocaleDateString('it-IT', { month: 'short' });
    return `${day}-${monthShort.charAt(0).toUpperCase() + monthShort.slice(1)}-${year}`;
}

// Edit Subscription
function editSubscription(subscriptionId) {
    const sub = allSubscriptions.find(s => s.id === subscriptionId);
    if (!sub) return;
    
    document.getElementById('edit-sub-id').value = sub.id;
    document.getElementById('edit-sub-tessera').value = sub.tessera_atleta;
    document.getElementById('edit-sub-turno').value = sub.turno;
    document.getElementById('edit-sub-categoria').value = sub.categoria || '';
    document.getElementById('edit-sub-classe').value = sub.classe || '';
    document.getElementById('edit-sub-note').value = sub.note || '';
    document.getElementById('edit-sub-stato').value = sub.stato;
    
    document.getElementById('edit-subscription-modal').classList.remove('hidden');
    document.getElementById('edit-subscription-modal').classList.add('flex');
}

function closeEditSubscriptionModal() {
    document.getElementById('edit-subscription-modal').classList.add('hidden');
    document.getElementById('edit-subscription-modal').classList.remove('flex');
    document.getElementById('edit-subscription-form').reset();
}

document.getElementById('edit-subscription-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const subId = parseInt(document.getElementById('edit-sub-id').value);
    const sub = allSubscriptions.find(s => s.id === subId);
    if (!sub) return;
    
    const newData = {
        turno: parseInt(document.getElementById('edit-sub-turno').value),
        categoria: document.getElementById('edit-sub-categoria').value,
        classe: document.getElementById('edit-sub-classe').value || '',
        stato: document.getElementById('edit-sub-stato').value
    };
    
    // Build change description (don't include status and note changes)
    const changes = buildChangeDescription({
        turno: sub.turno,
        categoria: sub.categoria,
        classe: sub.classe
    }, newData);
    
    // Get new notes (admin can edit freely, changes are tracked separately if needed)
    let newNotes = document.getElementById('edit-sub-note').value || '';
    
    // Add note field to update data
    newData.note = newNotes;
    
    try {
        const response = await fetch(`/archery/api/iscrizioni/${subId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newData)
        });
        
        if (response.ok) {
            // Update local data
            Object.assign(sub, newData);
            
            showNotification('Iscrizione aggiornata con successo', 'success');
            closeEditSubscriptionModal();
            renderSubscriptions();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update subscription');
        }
    } catch (error) {
        console.error('Error updating subscription:', error);
        showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
    }
});

// Edit Interest
function editInterest(interestId) {
    const interest = allInterests.find(i => i.id === interestId);
    if (!interest) return;
    
    document.getElementById('edit-int-id').value = interest.id;
    document.getElementById('edit-int-tessera').value = interest.tessera_atleta;
    document.getElementById('edit-int-categoria').value = interest.categoria || '';
    document.getElementById('edit-int-classe').value = interest.classe || '';
    document.getElementById('edit-int-note').value = interest.note || '';
    
    document.getElementById('edit-interest-modal').classList.remove('hidden');
    document.getElementById('edit-interest-modal').classList.add('flex');
}

function closeEditInterestModal() {
    document.getElementById('edit-interest-modal').classList.add('hidden');
    document.getElementById('edit-interest-modal').classList.remove('flex');
    document.getElementById('edit-interest-form').reset();
}

document.getElementById('edit-interest-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const intId = parseInt(document.getElementById('edit-int-id').value);
    const updateData = {
        categoria: document.getElementById('edit-int-categoria').value,
        classe: document.getElementById('edit-int-classe').value || '',
        note: document.getElementById('edit-int-note').value || ''
    };
    
    try {
        const response = await fetch(`/archery/api/interesse/${intId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            // Update local data
            const interest = allInterests.find(i => i.id === intId);
            if (interest) {
                Object.assign(interest, updateData);
            }
            
            showNotification('Espressione di interesse aggiornata con successo', 'success');
            closeEditInterestModal();
            renderInterest();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update interest');
        }
    } catch (error) {
        console.error('Error updating interest:', error);
        showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
    }
});

// Bulk Delete Interests
async function deleteSelectedInterests(codiceGara) {
    const checkboxes = document.querySelectorAll(`.interest-checkbox[data-competition-code="${codiceGara}"]:checked`);
    
    if (checkboxes.length === 0) {
        showNotification('Seleziona almeno un\'espressione di interesse da eliminare', 'error');
        return;
    }
    
    if (!confirm(`Sei sicuro di voler eliminare ${checkboxes.length} espressioni di interesse?`)) {
        return;
    }
    
    const interestIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.interestId));
    let successCount = 0;
    let errorCount = 0;
    
    for (const id of interestIds) {
        try {
            const response = await fetch(`/archery/api/interesse/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                successCount++;
                // Remove from local array
                const index = allInterests.findIndex(i => i.id === id);
                if (index !== -1) {
                    allInterests.splice(index, 1);
                }
            } else {
                errorCount++;
            }
        } catch (error) {
            console.error(`Error deleting interest ${id}:`, error);
            errorCount++;
        }
    }
    
    if (successCount > 0) {
        showNotification(`${successCount} espressioni di interesse eliminate con successo`, 'success');
        renderInterest();
    }
    
    if (errorCount > 0) {
        showNotification(`${errorCount} espressioni non sono state eliminate`, 'error');
    }
}

// Category validation rules
// G -> R, R -> A, A -> J, J -> S, M -> S
// Gender must remain the same (M stays M, F stays F)
function getValidCategoryChanges(currentCategory) {
    if (!currentCategory || currentCategory.length !== 2) return [];
    
    const ageCode = currentCategory[0];  // G, R, A, J, S, M
    const gender = currentCategory[1];   // M or F
    
    const validAges = [];
    
    switch(ageCode) {
        case 'G':
            validAges.push('G', 'R');  // G can change to R
            break;
        case 'R':
            validAges.push('R', 'A');  // R can change to A
            break;
        case 'A':
            validAges.push('A', 'J');  // A can change to J
            break;
        case 'J':
            validAges.push('J', 'S');  // J can change to S
            break;
        case 'S':
            validAges.push('S');       // S cannot change
            break;
        case 'M':
            validAges.push('M', 'S');  // M can change to S
            break;
        default:
            validAges.push(ageCode);   // Unknown, allow only same
    }
    
    // Generate valid categories with same gender
    return validAges.map(age => age + gender);
}

// Build change description
function buildChangeDescription(originalData, newData) {
    const changes = [];
    
    if (originalData.turno !== newData.turno) {
        changes.push(`TURNO cambia da ${originalData.turno} a ${newData.turno}`);
    }
    
    if (originalData.categoria !== newData.categoria) {
        changes.push(`CATEGORIA cambia da ${originalData.categoria} a ${newData.categoria}`);
    }
    
    if (originalData.classe !== newData.classe) {
        changes.push(`CLASSE cambia da "${originalData.classe || 'nessuna'}" a "${newData.classe || 'nessuna'}"`);
    }
    
    return changes;
}

// Apply changes to notes
function applyChangesToNotes(originalNotes, changes) {
    if (changes.length === 0) return originalNotes;
    
    const changeText = 'CAMBI RICHIESTI: ' + changes.join('; ');
    
    // If notes already contain "CAMBI RICHIESTI:", replace it
    if (originalNotes && originalNotes.includes('CAMBI RICHIESTI:')) {
        const beforeChanges = originalNotes.substring(0, originalNotes.indexOf('CAMBI RICHIESTI:'));
        return beforeChanges.trim() + (beforeChanges.trim() ? '\n\n' : '') + changeText;
    }
    
    // Otherwise append to existing notes
    return (originalNotes || '').trim() + (originalNotes ? '\n\n' : '') + changeText;
}


</script>

<style>
.tab-button.active {
    border-color: var(--color-primary);
    color: var(--color-primary);
}
</style>
{% endblock %}
