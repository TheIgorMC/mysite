{% extends "base.html" %}

{% block title %}Competition Subscriptions - Admin - {{ super() }}{% endblock %}

{% block content %}
<section class="py-12 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Back Button -->
        <div class="mb-8">
            <a href="{{ url_for('main.admin') }}" 
               class="inline-flex items-center text-primary hover:text-primary-dark transition">
                <i class="fas fa-arrow-left mr-2"></i>Back to Admin Panel
            </a>
        </div>
        
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-900 dark:text-white">
            <i class="fas fa-clipboard-list text-primary mr-3"></i>Competition Subscriptions
        </h1>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
            <nav class="flex -mb-px">
                <button id="tab-subscriptions" 
                        onclick="switchTab('subscriptions')"
                        class="tab-button active px-6 py-3 text-sm font-medium border-b-2 border-primary text-primary">
                    <i class="fas fa-users mr-2"></i>Subscriptions
                </button>
                <button id="tab-interest" 
                        onclick="switchTab('interest')"
                        class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 hover:border-gray-300">
                    <i class="fas fa-star mr-2"></i>Interest Expressions
                </button>
            </nav>
        </div>

        <!-- Subscriptions Tab -->
        <div id="subscriptions-content" class="tab-content">
            <!-- Loading State -->
            <div id="subscriptions-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Loading subscriptions...</p>
            </div>

            <!-- Subscriptions List -->
            <div id="subscriptions-list" class="hidden space-y-6">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="subscriptions-empty" class="hidden text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                <p class="text-gray-600 dark:text-gray-400">No subscriptions found</p>
            </div>
        </div>

        <!-- Interest Tab -->
        <div id="interest-content" class="tab-content hidden">
            <!-- Loading State -->
            <div id="interest-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-600 dark:text-gray-400">Loading interest expressions...</p>
            </div>

            <!-- Interest List -->
            <div id="interest-list" class="hidden space-y-6">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="interest-empty" class="hidden text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                <p class="text-gray-600 dark:text-gray-400">No interest expressions found</p>
            </div>
        </div>
    </div>
    
    <!-- Edit Subscription Modal -->
    <div id="edit-subscription-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-edit mr-2"></i>Modifica Iscrizione
                    </h3>
                    <button onclick="closeEditSubscriptionModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="edit-subscription-form" class="space-y-4">
                    <input type="hidden" id="edit-sub-id">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tessera</label>
                            <input type="text" id="edit-sub-tessera" readonly
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno</label>
                            <input type="number" id="edit-sub-turno" required min="1"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                            <input type="text" id="edit-sub-categoria" required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Classe</label>
                            <input type="text" id="edit-sub-classe"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Note</label>
                        <textarea id="edit-sub-note" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stato</label>
                        <select id="edit-sub-stato" required
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="in attesa">In attesa</option>
                            <option value="confermato">Confermato</option>
                            <option value="lista d'attesa">Lista d'attesa</option>
                            <option value="attesa cancellazione">Attesa cancellazione</option>
                            <option value="modifica richiesta">Modifica richiesta</option>
                            <option value="cancellato">Cancellato</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeEditSubscriptionModal()"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg">
                            Annulla
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                            <i class="fas fa-save mr-2"></i>Salva Modifiche
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Interest Modal -->
    <div id="edit-interest-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-edit mr-2"></i>Modifica Espressione di Interesse
                    </h3>
                    <button onclick="closeEditInterestModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="edit-interest-form" class="space-y-4">
                    <input type="hidden" id="edit-int-id">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tessera</label>
                        <input type="text" id="edit-int-tessera" readonly
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                            <input type="text" id="edit-int-categoria" required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Classe</label>
                            <input type="text" id="edit-int-classe"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Note</label>
                        <textarea id="edit-int-note" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeEditInterestModal()"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg">
                            Annulla
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                            <i class="fas fa-save mr-2"></i>Salva Modifiche
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Add Subscription Modal -->
    <div id="add-subscription-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-plus mr-2"></i>Aggiungi Iscrizione
                    </h3>
                    <button onclick="closeAddSubscriptionModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="add-subscription-form" class="space-y-4">
                    <input type="hidden" id="add-sub-codice-gara">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tessera Atleta</label>
                        <input type="text" id="add-sub-tessera" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               placeholder="Inserisci numero tessera">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno</label>
                            <input type="number" id="add-sub-turno" required min="1"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                   value="1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stato</label>
                            <select id="add-sub-stato" required
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="in attesa">In attesa</option>
                                <option value="confermato" selected>Confermato</option>
                                <option value="lista d'attesa">Lista d'attesa</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                            <input type="text" id="add-sub-categoria" required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                   placeholder="es. SM, SF, RM, etc.">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Classe</label>
                            <select id="add-sub-classe" required
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="CO">CO - Compound</option>
                                <option value="OL">OL - Olympic Recurve</option>
                                <option value="AN">AN - Barebow</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Note (opzionale)</label>
                        <textarea id="add-sub-note" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                  placeholder="Note aggiuntive..."></textarea>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3">
                        <p class="text-sm text-blue-800 dark:text-blue-300">
                            <i class="fas fa-info-circle mr-2"></i>Questa iscrizione sarà aggiunta anche se le iscrizioni sono chiuse.
                        </p>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeAddSubscriptionModal()"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded-lg">
                            Annulla
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                            <i class="fas fa-plus mr-2"></i>Aggiungi Iscrizione
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Competition Invite Modal -->
    <div id="invite-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeInviteModal()"></div>
            
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                                <i class="fas fa-file-alt text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-white" id="invite-modal-title">
                                    Invito Gara
                                </h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400" id="invite-modal-subtitle"></p>
                            </div>
                        </div>
                        <button onclick="closeInviteModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div id="invite-loading" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-3xl text-blue-600 dark:text-blue-400 mb-2"></i>
                        <p class="text-gray-600 dark:text-gray-400">Caricamento invito...</p>
                    </div>

                    <div id="invite-error" class="hidden text-center py-8">
                        <i class="fas fa-exclamation-circle text-3xl text-red-600 dark:text-red-400 mb-2"></i>
                        <p class="text-gray-600 dark:text-gray-400" id="invite-error-message"></p>
                    </div>

                    <div id="invite-content" class="hidden">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-600 rounded-lg p-4 mb-6 border border-blue-200 dark:border-gray-600">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <div class="text-xs font-semibold text-blue-700 dark:text-blue-300 uppercase mb-1">Date Gara</div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white" id="invite-dates"></div>
                                </div>
                                <div>
                                    <div class="text-xs font-semibold text-blue-700 dark:text-blue-300 uppercase mb-1">Iscrizioni</div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white" id="invite-registration-dates"></div>
                                </div>
                                <div>
                                    <div class="text-xs font-semibold text-blue-700 dark:text-blue-300 uppercase mb-1">Turni Disponibili</div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white" id="invite-turns"></div>
                                </div>
                            </div>
                            <div id="invite-youth-only" class="hidden mt-3 pt-3 border-t border-blue-300 dark:border-gray-500">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">
                                    <i class="fas fa-child mr-1"></i> Solo Giovanile
                                </span>
                            </div>
                        </div>

                        <div class="prose prose-sm dark:prose-invert max-w-none bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 p-6 max-h-96 overflow-y-auto" id="invite-html-content" style="white-space: pre-wrap;">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="closeInviteModal()"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-check mr-2"></i> Chiudi
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
let currentTab = 'subscriptions';
let allSubscriptions = [];
let allInterests = [];
let allCompetitions = {};
let allInviti = {};
let allAthletes = {};

// Tab switching
function switchTab(tab) {
    currentTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-primary', 'text-primary');
        btn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    });
    document.getElementById(`tab-${tab}`).classList.add('active', 'border-primary', 'text-primary');
    document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`${tab}-content`).classList.remove('hidden');
}

// Load data on page load
document.addEventListener('DOMContentLoaded', async function() {
    await loadData();
});

async function loadData() {
    try {
        // Load all subscriptions using mass export
        const subsResp = await fetch('/archery/api/iscrizioni?export=full');
        if (subsResp.ok) {
            allSubscriptions = await subsResp.json();
            console.log('Loaded subscriptions:', allSubscriptions.length);
        }

        // Load all interest expressions using mass export
        const interestResp = await fetch('/archery/api/interesse?export=full');
        if (interestResp.ok) {
            allInterests = await interestResp.json();
            console.log('Loaded interests:', allInterests.length);
        }

        // Load competitions
        const gareResp = await fetch('/archery/api/gare?future=true&limit=500');
        if (gareResp.ok) {
            const competitions = await gareResp.json();
            competitions.forEach(comp => {
                allCompetitions[comp.codice] = comp;
            });
            console.log('Loaded competitions:', Object.keys(allCompetitions).length);
        }

        // Load inviti (subscription dates)
        const invitiResp = await fetch('/archery/api/inviti?export=full');
        if (invitiResp.ok) {
            const inviti = await invitiResp.json();
            inviti.forEach(invito => {
                allInviti[invito.codice] = invito;
            });
            console.log('Loaded inviti:', Object.keys(allInviti).length);
        }

        renderSubscriptions();
        renderInterest();
    } catch (error) {
        console.log('Error loading data:', error);
    }
}

function renderSubscriptions() {
    const loading = document.getElementById('subscriptions-loading');
    const list = document.getElementById('subscriptions-list');
    const empty = document.getElementById('subscriptions-empty');
    
    loading.classList.add('hidden');
    
    // All subscriptions are actual subscriptions (no turno=0 hack anymore)
    const subscriptions = allSubscriptions.filter(sub => sub.stato !== 'cancellato');
    
    if (subscriptions.length === 0) {
        empty.classList.remove('hidden');
        return;
    }
    
    // Group by competition
    const byCompetition = {};
    subscriptions.forEach(sub => {
        if (!byCompetition[sub.codice_gara]) {
            byCompetition[sub.codice_gara] = [];
        }
        byCompetition[sub.codice_gara].push(sub);
    });
    
    // Render each competition
    list.innerHTML = '';
    Object.keys(byCompetition).sort().forEach(codiceGara => {
        const subs = byCompetition[codiceGara];
        const competition = allCompetitions[codiceGara];
        
        // Sort subscriptions by turn
        subs.sort((a, b) => a.turno - b.turno);
        
        const competitionCard = document.createElement('div');
        competitionCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-6';
        
        const invito = allInviti[codiceGara];
        const subscriptionDatesHtml = invito ? `
            <div class="flex flex-wrap gap-4 mb-4 text-sm">
                <div class="flex items-center text-green-600 dark:text-green-400">
                    <i class="fas fa-door-open mr-2"></i>
                    <span><strong>Apertura:</strong> ${formatDate(invito.data_apertura_iscrizioni)}</span>
                </div>
                <div class="flex items-center text-red-600 dark:text-red-400">
                    <i class="fas fa-door-closed mr-2"></i>
                    <span><strong>Chiusura:</strong> ${formatDate(invito.data_chiusura_iscrizioni)}</span>
                </div>
            </div>
        ` : '';
        
        const competitionInfo = competition ? 
            `<div class="flex items-start justify-between mb-2">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                        ${competition.nome}
                        <span class="text-sm font-mono text-gray-500 dark:text-gray-400 ml-2">${codiceGara}</span>
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-2">
                        <i class="fas fa-calendar mr-2"></i>${formatDate(competition.data_inizio)}
                        <i class="fas fa-map-marker-alt ml-4 mr-2"></i>${competition.luogo || 'N/A'}
                    </p>
                </div>
                <button onclick="showCompetitionInfo('${codiceGara}')" 
                        class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 px-3 py-1.5 rounded transition-colors"
                        title="Visualizza invito">
                    <i class="fas fa-info-circle text-lg"></i>
                </button>
            </div>
            ${subscriptionDatesHtml}` :
            `<div class="flex items-start justify-between mb-2">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    Competition ${codiceGara}
                </h2>
                <button onclick="showCompetitionInfo('${codiceGara}')" 
                        class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 px-3 py-1.5 rounded transition-colors"
                        title="Visualizza invito">
                    <i class="fas fa-info-circle text-lg"></i>
                </button>
            </div>
            ${subscriptionDatesHtml}`;
        
        const subsHtml = subs.map(sub => {
            let statusColor = 'gray';
            let statusIcon = 'paper-plane';
            if (sub.stato === 'confermato') {
                statusColor = 'green';
                statusIcon = 'check-circle';
            } else if (sub.stato === 'in attesa') {
                statusColor = 'yellow';
                statusIcon = 'clock';
            }
            
            return `
                <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-3">Turno ${sub.turno}</td>
                    <td class="px-4 py-3">${sub.tessera_atleta}</td>
                    <td class="px-4 py-3">${sub.nome_atleta || 'N/A'}</td>
                    <td class="px-4 py-3">${sub.categoria || 'N/A'}</td>
                    <td class="px-4 py-3">${sub.classe || 'N/A'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full bg-${statusColor}-100 text-${statusColor}-800 dark:bg-${statusColor}-900/30 dark:text-${statusColor}-300">
                            <i class="fas fa-${statusIcon} mr-1"></i>${sub.stato}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${sub.note || '-'}</td>
                    <td class="px-4 py-3">
                        <select onchange="updateSubscriptionStatus(${sub.id}, this.value)" 
                                class="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="in attesa" ${sub.stato === 'in attesa' ? 'selected' : ''}>In attesa</option>
                            <option value="confermato" ${sub.stato === 'confermato' ? 'selected' : ''}>Confermato</option>
                            <option value="lista d'attesa" ${sub.stato === "lista d'attesa" ? 'selected' : ''}>Lista d'attesa</option>
                            <option value="attesa cancellazione" ${sub.stato === 'attesa cancellazione' ? 'selected' : ''}>Attesa cancellazione</option>
                            <option value="modifica richiesta" ${sub.stato === 'modifica richiesta' ? 'selected' : ''}>Modifica richiesta</option>
                            <option value="cancellato" ${sub.stato === 'cancellato' ? 'selected' : ''}>Cancellato</option>
                        </select>
                    </td>
                    <td class="px-4 py-3 text-right space-x-2">
                        <button onclick="editSubscription(${sub.id})" 
                                class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                                title="Modifica iscrizione">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSubscription(${sub.id})" 
                                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition-colors"
                                title="Elimina iscrizione">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        competitionCard.innerHTML = `
            ${competitionInfo}
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        <i class="fas fa-users mr-2"></i><strong>${subs.length}</strong> iscrizioni
                    </p>
                    <button onclick="showAddSubscriptionModal('${codiceGara}')" 
                            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Aggiungi Iscrizione
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                            <tr>
                                <th class="px-4 py-2">Turno</th>
                                <th class="px-4 py-2">Tessera</th>
                                <th class="px-4 py-2">Atleta</th>
                                <th class="px-4 py-2">Categoria</th>
                                <th class="px-4 py-2">Classe</th>
                                <th class="px-4 py-2">Stato</th>
                                <th class="px-4 py-2">Note</th>
                                <th class="px-4 py-2">Azioni</th>
                                <th class="px-4 py-2 text-right">Modifica</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-900 dark:text-gray-300">
                            ${subsHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        list.appendChild(competitionCard);
    });
    
    list.classList.remove('hidden');
}

function renderInterest() {
    const loading = document.getElementById('interest-loading');
    const list = document.getElementById('interest-list');
    const empty = document.getElementById('interest-empty');
    
    loading.classList.add('hidden');
    
    // Use the separate interests array (from ARC_interesse table)
    const interestExpressions = allInterests.filter(int => int.stato === 'attivo');
    
    if (interestExpressions.length === 0) {
        empty.classList.remove('hidden');
        return;
    }
    
    // Group by competition
    const byCompetition = {};
    interestExpressions.forEach(sub => {
        if (!byCompetition[sub.codice_gara]) {
            byCompetition[sub.codice_gara] = [];
        }
        byCompetition[sub.codice_gara].push(sub);
    });
    
    // Render each competition
    list.innerHTML = '';
    Object.keys(byCompetition).sort().forEach(codiceGara => {
        const interests = byCompetition[codiceGara];
        const competition = allCompetitions[codiceGara];
        
        const competitionCard = document.createElement('div');
        competitionCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-6';
        
        const invito = allInviti[codiceGara];
        const subscriptionDatesHtml = invito ? `
            <div class="flex flex-wrap gap-4 mb-4 text-sm">
                <div class="flex items-center text-green-600 dark:text-green-400">
                    <i class="fas fa-door-open mr-2"></i>
                    <span><strong>Apertura:</strong> ${formatDate(invito.data_apertura_iscrizioni)}</span>
                </div>
                <div class="flex items-center text-red-600 dark:text-red-400">
                    <i class="fas fa-door-closed mr-2"></i>
                    <span><strong>Chiusura:</strong> ${formatDate(invito.data_chiusura_iscrizioni)}</span>
                </div>
            </div>
        ` : '';
        
        const competitionInfo = competition ? 
            `<div class="flex items-start justify-between mb-2">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                        ${competition.nome}
                        <span class="text-sm font-mono text-gray-500 dark:text-gray-400 ml-2">${codiceGara}</span>
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-2">
                        <i class="fas fa-calendar mr-2"></i>${formatDate(competition.data_inizio)}
                        <i class="fas fa-map-marker-alt ml-4 mr-2"></i>${competition.luogo || 'N/A'}
                    </p>
                </div>
                <button onclick="showCompetitionInfo('${codiceGara}')" 
                        class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 px-3 py-1.5 rounded transition-colors"
                        title="Visualizza invito">
                    <i class="fas fa-info-circle text-lg"></i>
                </button>
            </div>
            ${subscriptionDatesHtml}` :
            `<div class="flex items-start justify-between mb-2">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    Competition ${codiceGara}
                </h2>
                <button onclick="showCompetitionInfo('${codiceGara}')" 
                        class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 px-3 py-1.5 rounded transition-colors"
                        title="Visualizza invito">
                    <i class="fas fa-info-circle text-lg"></i>
                </button>
            </div>
            ${subscriptionDatesHtml}`;
        
        const interestHtml = interests.map(sub => `
            <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="px-4 py-3">
                    <input type="checkbox" 
                           class="interest-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                           data-interest-id="${sub.id}"
                           data-competition-code="${codiceGara}">
                </td>
                <td class="px-4 py-3">${sub.tessera_atleta}</td>
                <td class="px-4 py-3">${sub.nome_atleta || 'N/A'}</td>
                <td class="px-4 py-3">${sub.categoria || 'N/A'}</td>
                <td class="px-4 py-3">${sub.classe || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${sub.note || '-'}</td>
                <td class="px-4 py-3 text-right space-x-2">
                    <button onclick="editInterest(${sub.id})" 
                            class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                            title="Modifica espressione di interesse">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteInterest(${sub.id})" 
                            class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition-colors"
                            title="Elimina espressione di interesse">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        competitionCard.innerHTML = `
            ${competitionInfo}
            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        <i class="fas fa-star mr-2 text-yellow-600"></i><strong>${interests.length}</strong> espressioni di interesse
                    </p>
                    <div class="flex gap-2">
                        <button onclick="deleteSelectedInterests('${codiceGara}')"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 flex items-center gap-2">
                            <i class="fas fa-trash-alt"></i>
                            Elimina Selezionati
                        </button>
                        <button onclick="convertSelectedInterests('${codiceGara}')"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200 flex items-center gap-2">
                            <i class="fas fa-exchange-alt"></i>
                            Converti Selezionati
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-yellow-100 dark:bg-yellow-900/30 text-gray-700 dark:text-gray-300">
                            <tr>
                                <th class="px-4 py-2">
                                    <input type="checkbox" 
                                           class="select-all-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary"
                                           onchange="toggleAllInterests('${codiceGara}', this.checked)">
                                </th>
                                <th class="px-4 py-2">Tessera</th>
                                <th class="px-4 py-2">Atleta</th>
                                <th class="px-4 py-2">Categoria</th>
                                <th class="px-4 py-2">Classe</th>
                                <th class="px-4 py-2">Note</th>
                                <th class="px-4 py-2 text-right">Azioni</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-900 dark:text-gray-300">
                            ${interestHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        list.appendChild(competitionCard);
    });
    
    list.classList.remove('hidden');
}

function toggleAllInterests(codiceGara, checked) {
    document.querySelectorAll(`.interest-checkbox[data-competition-code="${codiceGara}"]`).forEach(checkbox => {
        checkbox.checked = checked;
    });
}

async function deleteSubscription(subscriptionId) {
    const subscription = allSubscriptions.find(s => s.id === subscriptionId);
    
    if (!subscription) {
        alert('Iscrizione non trovata');
        return;
    }
    
    const athleteName = subscription.nome_atleta || subscription.tessera_atleta;
    
    if (!confirm(`Confermi l'eliminazione definitiva dell'iscrizione di ${athleteName}?\n\nQuesta operazione non può essere annullata.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/archery/api/iscrizioni/${subscriptionId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Remove from local array
            const index = allSubscriptions.findIndex(s => s.id === subscriptionId);
            if (index !== -1) {
                allSubscriptions.splice(index, 1);
            }
            
            // Re-render
            renderSubscriptions();
            showNotification('Iscrizione eliminata con successo', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Errore durante l\'eliminazione');
        }
    } catch (error) {
        console.error('Error deleting subscription:', error);
        showNotification('Errore durante l\'eliminazione: ' + error.message, 'error');
    }
}

async function deleteInterest(interestId) {
    const interest = allInterests.find(i => i.id === interestId);
    
    if (!interest) {
        alert('Espressione di interesse non trovata');
        return;
    }
    
    const athleteName = interest.nome_atleta || interest.tessera_atleta;
    
    if (!confirm(`Confermi l'eliminazione dell'espressione di interesse di ${athleteName}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/archery/api/interesse/${interestId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Remove from local array
            const index = allInterests.findIndex(i => i.id === interestId);
            if (index !== -1) {
                allInterests.splice(index, 1);
            }
            
            // Re-render
            renderInterest();
            showNotification('Espressione di interesse eliminata con successo', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Errore durante l\'eliminazione');
        }
    } catch (error) {
        console.error('Error deleting interest:', error);
        showNotification('Errore durante l\'eliminazione: ' + error.message, 'error');
    }
}

async function convertSelectedInterests(codiceGara) {
    const checkboxes = document.querySelectorAll(`.interest-checkbox[data-competition-code="${codiceGara}"]:checked`);
    
    if (checkboxes.length === 0) {
        alert('Seleziona almeno un\'espressione di interesse da convertire');
        return;
    }
    
    if (!confirm(`Confermi la conversione di ${checkboxes.length} espressioni di interesse in iscrizioni?`)) {
        return;
    }
    
    const invito = allInviti[codiceGara];
    let successCount = 0;
    let errorCount = 0;
    
    for (const checkbox of checkboxes) {
        const interestId = parseInt(checkbox.dataset.interestId);
        const interest = allInterests.find(i => i.id === interestId);
        
        if (!interest) {
            errorCount++;
            continue;
        }
        
        try {
            // Create subscription
            const subscriptionData = {
                codice_gara: interest.codice_gara,
                tessera_atleta: interest.tessera_atleta,
                categoria: interest.categoria,
                classe: interest.classe || '',
                turno: invito?.turno_default || 1,
                stato: 'in attesa',
                note: interest.note || ''
            };
            
            const createResp = await fetch('/archery/api/iscrizioni', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(subscriptionData)
            });
            
            if (createResp.ok) {
                // Delete interest expression
                const deleteResp = await fetch(`/archery/api/interesse/${interestId}`, {
                    method: 'DELETE'
                });
                
                if (deleteResp.ok) {
                    successCount++;
                    // Remove from local array
                    const index = allInterests.findIndex(i => i.id === interestId);
                    if (index !== -1) {
                        allInterests.splice(index, 1);
                    }
                } else {
                    errorCount++;
                    console.error(`Failed to delete interest ${interestId}`);
                }
            } else {
                errorCount++;
                const error = await createResp.json();
                console.error(`Failed to create subscription for interest ${interestId}:`, error);
            }
        } catch (error) {
            errorCount++;
            console.error(`Error converting interest ${interestId}:`, error);
        }
    }
    
    // Show results
    if (successCount > 0) {
        alert(`✅ Convertiti con successo: ${successCount}\n${errorCount > 0 ? `⚠️ Errori: ${errorCount}` : ''}`);
        // Reload data
        await loadData();
    } else {
        alert(`❌ Nessuna conversione riuscita. Errori: ${errorCount}`);
    }
}

async function updateSubscriptionStatus(subscriptionId, newStatus) {
    try {
        // Find the subscription to get its details
        const sub = allSubscriptions.find(s => s.id === subscriptionId);
        if (!sub) {
            throw new Error('Subscription not found');
        }
        
        // Prepare update data with all required fields
        const updateData = {
            stato: newStatus,
            note: sub.note || '',
            turno: sub.turno,
            categoria: sub.categoria,
            classe: sub.classe || ''
        };
        
        const response = await fetch(`/archery/api/iscrizioni/${subscriptionId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            // Update local data
            sub.stato = newStatus;
            
            // Show notification
            showNotification('Stato aggiornato con successo', 'success');
            
            // Re-render
            renderSubscriptions();
            
            // If subscription is confirmed, check if there's a matching interest to clean up
            if (newStatus === 'confermato') {
                await cleanupMatchingInterest(sub);
            }
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update status');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
    }
}

async function cleanupMatchingInterest(subscription) {
    // Find matching interest expression
    const matchingInterest = allInterests.find(int => 
        int.codice_gara === subscription.codice_gara &&
        int.tessera_atleta === subscription.tessera_atleta &&
        int.stato === 'attivo'
    );
    
    if (matchingInterest) {
        try {
            const response = await fetch(`/archery/api/interesse/${matchingInterest.id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                console.log(`Cleaned up interest expression ${matchingInterest.id} for athlete ${subscription.tessera_atleta}`);
                // Remove from local array
                const index = allInterests.findIndex(i => i.id === matchingInterest.id);
                if (index !== -1) {
                    allInterests.splice(index, 1);
                }
                // Re-render interest tab if it's active
                if (currentTab === 'interest') {
                    renderInterest();
                }
            }
        } catch (error) {
            console.error('Error cleaning up interest expression:', error);
            // Don't show error to user - this is a background cleanup
        }
    }
}

function showNotification(message, type) {
    // Simple notification - you can enhance this
    alert(message);
}

function formatDate(dateStr) {
    if (!dateStr) return 'TBA';
    const [year, month, day] = dateStr.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    const monthShort = date.toLocaleDateString('it-IT', { month: 'short' });
    return `${day}-${monthShort.charAt(0).toUpperCase() + monthShort.slice(1)}-${year}`;
}

// Edit Subscription
function editSubscription(subscriptionId) {
    const sub = allSubscriptions.find(s => s.id === subscriptionId);
    if (!sub) return;
    
    document.getElementById('edit-sub-id').value = sub.id;
    document.getElementById('edit-sub-tessera').value = sub.tessera_atleta;
    document.getElementById('edit-sub-turno').value = sub.turno;
    document.getElementById('edit-sub-categoria').value = sub.categoria || '';
    document.getElementById('edit-sub-classe').value = sub.classe || '';
    document.getElementById('edit-sub-note').value = sub.note || '';
    document.getElementById('edit-sub-stato').value = sub.stato;
    
    document.getElementById('edit-subscription-modal').classList.remove('hidden');
    document.getElementById('edit-subscription-modal').classList.add('flex');
}

function closeEditSubscriptionModal() {
    document.getElementById('edit-subscription-modal').classList.add('hidden');
    document.getElementById('edit-subscription-modal').classList.remove('flex');
    document.getElementById('edit-subscription-form').reset();
}

document.getElementById('edit-subscription-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const subId = parseInt(document.getElementById('edit-sub-id').value);
    const sub = allSubscriptions.find(s => s.id === subId);
    if (!sub) return;
    
    const newData = {
        turno: parseInt(document.getElementById('edit-sub-turno').value),
        categoria: document.getElementById('edit-sub-categoria').value,
        classe: document.getElementById('edit-sub-classe').value || '',
        stato: document.getElementById('edit-sub-stato').value
    };
    
    // Build change description (don't include status and note changes)
    const changes = buildChangeDescription({
        turno: sub.turno,
        categoria: sub.categoria,
        classe: sub.classe
    }, newData);
    
    // Get new notes (admin can edit freely, changes are tracked separately if needed)
    let newNotes = document.getElementById('edit-sub-note').value || '';
    
    // Add note field to update data
    newData.note = newNotes;
    
    try {
        const response = await fetch(`/archery/api/iscrizioni/${subId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newData)
        });
        
        if (response.ok) {
            // Update local data
            Object.assign(sub, newData);
            
            showNotification('Iscrizione aggiornata con successo', 'success');
            closeEditSubscriptionModal();
            renderSubscriptions();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update subscription');
        }
    } catch (error) {
        console.error('Error updating subscription:', error);
        showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
    }
});

// Add Subscription
function showAddSubscriptionModal(codiceGara) {
    document.getElementById('add-sub-codice-gara').value = codiceGara;
    document.getElementById('add-subscription-form').reset();
    
    // Set default values
    document.getElementById('add-sub-turno').value = '1';
    document.getElementById('add-sub-stato').value = 'confermato';
    document.getElementById('add-sub-classe').value = 'CO';
    
    document.getElementById('add-subscription-modal').classList.remove('hidden');
    document.getElementById('add-subscription-modal').classList.add('flex');
}

function closeAddSubscriptionModal() {
    document.getElementById('add-subscription-modal').classList.add('hidden');
    document.getElementById('add-subscription-modal').classList.remove('flex');
    document.getElementById('add-subscription-form').reset();
}

document.getElementById('add-subscription-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const subscriptionData = {
        codice_gara: document.getElementById('add-sub-codice-gara').value,
        tessera_atleta: document.getElementById('add-sub-tessera').value,
        turno: parseInt(document.getElementById('add-sub-turno').value),
        categoria: document.getElementById('add-sub-categoria').value,
        classe: document.getElementById('add-sub-classe').value,
        stato: document.getElementById('add-sub-stato').value,
        note: document.getElementById('add-sub-note').value || ''
    };
    
    try {
        const response = await fetch('/archery/api/iscrizioni', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(subscriptionData)
        });
        
        if (response.ok) {
            const newSub = await response.json();
            
            // Add to local array
            allSubscriptions.push(newSub);
            
            showNotification('Iscrizione aggiunta con successo', 'success');
            closeAddSubscriptionModal();
            renderSubscriptions();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to add subscription');
        }
    } catch (error) {
        console.error('Error adding subscription:', error);
        showNotification('Errore durante l\'aggiunta: ' + error.message, 'error');
    }
});

// Edit Interest
function editInterest(interestId) {
    const interest = allInterests.find(i => i.id === interestId);
    if (!interest) return;
    
    document.getElementById('edit-int-id').value = interest.id;
    document.getElementById('edit-int-tessera').value = interest.tessera_atleta;
    document.getElementById('edit-int-categoria').value = interest.categoria || '';
    document.getElementById('edit-int-classe').value = interest.classe || '';
    document.getElementById('edit-int-note').value = interest.note || '';
    
    document.getElementById('edit-interest-modal').classList.remove('hidden');
    document.getElementById('edit-interest-modal').classList.add('flex');
}

function closeEditInterestModal() {
    document.getElementById('edit-interest-modal').classList.add('hidden');
    document.getElementById('edit-interest-modal').classList.remove('flex');
    document.getElementById('edit-interest-form').reset();
}

document.getElementById('edit-interest-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const intId = parseInt(document.getElementById('edit-int-id').value);
    const updateData = {
        categoria: document.getElementById('edit-int-categoria').value,
        classe: document.getElementById('edit-int-classe').value || '',
        note: document.getElementById('edit-int-note').value || ''
    };
    
    try {
        const response = await fetch(`/archery/api/interesse/${intId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            // Update local data
            const interest = allInterests.find(i => i.id === intId);
            if (interest) {
                Object.assign(interest, updateData);
            }
            
            showNotification('Espressione di interesse aggiornata con successo', 'success');
            closeEditInterestModal();
            renderInterest();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update interest');
        }
    } catch (error) {
        console.error('Error updating interest:', error);
        showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
    }
});

// Bulk Delete Interests
async function deleteSelectedInterests(codiceGara) {
    const checkboxes = document.querySelectorAll(`.interest-checkbox[data-competition-code="${codiceGara}"]:checked`);
    
    if (checkboxes.length === 0) {
        showNotification('Seleziona almeno un\'espressione di interesse da eliminare', 'error');
        return;
    }
    
    if (!confirm(`Sei sicuro di voler eliminare ${checkboxes.length} espressioni di interesse?`)) {
        return;
    }
    
    const interestIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.interestId));
    let successCount = 0;
    let errorCount = 0;
    
    for (const id of interestIds) {
        try {
            const response = await fetch(`/archery/api/interesse/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                successCount++;
                // Remove from local array
                const index = allInterests.findIndex(i => i.id === id);
                if (index !== -1) {
                    allInterests.splice(index, 1);
                }
            } else {
                errorCount++;
            }
        } catch (error) {
            console.error(`Error deleting interest ${id}:`, error);
            errorCount++;
        }
    }
    
    if (successCount > 0) {
        showNotification(`${successCount} espressioni di interesse eliminate con successo`, 'success');
        renderInterest();
    }
    
    if (errorCount > 0) {
        showNotification(`${errorCount} espressioni non sono state eliminate`, 'error');
    }
}

// Category validation rules
// G -> R, R -> A, A -> J, J -> S, M -> S
// Gender must remain the same (M stays M, F stays F)
function getValidCategoryChanges(currentCategory) {
    if (!currentCategory || currentCategory.length !== 2) return [];
    
    const ageCode = currentCategory[0];  // G, R, A, J, S, M
    const gender = currentCategory[1];   // M or F
    
    const validAges = [];
    
    switch(ageCode) {
        case 'G':
            validAges.push('G', 'R');  // G can change to R
            break;
        case 'R':
            validAges.push('R', 'A');  // R can change to A
            break;
        case 'A':
            validAges.push('A', 'J');  // A can change to J
            break;
        case 'J':
            validAges.push('J', 'S');  // J can change to S
            break;
        case 'S':
            validAges.push('S');       // S cannot change
            break;
        case 'M':
            validAges.push('M', 'S');  // M can change to S
            break;
        default:
            validAges.push(ageCode);   // Unknown, allow only same
    }
    
    // Generate valid categories with same gender
    return validAges.map(age => age + gender);
}

// Build change description
function buildChangeDescription(originalData, newData) {
    const changes = [];
    
    if (originalData.turno !== newData.turno) {
        changes.push(`TURNO cambia da ${originalData.turno} a ${newData.turno}`);
    }
    
    if (originalData.categoria !== newData.categoria) {
        changes.push(`CATEGORIA cambia da ${originalData.categoria} a ${newData.categoria}`);
    }
    
    if (originalData.classe !== newData.classe) {
        changes.push(`CLASSE cambia da "${originalData.classe || 'nessuna'}" a "${newData.classe || 'nessuna'}"`);
    }
    
    return changes;
}

// Apply changes to notes
function applyChangesToNotes(originalNotes, changes) {
    if (changes.length === 0) return originalNotes;
    
    const changeText = 'CAMBI RICHIESTI: ' + changes.join('; ');
    
    // If notes already contain "CAMBI RICHIESTI:", replace it
    if (originalNotes && originalNotes.includes('CAMBI RICHIESTI:')) {
        const beforeChanges = originalNotes.substring(0, originalNotes.indexOf('CAMBI RICHIESTI:'));
        return beforeChanges.trim() + (beforeChanges.trim() ? '\n\n' : '') + changeText;
    }
    
    // Otherwise append to existing notes
    return (originalNotes || '').trim() + (originalNotes ? '\n\n' : '') + changeText;
}

// Show competition invite modal
async function showCompetitionInfo(codiceGara) {
    const modal = document.getElementById('invite-modal');
    const loading = document.getElementById('invite-loading');
    const error = document.getElementById('invite-error');
    const content = document.getElementById('invite-content');
    
    const competition = allCompetitions[codiceGara];
    
    // Show modal with loading state
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    content.classList.add('hidden');
    
    // Set title
    document.getElementById('invite-modal-title').textContent = competition ? competition.nome : codiceGara;
    document.getElementById('invite-modal-subtitle').textContent = 
        `${codiceGara}${competition ? ' • ' + (competition.luogo || 'Sede da definire') : ''}`;
    
    try {
        const response = await fetch(`/archery/api/inviti/${codiceGara}/text`);
        
        if (!response.ok) {
            throw new Error(response.status === 404 ? 'Invito non disponibile' : 'Errore nel caricamento');
        }
        
        const invite = await response.json();
        
        // Populate info card
        document.getElementById('invite-dates').textContent = 
            competition ? formatDateRange(competition.data_inizio, competition.data_fine) : 'N/A';
        
        document.getElementById('invite-registration-dates').textContent = 
            invite.data_apertura_iscrizioni && invite.data_chiusura_iscrizioni
                ? formatDateRange(invite.data_apertura_iscrizioni, invite.data_chiusura_iscrizioni)
                : 'Non specificate';
        
        document.getElementById('invite-turns').textContent = 
            invite.numero_turni ? `${invite.numero_turni} turni` : 'Non specificato';
        
        // Show youth-only badge if applicable
        const youthOnlyBadge = document.getElementById('invite-youth-only');
        if (invite.solo_giovanile) {
            youthOnlyBadge.classList.remove('hidden');
        } else {
            youthOnlyBadge.classList.add('hidden');
        }
        
        // Display content
        const htmlContent = document.getElementById('invite-html-content');
        if (invite.invite_raw && invite.invite_raw.trim()) {
            if (invite.invite_raw.includes('<') && invite.invite_raw.includes('>')) {
                htmlContent.innerHTML = invite.invite_raw;
            } else {
                htmlContent.textContent = invite.invite_raw;
            }
        } else {
            htmlContent.innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                    <i class="fas fa-file-alt text-4xl mb-3"></i>
                    <p>Contenuto invito non disponibile</p>
                </div>
            `;
        }
        
        loading.classList.add('hidden');
        content.classList.remove('hidden');
        
    } catch (err) {
        console.error('Error loading invite:', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('invite-error-message').textContent = 
            err.message || 'Errore nel caricamento dell\'invito';
    }
}

function closeInviteModal() {
    document.getElementById('invite-modal').classList.add('hidden');
}

function formatDateRange(startStr, endStr) {
    if (!startStr) return 'TBA';
    const start = new Date(startStr);
    const end = endStr ? new Date(endStr) : null;
    
    const locale = 'it-IT';
    const startDay = start.getDate();
    const startMonthShort = start.toLocaleDateString('it-IT', { month: 'short' });
    const startMonth = startMonthShort.charAt(0).toUpperCase() + startMonthShort.slice(1);
    
    if (end && end.getTime() !== start.getTime()) {
        const endDay = end.getDate();
        const endMonthShort = end.toLocaleDateString('it-IT', { month: 'short' });
        const endMonth = endMonthShort.charAt(0).toUpperCase() + endMonthShort.slice(1);
        
        if (start.getMonth() === end.getMonth()) {
            return `${startDay}-${endDay} ${startMonth}`;
        } else {
            return `${startDay} ${startMonth} - ${endDay} ${endMonth}`;
        }
    }
    
    return `${startDay} ${startMonth}`;
}


</script>

<style>
.tab-button.active {
    border-color: var(--color-primary);
    color: var(--color-primary);
}
</style>
{% endblock %}
