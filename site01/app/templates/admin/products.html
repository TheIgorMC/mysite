{% extends "base.html" %}

{% block title %}Product Management - Admin{% endblock %}

{% block content %}
<section class="py-12 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Header -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <a href="{{ url_for('main.admin') }}" class="inline-flex items-center text-primary hover:text-primary-dark transition mb-4">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Admin Panel
                </a>
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white">
                    <i class="fas fa-shopping-cart text-primary mr-3"></i>Product Management
                </h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Manage product customization flags</p>
            </div>
        </div>

        <!-- Products Table -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div class="p-6">
                <div id="loading" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
                    <p class="mt-4 text-gray-600 dark:text-gray-400">{{ t('common.loading') }}</p>
                </div>

                <div id="products-container" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-900">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                        Product
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                        Category
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                        Price
                                    </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                        Active
                                    </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                        Custom String
                                    </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                        Custom Print
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Products will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="no-products" class="hidden text-center py-8 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-box-open text-4xl mb-4"></i>
                    <p>No products found</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
let products = [];

document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
});

async function loadProducts() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('products-container');
    const noProducts = document.getElementById('no-products');
    const tbody = document.getElementById('products-table-body');

    loading.classList.remove('hidden');
    container.classList.add('hidden');
    noProducts.classList.add('hidden');

    try {
        const response = await fetch('/api/products');
        products = await response.json();

        if (products.length === 0) {
            noProducts.classList.remove('hidden');
        } else {
            tbody.innerHTML = '';
            products.forEach(product => {
                tbody.appendChild(createProductRow(product));
            });
            container.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading products:', error);
        showNotification('Error loading products', 'error');
    } finally {
        loading.classList.add('hidden');
    }
}

function createProductRow(product) {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition';

    tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900 dark:text-white">${product.name_en}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">${product.name_it}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                ${product.category || 'N/A'}
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
            â‚¬${product.price ? product.price.toFixed(2) : '0.00'}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" 
                       ${product.is_active ? 'checked' : ''} 
                       onchange="toggleFlag(${product.id}, 'is_active', this.checked)"
                       class="sr-only peer">
                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
            </label>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" 
                       ${product.is_custom_string ? 'checked' : ''} 
                       onchange="toggleFlag(${product.id}, 'is_custom_string', this.checked)"
                       class="sr-only peer">
                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 dark:peer-focus:ring-green-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-green-600"></div>
            </label>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" 
                       ${product.is_custom_print ? 'checked' : ''} 
                       onchange="toggleFlag(${product.id}, 'is_custom_print', this.checked)"
                       class="sr-only peer">
                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"></div>
            </label>
        </td>
    `;

    return tr;
}

async function toggleFlag(productId, flag, value) {
    try {
        const response = await fetch(`/api/products/${productId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [flag]: value })
        });

        if (response.ok) {
            showNotification('Product updated successfully', 'success');
            // Update local data
            const product = products.find(p => p.id === productId);
            if (product) {
                product[flag] = value;
            }
        } else {
            const error = await response.json();
            showNotification(error.error || 'Error updating product', 'error');
            // Revert checkbox
            loadProducts();
        }
    } catch (error) {
        console.error('Error updating product:', error);
        showNotification('Error updating product', 'error');
        loadProducts();
    }
}

function showNotification(message, type = 'info') {
    // Simple notification system
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    } text-white`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}
