{% extends "base.html" %}

{% block title %}{{ t('archery.competitions') }} - {{ super() }}{% endblock %}

{% block content %}
<section class="py-12 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto p        if (authAthletesResp.ok) {
            const authData = await authAthletesResp.json();
            authorizedAthletes = authData.authorized_athletes || [];
        }
        
        // Load competitions from Flask proxy (which calls FastAPI with auth)
        const gareResp = await fetch(`/archery/api/gare?future=true&limit=100`);-7xl">
        <!-- Header -->
        <div class="mb-8">
            <a href="{{ url_for('archery.index') }}" 
               class="inline-flex items-center text-primary hover:text-primary-dark mb-4 transition">
                <i class="fas fa-arrow-left mr-2"></i>{{ t('common.back') }}
            </a>
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">{{ t('archery.competitions') }}</h1>
            <p class="text-gray-600 dark:text-gray-400">{{ t('archery.competitions_subtitle') }}</p>
        </div>

        <!-- Filter Tabs -->
        <div class="mb-6">
            <div class="border-b border-gray-300 dark:border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button onclick="filterCompetitions('upcoming')" 
                            id="tab-upcoming"
                            class="tab-button active px-4 py-2 font-medium text-sm border-b-2 border-primary text-primary">
                        {{ t('competitions.upcoming') }}
                    </button>
                    <button onclick="filterCompetitions('open')" 
                            id="tab-open"
                            class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary hover:border-gray-300">
                        {{ t('competitions.open_subscriptions') }}
                    </button>
                    <button onclick="filterCompetitions('my')" 
                            id="tab-my"
                            class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary hover:border-gray-300">
                        {{ t('competitions.my_subscriptions') }}
                    </button>
                </nav>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        </div>

        <!-- Competitions Grid -->
        <div id="competitions-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Competitions will be loaded here by JavaScript -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <i class="fas fa-calendar-times text-6xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 dark:text-gray-400 text-lg">{{ t('competitions.no_competitions') }}</p>
        </div>
    </div>
</section>

<!-- Competition Card Template -->
<template id="competition-card-template">
    <div class="competition-card bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
        <div class="p-6">
            <!-- Header -->
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <h3 class="competition-name text-xl font-bold text-gray-900 dark:text-white mb-2"></h3>
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400 mb-1">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        <span class="competition-location"></span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-calendar mr-2"></i>
                        <span class="competition-date"></span>
                    </div>
                </div>
                <span class="competition-badge px-3 py-1 rounded-full text-xs font-semibold"></span>
            </div>

            <!-- Details -->
            <div class="space-y-2 mb-4">
                <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-bullseye mr-2 text-primary"></i>
                    <span class="competition-type"></span>
                </div>
                <div class="competition-category-container hidden flex items-center text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-tag mr-2 text-primary"></i>
                    <span class="competition-category"></span>
                </div>
                <div class="competition-deadline-container hidden flex items-center text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-clock mr-2 text-primary"></i>
                    <span>{{ t('competitions.deadline') }}: <span class="competition-deadline"></span></span>
                </div>
            </div>

            <!-- Subscription Status -->
            <div class="competition-subscription-status hidden mb-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center text-green-800 dark:text-green-300">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>{{ t('competitions.subscribed') }}</span>
                    </div>
                    <button class="btn-unsubscribe text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 px-2 py-1 rounded transition" title="{{ t('competitions.delete_subscription') }}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-2">
                <button class="btn-subscribe flex-1 bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition font-medium">
                    <i class="fas fa-user-plus mr-2"></i>{{ t('competitions.subscribe') }}
                </button>
                <button class="btn-details flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg transition font-medium">
                    <i class="fas fa-info-circle mr-2"></i>{{ t('competitions.details') }}
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Subscription Modal -->
<div id="subscription-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="closeSubscriptionModal()"></div>

        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4" id="modal-title">
                            {{ t('competitions.subscribe_title') }}
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="modal-competition-info"></p>
                            
                            <form id="subscription-form">
                                <input type="hidden" id="competition-id" name="competition_id">
                                
                                <!-- Athlete Selection -->
                                <div class="mb-4">
                                    <label for="selected-athlete" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('competitions.select_athlete') }}
                                    </label>
                                    <div id="athlete-select-container">
                                        <!-- Populated by JavaScript -->
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="age-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('competitions.age_category') }}
                                    </label>
                                    <select id="age-category" name="age_category" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">{{ t('competitions.select_age_category') }}</option>
                                        <option value="GM">GM - Giovanissimi Maschile</option>
                                        <option value="GF">GF - Giovanissimi Femminile</option>
                                        <option value="RM">RM - Ragazzi Maschile</option>
                                        <option value="RF">RF - Ragazzi Femminile</option>
                                        <option value="AM">AM - Allievi Maschile</option>
                                        <option value="AF">AF - Allievi Femminile</option>
                                        <option value="JM">JM - Juniores Maschile</option>
                                        <option value="JF">JF - Juniores Femminile</option>
                                        <option value="SM">SM - Seniores Maschile</option>
                                        <option value="SF">SF - Seniores Femminile</option>
                                        <option value="MM">MM - Master Maschile</option>
                                        <option value="MF">MF - Master Femminile</option>
                                    </select>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                        <i class="fas fa-info-circle mr-1"></i>{{ t('competitions.age_category_info') }}
                                    </p>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="bow-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('competitions.bow_type') }}
                                    </label>
                                    <select id="bow-type" name="bow_type" required
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">{{ t('competitions.select_bow_type') }}</option>
                                        <option value="CO">CO - Compound</option>
                                        <option value="OL">OL - Olympic Recurve</option>
                                        <option value="AN">AN - Barebow</option>
                                    </select>
                                </div>
                                
                                <div id="turn-selection-container" class="mb-4">
                                    <label for="turn" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('competitions.select_turn') }}
                                    </label>
                                    <select id="turn" name="turn" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">{{ t('competitions.choose_turn') }}</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('competitions.notes') }} ({{ t('common.optional') }})
                                    </label>
                                    <textarea id="notes" name="notes" rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                              placeholder="{{ t('competitions.notes_placeholder') }}"></textarea>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitSubscription()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark sm:ml-3 sm:w-auto sm:text-sm">
                    {{ t('competitions.confirm_subscription') }}
                </button>
                <button type="button" onclick="closeSubscriptionModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 sm:mt-0 sm:w-auto sm:text-sm">
                    {{ t('common.cancel') }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Configuration - Use Flask proxy endpoints (no direct API calls)
// All API calls go through Flask backend which handles Cloudflare Access

let currentFilter = 'upcoming';
let allCompetitions = [];
let allInviti = {};  // Invitation details mapped by codice_gara
let allTurni = {};   // Turns mapped by codice_gara
let userSubscriptions = new Map();  // Map of codice_gara -> array of subscription objects
let authorizedAthletes = [];  // User's authorized athletes from website
let expressedInterest = new Set();  // Set of codice_gara where user expressed interest (localStorage)

// Load expressed interest from localStorage
function loadExpressedInterest() {
    try {
        const stored = localStorage.getItem('archery_expressed_interest');
        if (stored) {
            const parsed = JSON.parse(stored);
            expressedInterest = new Set(parsed);
        }
    } catch (error) {
        console.error('Error loading expressed interest:', error);
    }
}

// Save expressed interest to localStorage
function saveExpressedInterest() {
    try {
        localStorage.setItem('archery_expressed_interest', JSON.stringify([...expressedInterest]));
    } catch (error) {
        console.error('Error saving expressed interest:', error);
    }
}

// Mark interest in a competition
function markInterest(codiceGara) {
    expressedInterest.add(codiceGara);
    saveExpressedInterest();
}

// Load competitions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadExpressedInterest();  // Load from localStorage
    loadInitialData();
});

async function loadInitialData() {
    console.log('Loading initial data...');
    showLoading(true);
    
    try {
        // Load authorized athletes from website
        const authAthletesResp = await fetch('/api/user/authorized-athletes');
        if (authAthletesResp.ok) {
            const authData = await authAthletesResp.json();
            authorizedAthletes = authData.authorized_athletes || [];
        }
        console.log('Loaded athletes:', authorizedAthletes.length);
        
        // Load competitions from Flask proxy (which calls FastAPI with auth)
        const gareResp = await fetch(`/archery/api/gare?future=true&limit=500`);
        if (!gareResp.ok) throw new Error('Failed to load competitions');
        
        allCompetitions = await gareResp.json();
        console.log('Loaded competitions:', allCompetitions.length);
        
        // Load inviti and turni in parallel for better performance
        await Promise.all([
            loadInviti(),
            loadTurniForAll()
        ]);
        console.log('Loaded inviti and turni');
        
        // Load user's subscriptions from FastAPI
        if (authorizedAthletes.length > 0) {
            await loadUserSubscriptions();
            console.log('Loaded subscriptions');
        }
        
        console.log('Filtering competitions...');
        filterCompetitions(currentFilter);
        console.log('Filter complete');
    } catch (error) {
        console.error('Error loading data:', error);
        showError('Failed to load competitions');
    } finally {
        // Always hide loading spinner
        console.log('Hiding spinner');
        showLoading(false);
    }
}

async function loadInviti() {
    // Load all invites data from API
    console.log('loadInviti: Starting...');
    try {
        const resp = await fetch(`/archery/api/inviti?only_open=false&only_youth=false`);
        console.log('loadInviti: Fetch complete, status:', resp.status);
        if (resp.ok) {
            const inviti = await resp.json();
            console.log('loadInviti: Got', inviti.length, 'invites');
            // Map invites by codice for fast lookup
            inviti.forEach(invito => {
                allInviti[invito.codice] = invito;
                console.log(`  Mapped invite: ${invito.codice} -> apertura:${invito.data_apertura_iscrizioni}, chiusura:${invito.data_chiusura_iscrizioni}`);
            });
        } else {
            console.warn('loadInviti: Response not OK:', resp.status);
        }
    } catch (error) {
        console.error('Error loading inviti:', error);
    }
    console.log('loadInviti: Complete. Total mapped:', Object.keys(allInviti).length);
}

async function loadTurniForAll() {
    // Load turns for all competitions in parallel (faster than sequential)
    console.log('loadTurniForAll: Starting for', allCompetitions.length, 'competitions');
    const promises = allCompetitions.map(async (comp) => {
        try {
            const resp = await fetch(`/archery/api/turni?codice_gara=${comp.codice}`);
            if (resp.ok) {
                const turns = await resp.json();
                allTurni[comp.codice] = turns || [];
            } else {
                allTurni[comp.codice] = [];
            }
        } catch (error) {
            console.error(`Error loading turns for ${comp.codice}:`, error);
            allTurni[comp.codice] = [];
        }
    });
    
    await Promise.all(promises);
    console.log('loadTurniForAll: Complete, loaded turns for', Object.keys(allTurni).length, 'competitions');
}

async function loadUserSubscriptions() {
    try {
        // Load subscriptions for all authorized athletes from Flask proxy
        for (const athlete of authorizedAthletes) {
            const resp = await fetch(`/archery/api/iscrizioni?tessera_atleta=${athlete.tessera}`);
            if (resp.ok) {
                const subscriptions = await resp.json();
                subscriptions.forEach(sub => {
                    // Store subscriptions as array per competition to support multiple athletes
                    if (!userSubscriptions.has(sub.codice_gara)) {
                        userSubscriptions.set(sub.codice_gara, []);
                    }
                    userSubscriptions.get(sub.codice_gara).push(sub);
                });
            }
        }
    } catch (error) {
        console.error('Error loading user subscriptions:', error);
    }
}

/**
 * Get competition status based on dates and invite data
 * Returns: {
 *   status: 'iscrizioni_chiuse'|'iscrizioni_aperte'|'in_arrivo'|'attesa_invito',
 *   canSubscribe: boolean,
 *   label: string,
 *   color: string (CSS classes)
 * }
 */
function getCompetitionStatus(competition) {
    const now = new Date();
    now.setHours(0, 0, 0, 0); // Compare dates only, not times
    
    const startDate = new Date(competition.data_inizio);
    startDate.setHours(0, 0, 0, 0);
    
    const invito = allInviti[competition.codice];
    
    console.log(`Status for ${competition.codice} (${competition.nome}):`, {
        has_invito: !!invito,
        invito_data: invito,
        start_date: competition.data_inizio
    });
    
    // No invite associated = "attesa invito" (white)
    if (!invito) {
        return {
            status: 'attesa_invito',
            canSubscribe: false,
            canExpressInterest: true,
            label: window.translations.attesa_invito || 'Attesa invito',
            color: 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
        };
    }
    
    const aperturaDate = new Date(invito.data_apertura_iscrizioni);
    aperturaDate.setHours(0, 0, 0, 0);
    
    const chiusuraDate = new Date(invito.data_chiusura_iscrizioni);
    chiusuraDate.setHours(0, 0, 0, 0);
    
    console.log(`  Dates: now=${now.toISOString()}, apertura=${aperturaDate.toISOString()}, chiusura=${chiusuraDate.toISOString()}, start=${startDate.toISOString()}`);
    
    // Competition started OR subscription window closed = "iscrizioni chiuse" (red)
    if (startDate <= now || chiusuraDate < now) {
        console.log(`  → Status: CHIUSE (started=${startDate <= now}, closed=${chiusuraDate < now})`);
        return {
            status: 'iscrizioni_chiuse',
            canSubscribe: false,
            canExpressInterest: false,
            label: window.translations.iscrizioni_chiuse || 'Iscrizioni chiuse',
            color: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300'
        };
    }
    
    // Subscription window is currently open = "iscrizioni aperte" (green)
    if (now >= aperturaDate && now <= chiusuraDate && startDate > now) {
        console.log(`  → Status: APERTE`);
        return {
            status: 'iscrizioni_aperte',
            canSubscribe: true,
            canExpressInterest: false,
            label: window.translations.iscrizioni_aperte || 'Iscrizioni aperte',
            color: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
        };
    }
    
    // Subscription opens in the future = "in arrivo" (blue)
    if (aperturaDate > now && startDate > now) {
        console.log(`  → Status: IN ARRIVO`);
        return {
            status: 'in_arrivo',
            canSubscribe: true,  // Allow subscribing even if not yet open
            canExpressInterest: false,
            label: window.translations.in_arrivo || 'In arrivo',
            color: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300'
        };
    }
    
    // Fallback (shouldn't reach here)
    console.log(`  → Status: FALLBACK (attesa invito)`);
    return {
        status: 'attesa_invito',
        canSubscribe: false,
        canExpressInterest: true,
        label: 'Attesa invito',
        color: 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
    };
}

function filterCompetitions(filter) {
    currentFilter = filter;
    
    // Update tab styling
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-primary', 'text-primary');
        btn.classList.add('border-transparent', 'text-gray-600', 'dark:text-gray-400');
    });
    document.getElementById(`tab-${filter}`).classList.add('active', 'border-primary', 'text-primary');
    document.getElementById(`tab-${filter}`).classList.remove('border-transparent', 'text-gray-600', 'dark:text-gray-400');
    
    // Filter competitions based on selected tab
    let filtered = [];
    const now = new Date();
    
    switch(filter) {
        case 'upcoming':
            // Future competitions (not ended yet) - region 06 only
            filtered = allCompetitions.filter(c => {
                const endDate = new Date(c.data_fine);
                endDate.setHours(0, 0, 0, 0);
                return endDate >= now;
            });
            break;
        case 'open':
            // Competitions with OPEN subscription windows (today between apertura and chiusura dates)
            filtered = allCompetitions.filter(c => {
                const invito = allInviti[c.codice];
                if (!invito) return false;  // No invite = not open
                
                const aperturaDate = new Date(invito.data_apertura_iscrizioni);
                aperturaDate.setHours(0, 0, 0, 0);
                const chiusuraDate = new Date(invito.data_chiusura_iscrizioni);
                chiusuraDate.setHours(0, 0, 0, 0);
                const startDate = new Date(c.data_inizio);
                startDate.setHours(0, 0, 0, 0);
                
                // Open if: today is between apertura and chiusura, and competition hasn't started
                return now >= aperturaDate && now <= chiusuraDate && startDate > now;
            });
            break;
        case 'my':
            // User's subscriptions
            filtered = allCompetitions.filter(c => userSubscriptions.has(c.codice));
            break;
    }
    
    // Filter by region 06 (Veneto) based on societa_codice
    // Show ALL region 06 competitions, including those WITHOUT published invites
    // Users can express interest in competitions without invites
    filtered = filtered.filter(c => c.societa_codice && c.societa_codice.startsWith('06'));
    
    renderCompetitions(filtered);
}

/**
 * Get subscription summary for a competition (handles multiple athletes)
 * Returns: { hasActiveSubscription, allCancelled, statusText, statusColor, primaryStatus, subscriptions }
 */
function getSubscriptionSummary(codiceGara) {
    if (!userSubscriptions.has(codiceGara)) {
        return { hasActiveSubscription: false, allCancelled: false, subscriptions: [] };
    }
    
    const subs = userSubscriptions.get(codiceGara);
    const activeSubs = subs.filter(s => s.stato !== 'cancellato');
    
    if (activeSubs.length === 0) {
        return { hasActiveSubscription: false, allCancelled: true, subscriptions: subs };
    }
    
    // Count by status
    const confirmed = activeSubs.filter(s => s.stato === 'confermato').length;
    const waiting = activeSubs.filter(s => s.stato === 'in attesa').length;
    const pending = activeSubs.filter(s => s.stato === 'richiesta_effettuata').length;
    
    // Determine primary status (priority: confirmed > waiting > pending)
    let primaryStatus, statusText, statusColor, statusIcon;
    if (confirmed > 0) {
        primaryStatus = 'confermato';
        statusIcon = 'fas fa-check-circle';
        statusColor = 'green';
        statusText = confirmed === 1 ? 'Iscritto' : `${confirmed} iscritti`;
    } else if (waiting > 0) {
        primaryStatus = 'in attesa';
        statusIcon = 'fas fa-clock';
        statusColor = 'yellow';
        statusText = waiting === 1 ? 'In attesa' : `${waiting} in attesa`;
    } else {
        primaryStatus = 'richiesta_effettuata';
        statusIcon = 'fas fa-paper-plane';
        statusColor = 'gray';
        statusText = pending === 1 ? 'Richiesta effettuata' : `${pending} richieste`;
    }
    
    return { 
        hasActiveSubscription: true, 
        allCancelled: false,
        primaryStatus, 
        statusText, 
        statusColor,
        statusIcon,
        subscriptions: subs,
        activeSubs,
        confirmed,
        waiting,
        pending
    };
}

function renderCompetitions(competitions) {
    const grid = document.getElementById('competitions-grid');
    const emptyState = document.getElementById('empty-state');
    const template = document.getElementById('competition-card-template');
    
    grid.innerHTML = '';
    
    if (competitions.length === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }
    
    grid.classList.remove('hidden');
    emptyState.classList.add('hidden');
    
    competitions.forEach(competition => {
        const card = template.content.cloneNode(true);
        
        // Fill in competition details
        card.querySelector('.competition-name').textContent = competition.nome;
        
        // Show location (luogo) if available, otherwise show societa name or code
        let locationText = competition.luogo || competition.societa_nome || competition.societa_codice || 'TBA';
        card.querySelector('.competition-location').textContent = locationText;
        
        card.querySelector('.competition-date').textContent = formatDateRange(competition.data_inizio, competition.data_fine);
        card.querySelector('.competition-type').textContent = competition.tipo || 'Competition';
        
        // Get competition status (red/green/blue/white)
        const competitionStatus = getCompetitionStatus(competition);
        
        // Status badge with color
        const badge = card.querySelector('.competition-badge');
        badge.textContent = competitionStatus.label;
        badge.className = `competition-badge px-3 py-1 rounded-full text-xs font-semibold ${competitionStatus.color}`;
        
        // Subscription status and button logic
        const subscribeBtn = card.querySelector('.btn-subscribe');
        const unsubscribeBtn = card.querySelector('.btn-unsubscribe');
        
        const subSummary = getSubscriptionSummary(competition.codice);
        
        if (subSummary.hasActiveSubscription) {
            // User has active subscriptions - show summary
            const statusBox = card.querySelector('.competition-subscription-status');
            statusBox.classList.remove('hidden');
            
            // Update status box based on primary subscription status
            const statusTextContainer = statusBox.querySelector('.flex.items-center.text-green-800');
            const statusIcon = statusTextContainer.querySelector('i');
            const statusText = statusTextContainer.querySelector('span');
            
            // Remove all color classes
            statusBox.classList.remove(
                'bg-green-50', 'dark:bg-green-900/20', 'border-green-200', 'dark:border-green-800',
                'bg-yellow-50', 'dark:bg-yellow-900/20', 'border-yellow-200', 'dark:border-yellow-800',
                'bg-red-50', 'dark:bg-red-900/20', 'border-red-200', 'dark:border-red-800',
                'bg-gray-50', 'dark:bg-gray-900/20', 'border-gray-200', 'dark:border-gray-800'
            );
            statusTextContainer.classList.remove(
                'text-green-800', 'dark:text-green-300',
                'text-yellow-800', 'dark:text-yellow-300',
                'text-red-800', 'dark:text-red-300',
                'text-gray-800', 'dark:text-gray-300'
            );
            
            // Apply styling based on primary status
            const colorMap = {
                'green': {
                    bg: ['bg-green-50', 'dark:bg-green-900/20', 'border-green-200', 'dark:border-green-800'],
                    text: ['text-green-800', 'dark:text-green-300']
                },
                'yellow': {
                    bg: ['bg-yellow-50', 'dark:bg-yellow-900/20', 'border-yellow-200', 'dark:border-yellow-800'],
                    text: ['text-yellow-800', 'dark:text-yellow-300']
                },
                'gray': {
                    bg: ['bg-gray-50', 'dark:bg-gray-900/20', 'border-gray-200', 'dark:border-gray-800'],
                    text: ['text-gray-800', 'dark:text-gray-300']
                }
            };
            
            const colors = colorMap[subSummary.statusColor];
            statusBox.classList.add(...colors.bg);
            statusTextContainer.classList.add(...colors.text);
            statusIcon.className = `${subSummary.statusIcon} mr-2`;
            statusText.textContent = subSummary.statusText;
            
            // Allow subscribing additional athletes if:
            // 1. User has multiple authorized athletes
            // 2. Not all athletes are subscribed (active subscriptions < total athletes)
            const canSubscribeMore = authorizedAthletes.length > 1 && 
                                      subSummary.activeSubs.length < authorizedAthletes.length;
            
            if (canSubscribeMore) {
                subscribeBtn.disabled = false;
                subscribeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                subscribeBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Aggiungi atleta';
            } else {
                subscribeBtn.disabled = true;
                subscribeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // Wire up delete button - show list of subscribed athletes to delete
            unsubscribeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteSubscriptionModal(subSummary.subscriptions, competition);
            });
        } else if (subSummary.allCancelled) {
            // All subscriptions cancelled - allow resubscription
            subscribeBtn.disabled = false;
            subscribeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            subscribeBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>' + (window.translations.competitions?.subscribe || 'Subscribe');
        } else {
            // Not subscribed - configure button based on competition status
            if (competitionStatus.canExpressInterest) {
                // Check if user already expressed interest
                if (expressedInterest.has(competition.codice)) {
                    // Already expressed interest - show as marked
                    subscribeBtn.innerHTML = '<i class="fas fa-star mr-2"></i>' + (window.translations.mi_interessa || 'Mi interessa');
                    subscribeBtn.classList.remove('bg-primary', 'hover:bg-primary-dark', 'bg-yellow-500', 'hover:bg-yellow-600');
                    subscribeBtn.classList.add('bg-yellow-600', 'cursor-default');
                    subscribeBtn.disabled = true;
                    
                    // Add a small indicator badge
                    const badge = document.createElement('span');
                    badge.className = 'ml-2 text-xs';
                    badge.innerHTML = '<i class="fas fa-check"></i>';
                    subscribeBtn.appendChild(badge);
                } else {
                    // Show "Mi interessa" button for competitions without invites
                    subscribeBtn.innerHTML = '<i class="fas fa-star mr-2"></i>' + (window.translations.mi_interessa || 'Mi interessa');
                    subscribeBtn.classList.remove('bg-primary', 'hover:bg-primary-dark');
                    subscribeBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    subscribeBtn.disabled = false;
                }
            } else if (competitionStatus.canSubscribe) {
                // Normal subscribe button
                subscribeBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>' + (window.translations.competitions?.subscribe || 'Subscribe');
                subscribeBtn.classList.add('bg-primary', 'hover:bg-primary-dark');
                subscribeBtn.disabled = false;
            } else {
                // Closed - cannot subscribe
                subscribeBtn.textContent = window.translations.competitions?.closed || 'Chiuso';
                subscribeBtn.classList.remove('bg-primary', 'hover:bg-primary-dark');
                subscribeBtn.classList.add('bg-red-600', 'opacity-50', 'cursor-not-allowed');
                subscribeBtn.disabled = true;
            }
        }
        
        // Button actions
        subscribeBtn.addEventListener('click', () => {
            if (!subscribeBtn.disabled) {
                openSubscriptionModal(competition);
            }
        });
        card.querySelector('.btn-details').addEventListener('click', () => showCompetitionDetails(competition));
        
        grid.appendChild(card);
    });
}

async function openSubscriptionModal(competition) {
    // Get subscription summary to check who's already subscribed
    const subSummary = getSubscriptionSummary(competition.codice);
    const subscribedAthletes = new Set(subSummary.subscriptions
        .filter(s => s.stato !== 'cancellato')
        .map(s => s.tessera_atleta));
    
    // Filter to only show athletes who aren't already subscribed
    const availableAthletes = authorizedAthletes.filter(a => !subscribedAthletes.has(a.tessera));
    
    if (availableAthletes.length === 0) {
        showNotification('Tutti gli atleti sono già iscritti a questa gara', 'info');
        return;
    }
    
    // Populate modal with competition info
    document.getElementById('competition-id').value = competition.codice;
    document.getElementById('modal-competition-info').textContent = 
        `${competition.nome} - ${formatDate(competition.data_inizio)}`;
    
    // Load turns for this competition from Flask proxy
    try {
        const turnsResp = await fetch(`/archery/api/turni?codice_gara=${competition.codice}`);
        if (turnsResp.ok) {
            const turns = await turnsResp.json();
            
            console.log(`Turns for ${competition.codice}:`, turns);
            
            // Check if invite is published (has turns)
            if (!turns || turns.length === 0) {
                // No invite published - show "Express Interest" mode
                console.log(`No turns found for ${competition.codice} - showing express interest`);
                showExpressInterestMode(competition, availableAthletes);
                return;
            }
            
            // Has turns - show normal subscription mode
            console.log(`${turns.length} turns found for ${competition.codice} - showing normal subscription`);
            populateTurnsDropdown(turns);
            showNormalSubscriptionMode(competition, availableAthletes);
        } else {
            // API error - assume no invite, allow express interest
            console.log(`API error loading turns for ${competition.codice} - showing express interest`);
            showExpressInterestMode(competition, availableAthletes);
            return;
        }
    } catch (error) {
        console.error('Error loading turns:', error);
        showExpressInterestMode(competition, availableAthletes);
        return;
    }
}

function showNormalSubscriptionMode(competition, availableAthletes = null) {
    // Reset modal to normal subscription mode
    
    // Reset modal title
    document.getElementById('modal-title').textContent = 
        window.translations.competitions?.subscribe_title || 'Subscribe to Competition';
    
    // Show turn selection
    const turnContainer = document.getElementById('turn-selection-container');
    if (turnContainer) turnContainer.style.display = 'block';
    
    // Reset info message
    const infoEl = document.getElementById('modal-competition-info');
    infoEl.innerHTML = `<p class="text-gray-600 dark:text-gray-400">${competition.nome} - ${formatDate(competition.data_inizio)}</p>`;
    
    // Populate athlete dropdown (filter if provided)
    populateAthleteDropdown(availableAthletes);
    
    // Show modal
    document.getElementById('subscription-modal').classList.remove('hidden');
}

function showExpressInterestMode(competition, availableAthletes = null) {
    // Competition doesn't have published invite yet
    // Show modal with "Express Interest" instead of full subscription
    
    // Update modal title
    document.getElementById('modal-title').textContent = 
        window.translations.competitions?.express_interest_title || 'Express Interest in Competition';
    
    // Hide turn selection (no turns available)
    const turnContainer = document.getElementById('turn-selection-container');
    if (turnContainer) turnContainer.style.display = 'none';
    
    // Update submit button text
    const submitBtn = document.querySelector('#subscription-form').closest('div').querySelector('button[type="button"]');
    if (submitBtn && submitBtn.textContent.includes('Confirm')) {
        submitBtn.textContent = window.translations.competitions?.express_interest_btn || 'Express Interest';
    }
    
    // Add info message
    const infoEl = document.getElementById('modal-competition-info');
    infoEl.innerHTML = `
        <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg mb-4">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-yellow-600 dark:text-yellow-400 mt-0.5 mr-2"></i>
                <div class="text-sm text-yellow-800 dark:text-yellow-300">
                    <strong>${window.translations.competitions?.no_invite_title || 'Invite Not Yet Published'}</strong><br>
                    ${window.translations.competitions?.no_invite_desc || 'The official invitation for this competition has not been published yet. You can express interest and we will notify you when registration opens.'}
                </div>
            </div>
        </div>
        <p class="text-gray-600 dark:text-gray-400">${competition.nome} - ${formatDate(competition.data_inizio)}</p>
    `;
    
    // Populate athlete dropdown (filter if provided)
    populateAthleteDropdown(availableAthletes);
    
    // Show modal
    document.getElementById('subscription-modal').classList.remove('hidden');
}

function populateTurnsDropdown(turns) {
    const select = document.getElementById('turn');
    select.innerHTML = `<option value="">${window.translations.competitions?.choose_turn || 'Select turn...'}</option>`;
    
    turns.forEach(turn => {
        const option = document.createElement('option');
        option.value = turn.turno;
        // Build display text, only including non-null parts
        const parts = [];
        if (turn.giorno) parts.push(turn.giorno);
        if (turn.fase) parts.push(turn.fase);
        if (turn.ora_ritrovo) {
            // Format time from "08:45:00" to "08:45"
            // Convert to string if it's not already
            const timeStr = typeof turn.ora_ritrovo === 'string' ? turn.ora_ritrovo : String(turn.ora_ritrovo);
            const timeFormatted = timeStr.substring(0, 5);
            parts.push(timeFormatted);
        }
        option.textContent = parts.length > 0 ? parts.join(' - ') : `Turno ${turn.turno}`;
        select.appendChild(option);
    });
}

function populateAthleteDropdown(filteredAthletes = null) {
    const container = document.getElementById('athlete-select-container');
    const athletes = filteredAthletes || authorizedAthletes;
    
    if (athletes.length === 0) {
        container.innerHTML = '<p class="text-sm text-yellow-600 dark:text-yellow-400">No authorized athletes. Contact admin to add athletes to your account.</p>';
        return;
    }
    
    if (athletes.length === 1) {
        // Only one athlete - auto-select and hide dropdown, pre-fill form fields
        const athlete = athletes[0];
        container.innerHTML = `<input type="hidden" id="selected-athlete" value="${athlete.tessera}">
                              <p class="text-sm text-gray-600 dark:text-gray-400">Subscribing: ${athlete.display}</p>`;
        // Pre-fill age category and bow type from athlete data
        if (athlete.age_category) {
            document.getElementById('age-category').value = athlete.age_category;
        }
        if (athlete.classe) {
            document.getElementById('bow-type').value = athlete.classe;
        }
        return;
    }
    
    // Multiple athletes - show dropdown with theme matching
    const select = document.createElement('select');
    select.id = 'selected-athlete';
    select.className = 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary';
    
    select.innerHTML = '<option value="">Select athlete...</option>';
    athletes.forEach(athlete => {
        const option = document.createElement('option');
        option.value = athlete.tessera;
        option.textContent = athlete.display;
        option.dataset.ageCategory = athlete.age_category || '';
        option.dataset.bowType = athlete.classe || '';
        select.appendChild(option);
    });
    
    // Add event listener to pre-fill form when athlete is selected
    select.addEventListener('change', function(e) {
        const selectedOption = e.target.selectedOptions[0];
        if (selectedOption && selectedOption.value) {
            // Pre-fill age category and bow type from selected athlete
            if (selectedOption.dataset.ageCategory) {
                document.getElementById('age-category').value = selectedOption.dataset.ageCategory;
            }
            if (selectedOption.dataset.bowType) {
                document.getElementById('bow-type').value = selectedOption.dataset.bowType;
            }
        } else {
            // Reset fields if no athlete selected
            document.getElementById('age-category').value = '';
            document.getElementById('bow-type').value = '';
        }
    });
    
    container.innerHTML = '';
    container.appendChild(select);
}

function closeSubscriptionModal() {
    document.getElementById('subscription-modal').classList.add('hidden');
    document.getElementById('subscription-form').reset();
}

async function submitSubscription() {
    const codiceGara = document.getElementById('competition-id').value;
    const turn = document.getElementById('turn').value;
    const tessera = document.getElementById('selected-athlete')?.value;
    const ageCategory = document.getElementById('age-category').value;
    const bowType = document.getElementById('bow-type').value;
    const notes = document.getElementById('notes').value;
    
    // Check if turn selection is visible (normal subscription) or hidden (express interest)
    const turnContainer = document.getElementById('turn-selection-container');
    const isExpressInterest = turnContainer && turnContainer.style.display === 'none';
    
    if (!isExpressInterest && !turn) {
        showNotification(window.translations.competitions?.select_turn_required || 'Please select a turn', 'warning');
        return;
    }
    
    if (!tessera) {
        showNotification('Please select an athlete', 'warning');
        return;
    }
    
    if (!ageCategory) {
        showNotification('Please select an age category', 'warning');
        return;
    }
    
    if (!bowType) {
        showNotification('Please select a bow type', 'warning');
        return;
    }
    
    try {
        // Submit to Flask proxy (which forwards to FastAPI with auth)
        // NOTE: Server expects categoria=bow_type (CO/OL/AN) and classe=age_category (SM/SF/etc)
        const response = await fetch(`/archery/api/iscrizioni`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                codice_gara: codiceGara,
                tessera_atleta: tessera,
                categoria: bowType,             // Competition class / bow type: CO (Compound), OL (Olympic), AN (Barebow)
                classe: ageCategory,            // Age category: SM, SF, MM, MF, GM, GF, RM, RF, AM, AF, JM, JF
                turno: isExpressInterest ? 0 : parseInt(turn),  // Use 0 for express interest
                stato: 'in attesa',  // Pending - admin must confirm manually
                note: isExpressInterest ? 
                    `Interesse espresso (invito non pubblicato). ${notes}` : 
                    notes
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Subscription failed');
        }
        
        const result = await response.json();
        
        // If this was express interest, mark it in localStorage
        if (isExpressInterest) {
            markInterest(codiceGara);
        }
        
        // Create subscription object from response
        const subscription = {
            id: result.id,
            codice_gara: codiceGara,
            tessera_atleta: tessera,
            categoria: bowType,           // Bow type: CO/OL/AN
            classe: ageCategory,          // Age category: SM/SF/etc
            turno: isExpressInterest ? 0 : parseInt(turn),
            stato: 'in attesa',
            note: isExpressInterest ? 
                `Interesse espresso (invito non pubblicato). ${notes}` : 
                notes
        };
        
        // Add to subscriptions array
        if (!userSubscriptions.has(codiceGara)) {
            userSubscriptions.set(codiceGara, []);
        }
        userSubscriptions.get(codiceGara).push(subscription);
        
        closeSubscriptionModal();
        showNotification(window.translations.competitions?.subscription_success || 'Successfully subscribed!', 'success');
        filterCompetitions(currentFilter);
    } catch (error) {
        console.error('Error subscribing:', error);
        showNotification(error.message || window.translations.competitions?.subscription_error || 'Failed to subscribe', 'error');
    }
}

function showDeleteSubscriptionModal(subscriptions, competition) {
    // For single subscription, delete directly
    if (subscriptions.length === 1 && subscriptions[0].stato !== 'cancellato') {
        deleteSubscription(subscriptions[0], competition);
        return;
    }
    
    // For multiple subscriptions, show a simple list in a confirm dialog
    const activeSubs = subscriptions.filter(s => s.stato !== 'cancellato');
    if (activeSubs.length === 0) return;
    
    if (activeSubs.length === 1) {
        deleteSubscription(activeSubs[0], competition);
        return;
    }
    
    // Build message with athlete names
    const athleteNames = activeSubs.map(sub => {
        const athlete = authorizedAthletes.find(a => a.tessera === sub.tessera_atleta);
        return athlete ? athlete.display : sub.tessera_atleta;
    }).join(', ');
    
    const confirmMsg = `Hai ${activeSubs.length} iscrizioni per questa gara (${athleteNames}). Vuoi eliminarle tutte?`;
    
    if (confirm(confirmMsg)) {
        // Delete all subscriptions
        Promise.all(activeSubs.map(sub => deleteSubscriptionInternal(sub.id)))
            .then(() => {
                // Remove all from local cache
                userSubscriptions.delete(competition.codice);
                showNotification('Iscrizioni eliminate con successo', 'success');
                filterCompetitions(currentFilter);
            })
            .catch(error => {
                console.error('Error deleting subscriptions:', error);
                showNotification('Errore durante l\'eliminazione delle iscrizioni', 'error');
            });
    }
}

async function deleteSubscriptionInternal(subscriptionId) {
    const response = await fetch(`/archery/api/iscrizioni/${subscriptionId}`, {
        method: 'DELETE'
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Delete failed');
    }
    
    return response.json();
}

async function deleteSubscription(subscription, competition) {
    // Confirm before deleting
    const confirmMsg = window.translations.competitions?.confirm_delete || 
        `Are you sure you want to delete your subscription to ${competition.nome}?`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await fetch(`/archery/api/iscrizioni/${subscription.id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Delete failed');
        }
        
        // Remove from local cache
        userSubscriptions.delete(competition.codice);
        
        showNotification(window.translations.competitions?.delete_success || 'Subscription deleted successfully', 'success');
        
        // Refresh the competition list
        filterCompetitions(currentFilter);
    } catch (error) {
        console.error('Error deleting subscription:', error);
        showNotification(error.message || window.translations.competitions?.delete_error || 'Failed to delete subscription', 'error');
    }
}

function showCompetitionDetails(competition) {
    // TODO: Implement details modal or redirect to details page
    console.log('Show details for:', competition);
    showNotification('Competition details coming soon', 'info');
}

function formatDate(dateStr) {
    if (!dateStr) return 'TBA';
    const date = new Date(dateStr);
    const locale = window.translations._lang === 'it' ? 'it-IT' : 'en-US';
    
    if (locale === 'it-IT') {
        // Italian format: 17-Ott-2025
        const day = date.getDate();
        const monthShort = date.toLocaleDateString('it-IT', { month: 'short' });
        const year = date.getFullYear();
        return `${day}-${monthShort.charAt(0).toUpperCase() + monthShort.slice(1)}-${year}`;
    }
    
    return date.toLocaleDateString(locale, {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function formatDateRange(startStr, endStr) {
    if (!startStr) return 'TBA';
    const start = new Date(startStr);
    const end = endStr ? new Date(endStr) : null;
    
    const locale = window.translations._lang === 'it' ? 'it-IT' : 'en-US';
    
    if (locale === 'it-IT') {
        // Italian format: 17-Ott or 17-18 Ott or 17 Ott - 20 Nov
        const startDay = start.getDate();
        const startMonthShort = start.toLocaleDateString('it-IT', { month: 'short' });
        const startMonth = startMonthShort.charAt(0).toUpperCase() + startMonthShort.slice(1);
        
        if (end && end.getTime() !== start.getTime()) {
            const endDay = end.getDate();
            const endMonthShort = end.toLocaleDateString('it-IT', { month: 'short' });
            const endMonth = endMonthShort.charAt(0).toUpperCase() + endMonthShort.slice(1);
            
            if (start.getMonth() === end.getMonth()) {
                // Same month: 17-18 Ott
                return `${startDay}-${endDay} ${startMonth}`;
            } else {
                // Different months: 28 Ott - 2 Nov
                return `${startDay} ${startMonth} - ${endDay} ${endMonth}`;
            }
        }
        
        return `${startDay} ${startMonth}`;
    }
    
    // English format
    const startFormatted = start.toLocaleDateString(locale, { month: 'short', day: 'numeric' });
    
    if (end && end.getTime() !== start.getTime()) {
        const endFormatted = end.toLocaleDateString(locale, { month: 'short', day: 'numeric', year: 'numeric' });
        return `${startFormatted} - ${endFormatted}`;
    }
    
    return start.toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' });
}

function showLoading(show) {
    console.log('showLoading called with:', show);
    const loading = document.getElementById('loading');
    const grid = document.getElementById('competitions-grid');
    const emptyState = document.getElementById('empty-state');
    
    if (show) {
        loading.classList.remove('hidden');
        grid.classList.add('hidden');
        emptyState.classList.add('hidden');
        console.log('Spinner shown');
    } else {
        loading.classList.add('hidden');
        grid.classList.remove('hidden');
        console.log('Spinner hidden, grid shown');
    }
}

function showError(message) {
    showNotification(message, 'error');
    document.getElementById('empty-state').classList.remove('hidden');
}
</script>

{% endblock %}
