{% extends "base.html" %}

{% block title %}{{ t('archery.competitions') }} - {{ super() }}{% endblock %}

{% block content %}
<section class="py-12 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto p        if (authAthletesResp.ok) {
            const authData = await authAthletesResp.json();
            authorizedAthletes = authData.authorized_athletes || [];
        }
        
        // Load competitions from Flask proxy (which calls FastAPI with auth)
        const gareResp = await fetch(`/archery/api/gare?future=true&limit=100`);-7xl">
        <!-- Header -->
        <div class="mb-8">
            <a href="{{ url_for('archery.index') }}" 
               class="inline-flex items-center text-primary hover:text-primary-dark mb-4 transition">
                <i class="fas fa-arrow-left mr-2"></i>{{ t('common.back') }}
            </a>
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">{{ t('archery.competitions') }}</h1>
            <p class="text-gray-600 dark:text-gray-400">{{ t('archery.competitions_subtitle') }}</p>
        </div>

        <!-- Filter Tabs -->
        <div class="mb-6">
            <div class="border-b border-gray-300 dark:border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button onclick="filterCompetitions('upcoming')" 
                            id="tab-upcoming"
                            class="tab-button active px-4 py-2 font-medium text-sm border-b-2 border-primary text-primary">
                        {{ t('competitions.upcoming') }}
                    </button>
                    <button onclick="filterCompetitions('open')" 
                            id="tab-open"
                            class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary hover:border-gray-300">
                        {{ t('competitions.open_subscriptions') }}
                    </button>
                    <button onclick="filterCompetitions('my')" 
                            id="tab-my"
                            class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary hover:border-gray-300">
                        {{ t('competitions.my_subscriptions') }}
                    </button>
                    <button onclick="filterCompetitions('interested')" 
                            id="tab-interested"
                            class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-primary hover:border-gray-300">
                        <i class="fas fa-star mr-1"></i>Le mie espressioni di interesse
                    </button>
                </nav>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
        </div>

        <!-- Competitions Container -->
        <div id="competitions-container" class="hidden">
            <!-- Desktop Table -->
            <div class="hidden md:block overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow">
                <table id="competitions-table" class="w-full">
                    <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase w-32">Stato</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase">Gara</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase w-56">Data/Luogo</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase w-24">Status</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase w-32">Azione</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase w-16">Info</th>
                        </tr>
                    </thead>
                    <tbody id="competitions-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile Cards -->
            <div id="competitions-mobile" class="md:hidden space-y-3">
                <!-- Cards will be populated by JavaScript -->
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <i class="fas fa-calendar-times text-6xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 dark:text-gray-400 text-lg">{{ t('competitions.no_competitions') }}</p>
        </div>
    </div>
</section>

<!-- Competition Template (used for both desktop rows and mobile cards) -->
<template id="competition-card-template">
    <!-- Data will be stored here and used to render both desktop and mobile versions -->
</template>

<!-- Subscription Modal -->
<div id="subscription-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="closeSubscriptionModal()"></div>

        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4" id="modal-title">
                            Iscriviti alla Gara
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="modal-competition-info"></p>
                            
                            <form id="subscription-form">
                                <input type="hidden" id="competition-id" name="competition_id">
                                
                                <!-- Athlete Selection -->
                                <div class="mb-4">
                                    <label for="selected-athlete" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Seleziona Atleta
                                    </label>
                                    <div id="athlete-select-container">
                                        <!-- Populated by JavaScript -->
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="age-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Categoria di Età
                                    </label>
                                    <select id="age-category" name="age_category" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Seleziona categoria...</option>
                                        <option value="GM">GM - Giovanissimi Maschile</option>
                                        <option value="GF">GF - Giovanissimi Femminile</option>
                                        <option value="RM">RM - Ragazzi Maschile</option>
                                        <option value="RF">RF - Ragazzi Femminile</option>
                                        <option value="AM">AM - Allievi Maschile</option>
                                        <option value="AF">AF - Allievi Femminile</option>
                                        <option value="JM">JM - Junior Maschile</option>
                                        <option value="JF">JF - Junior Femminile</option>
                                        <option value="SM">SM - Senior Maschile</option>
                                        <option value="SF">SF - Senior Femminile</option>
                                        <option value="MM">MM - Master Maschile</option>
                                        <option value="MF">MF - Master Femminile</option>
                                    </select>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                        <i class="fas fa-info-circle mr-1"></i>Categoria determinata dall'età dell'atleta
                                    </p>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="bow-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Tipo di Arco
                                    </label>
                                    <select id="bow-type" name="bow_type" required
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Seleziona arco...</option>
                                        <option value="CO">CO - Compound</option>
                                        <option value="OL">OL - Olympic Recurve</option>
                                        <option value="AN">AN - Barebow</option>
                                    </select>
                                </div>
                                
                                <!-- Tripla Toggle (only for OL division) -->
                                <div id="tripla-container" class="hidden mb-4">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" id="sub-tripla"
                                               class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                        <div>
                                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Tripla (3-spot target)</span>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Disponibile solo per Olimpico (OL)</p>
                                        </div>
                                    </label>
                                </div>
                                
                                <div id="turn-selection-container" class="mb-4">
                                    <label for="turn" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Seleziona Turno
                                    </label>
                                    <select id="turn" name="turn" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Scegli turno...</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Note (Opzionale)
                                    </label>
                                    <textarea id="notes" name="notes" rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                              placeholder="Aggiungi note o preferenze..."></textarea>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="modal-submit-btn" onclick="submitSubscription()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark sm:ml-3 sm:w-auto sm:text-sm">
                    Conferma Iscrizione
                </button>
                <button type="button" onclick="closeSubscriptionModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 sm:mt-0 sm:w-auto sm:text-sm">
                    Annulla
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Subscription Modal -->
<div id="delete-subscription-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity"></div>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-trash text-red-600 dark:text-red-400"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="delete-modal-title">
                            Elimina Iscrizioni
                        </h3>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4" id="delete-modal-competition-info">
                                Seleziona le iscrizioni da eliminare:
                            </p>
                            <div id="delete-subscriptions-list" class="space-y-2">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="confirmDeleteSelected()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="fas fa-trash mr-2"></i>Elimina Selezionate
                </button>
                <button type="button" onclick="closeDeleteModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 sm:mt-0 sm:w-auto sm:text-sm">
                    Annulla
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Selection Modal for Edit -->
<div id="selection-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeSelectionModal()"></div>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 id="selection-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-edit mr-2"></i>Seleziona quale modificare
                        </h3>
                        
                        <div id="selection-list" class="space-y-2 max-h-96 overflow-y-auto">
                            <!-- Items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="closeSelectionModal()"
                        class="w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 sm:w-auto sm:text-sm">
                    Annulla
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Subscription Modal (User) -->
<div id="edit-user-subscription-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeEditUserSubscriptionModal()"></div>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-edit mr-2"></i>Richiedi Modifica Iscrizione
                        </h3>
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-4">
                            <p class="text-sm text-blue-800 dark:text-blue-300">
                                <i class="fas fa-info-circle mr-2"></i>Le modifiche richieste saranno revisionate dall'amministratore
                            </p>
                        </div>
                        
                        <form id="edit-user-subscription-form">
                            <input type="hidden" id="edit-user-sub-id">
                            <input type="hidden" id="edit-user-sub-original-categoria">
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Atleta</label>
                                <input type="text" id="edit-user-sub-athlete" readonly
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            
                            <div class="mb-4">
                                <label for="edit-user-sub-turno" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno</label>
                                <select id="edit-user-sub-turno" required
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="edit-user-sub-categoria" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Categoria di Età
                                </label>
                                <select id="edit-user-sub-categoria" required
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <!-- Populated dynamically based on validation rules -->
                                </select>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <i class="fas fa-info-circle mr-1"></i>Solo categorie valide per il tuo livello corrente
                                </p>
                            </div>
                            
                            <div class="mb-4">
                                <label for="edit-user-sub-classe" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Tipo di Arco
                                </label>
                                <select id="edit-user-sub-classe" required
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="CO">CO - Compound</option>
                                    <option value="OL">OL - Olympic Recurve</option>
                                    <option value="AN">AN - Barebow</option>
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="edit-user-sub-note" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Note Aggiuntive (Opzionale)
                                </label>
                                <textarea id="edit-user-sub-note" rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                          placeholder="Aggiungi note alla richiesta di modifica..."></textarea>
                            </div>
                            
                            <!-- Tripla Toggle (only for OL division) -->
                            <div id="edit-user-tripla-container" class="hidden mb-4">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="edit-user-sub-tripla"
                                           class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                    <div>
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Tripla (3-spot target)</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Disponibile solo per Olimpico (OL)</p>
                                    </div>
                                </label>
                            </div>
                            
                            <div id="edit-user-sub-changes-preview" class="hidden mb-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3">
                                <p class="text-sm font-medium text-yellow-800 dark:text-yellow-300 mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Modifiche richieste:
                                </p>
                                <ul id="edit-user-sub-changes-list" class="text-sm text-yellow-700 dark:text-yellow-400 list-disc list-inside">
                                    <!-- Changes will be listed here -->
                                </ul>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitUserSubscriptionEdit()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="fas fa-paper-plane mr-2"></i>Invia Richiesta
                </button>
                <button type="button" onclick="closeEditUserSubscriptionModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 sm:mt-0 sm:w-auto sm:text-sm">
                    Annulla
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Interest Modal (User) -->
<div id="edit-user-interest-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeEditUserInterestModal()"></div>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-edit mr-2"></i>Modifica Espressione di Interesse
                        </h3>
                        
                        <form id="edit-user-interest-form">
                            <input type="hidden" id="edit-user-int-id">
                            <input type="hidden" id="edit-user-int-original-categoria">
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Atleta</label>
                                <input type="text" id="edit-user-int-athlete" readonly
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            
                            <div class="mb-4">
                                <label for="edit-user-int-categoria" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Categoria di Età
                                </label>
                                <select id="edit-user-int-categoria" required
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <!-- Populated dynamically based on validation rules -->
                                </select>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <i class="fas fa-info-circle mr-1"></i>Solo categorie valide per il tuo livello corrente
                                </p>
                            </div>
                            
                            <div class="mb-4">
                                <label for="edit-user-int-classe" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Tipo di Arco
                                </label>
                                <select id="edit-user-int-classe" required
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="CO">CO - Compound</option>
                                    <option value="OL">OL - Olympic Recurve</option>
                                    <option value="AN">AN - Barebow</option>
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="edit-user-int-note" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Note (Opzionale)
                                </label>
                                <textarea id="edit-user-int-note" rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitUserInterestEdit()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="fas fa-save mr-2"></i>Salva Modifiche
                </button>
                <button type="button" onclick="closeEditUserInterestModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 sm:mt-0 sm:w-auto sm:text-sm">
                    Annulla
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Competition Invite Modal -->
<div id="invite-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeInviteModal()"></div>
        
        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <!-- Header -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-file-alt text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white" id="invite-modal-title">
                                Invito Gara
                            </h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400" id="invite-modal-subtitle"></p>
                        </div>
                    </div>
                    <button onclick="closeInviteModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Loading State -->
                <div id="invite-loading" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-600 dark:text-blue-400 mb-2"></i>
                    <p class="text-gray-600 dark:text-gray-400">Caricamento invito...</p>
                </div>

                <!-- Error State -->
                <div id="invite-error" class="hidden text-center py-8">
                    <i class="fas fa-exclamation-circle text-3xl text-red-600 dark:text-red-400 mb-2"></i>
                    <p class="text-gray-600 dark:text-gray-400" id="invite-error-message"></p>
                </div>

                <!-- Content -->
                <div id="invite-content" class="hidden">
                    <!-- Competition Info Card -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-600 rounded-lg p-4 mb-6 border border-blue-200 dark:border-gray-600">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <div class="text-xs font-semibold text-blue-700 dark:text-blue-300 uppercase mb-1">Date Gara</div>
                                <div class="text-sm font-medium text-gray-900 dark:text-white" id="invite-dates"></div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-blue-700 dark:text-blue-300 uppercase mb-1">Iscrizioni</div>
                                <div class="text-sm font-medium text-gray-900 dark:text-white" id="invite-registration-dates"></div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-blue-700 dark:text-blue-300 uppercase mb-1">Turni Disponibili</div>
                                <div class="text-sm font-medium text-gray-900 dark:text-white" id="invite-turns"></div>
                            </div>
                        </div>
                        <div id="invite-youth-only" class="hidden mt-3 pt-3 border-t border-blue-300 dark:border-gray-500">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">
                                <i class="fas fa-child mr-1"></i> Solo Giovanile
                            </span>
                        </div>
                    </div>

                    <!-- Invite HTML Content -->
                    <div class="prose prose-sm dark:prose-invert max-w-none bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 p-6 max-h-96 overflow-y-auto" id="invite-html-content" style="white-space: pre-wrap;">
                        <!-- Dynamic HTML content will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="closeInviteModal()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="fas fa-check mr-2"></i> Chiudi
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Configuration - Use Flask proxy endpoints (no direct API calls)
// All API calls go through Flask backend which handles Cloudflare Access

// IMPORTANT: Field naming inconsistency between tables:
// - authorized_athletes table: categoria=age_category (SM/SF/etc), classe=bow_type (CO/OL/AN)
// - ARC_iscrizioni table: categoria=bow_type (CO/OL/AN), classe=age_category (SM/SF/etc)
// They are REVERSED! This is why we read athlete.categoria but submit it as classe to iscrizioni API.

let currentFilter = 'upcoming';
let allCompetitions = [];
let allInviti = {};  // Invitation details mapped by codice_gara
let allTurni = {};   // Turns mapped by codice_gara
let allSocieta = {};  // Organizations mapped by codice_societa
let userSubscriptions = new Map();  // Map of codice_gara -> array of subscription objects
let userInterests = new Map();  // Map of codice_gara -> array of interest expressions
let authorizedAthletes = [];  // User's authorized athletes from website

// Interest expressions are now stored in ARC_interesse table (separate from subscriptions)

// Load competitions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadInitialData();
});

async function loadInitialData() {
    console.log('Loading initial data...');
    showLoading(true);
    
    try {
        // Load authorized athletes from website
        const authAthletesResp = await fetch('/api/user/authorized-athletes');
        if (authAthletesResp.ok) {
            const authData = await authAthletesResp.json();
            authorizedAthletes = authData.authorized_athletes || [];
        }
        console.log('Loaded athletes:', authorizedAthletes.length);
        
        // Load competitions from Flask proxy (which calls FastAPI with auth)
        // Use future=true to only get future competitions (better performance)
        const gareResp = await fetch(`/archery/api/gare?future=true&limit=1000`);
        if (!gareResp.ok) throw new Error('Failed to load competitions');
        
        allCompetitions = await gareResp.json();
        console.log('Loaded competitions:', allCompetitions.length);
        console.log('Sample competition:', allCompetitions[0]);
        console.log('Competitions by societa_codice:', allCompetitions.reduce((acc, c) => {
            const prefix = c.societa_codice ? c.societa_codice.substring(0, 2) : 'null';
            acc[prefix] = (acc[prefix] || 0) + 1;
            return acc;
        }, {}));
        
        // Use mass export for faster loading
        await Promise.all([
            loadInvitiMassExport(),
            loadUserSubscriptionsMassExport(),
            loadUserInterestsMassExport(),
            loadSocietaMassExport()
        ]);
        console.log('Loaded inviti, subscriptions, interests, and societies via mass export');
        console.log('Total inviti:', Object.keys(allInviti).length);
        console.log('Competitions without invites:', allCompetitions.filter(c => !allInviti[c.codice]).length);
        if (allCompetitions.length > 0) {
            const withoutInvites = allCompetitions.filter(c => !allInviti[c.codice]);
            if (withoutInvites.length > 0) {
                console.log('Sample competitions without invites:', withoutInvites.slice(0, 5).map(c => ({
                    codice: c.codice,
                    nome: c.nome,
                    data_inizio: c.data_inizio,
                    societa_codice: c.societa_codice
                })));
            }
        }
        
        console.log('Filtering competitions with filter:', currentFilter);
        filterCompetitions(currentFilter);
        console.log('Filter complete');
    } catch (error) {
        console.error('Error loading data:', error);
        showError('Failed to load competitions');
    } finally {
        // Always hide loading spinner
        console.log('Hiding spinner');
        showLoading(false);
    }
}

async function loadInvitiMassExport() {
    // Load ALL invites data from API in one request using mass export
    console.log('loadInvitiMassExport: Starting...');
    try {
        const resp = await fetch(`/archery/api/inviti?export=full`);
        console.log('loadInvitiMassExport: Fetch complete, status:', resp.status);
        if (resp.ok) {
            const inviti = await resp.json();
            console.log('loadInviti: Got', inviti.length, 'invites');
            // Map invites by codice for fast lookup
            inviti.forEach(invito => {
                allInviti[invito.codice] = invito;
                console.log(`  Mapped invite: ${invito.codice} -> apertura:${invito.data_apertura_iscrizioni}, chiusura:${invito.data_chiusura_iscrizioni}`);
            });
        } else {
            console.warn('loadInvitiMassExport: Response not OK:', resp.status);
        }
    } catch (error) {
        console.error('Error loading inviti:', error);
    }
    console.log('loadInvitiMassExport: Complete. Total mapped:', Object.keys(allInviti).length);
}

async function loadSocietaMassExport() {
    // Load ALL organizations data from API
    console.log('loadSocietaMassExport: Starting...');
    try {
        const resp = await fetch(`/archery/api/societa?export=full`);
        console.log('loadSocietaMassExport: Fetch complete, status:', resp.status);
        if (resp.ok) {
            const societa = await resp.json();
            console.log('loadSocieta: Got', societa.length, 'organizations');
            // Map organizations by codice for fast lookup
            societa.forEach(org => {
                allSocieta[org.codice] = org;
            });
        } else {
            console.warn('loadSocietaMassExport: Response not OK:', resp.status);
        }
    } catch (error) {
        console.error('Error loading societa:', error);
    }
    console.log('loadSocietaMassExport: Complete. Total mapped:', Object.keys(allSocieta).length);
}

async function loadUserSubscriptionsMassExport() {
    if (authorizedAthletes.length === 0) return;
    
    console.log('loadUserSubscriptionsMassExport: Starting for', authorizedAthletes.length, 'athletes');
    try {
        // Use mass export to get ALL subscriptions in one request
        const resp = await fetch(`/archery/api/iscrizioni?export=full`);
        if (resp.ok) {
            const allSubscriptions = await resp.json();
            console.log('loadUserSubscriptionsMassExport: Received', allSubscriptions.length, 'total subscriptions');
            
            // Filter to only subscriptions for our authorized athletes
            const athleteTessere = new Set(authorizedAthletes.map(a => a.tessera));
            const userSubs = allSubscriptions.filter(sub => athleteTessere.has(sub.tessera_atleta));
            
            console.log('loadUserSubscriptionsMassExport: Filtered to', userSubs.length, 'subscriptions for our athletes');
            
            userSubs.forEach(sub => {
                // Store subscriptions as array per competition to support multiple athletes
                if (!userSubscriptions.has(sub.codice_gara)) {
                    userSubscriptions.set(sub.codice_gara, []);
                }
                userSubscriptions.get(sub.codice_gara).push(sub);
            });
        } else {
            console.warn('loadUserSubscriptionsMassExport: Response not OK:', resp.status);
        }
    } catch (error) {
        console.error('Error loading subscriptions via mass export:', error);
    }
    console.log('loadUserSubscriptionsMassExport: Complete. Subscriptions for', userSubscriptions.size, 'competitions');
}

async function loadUserInterestsMassExport() {
    if (authorizedAthletes.length === 0) return;
    
    console.log('loadUserInterestsMassExport: Starting for', authorizedAthletes.length, 'athletes');
    try {
        // Use mass export to get ALL interests in one request
        const resp = await fetch(`/archery/api/interesse?export=full`);
        if (resp.ok) {
            const allInterests = await resp.json();
            console.log('loadUserInterestsMassExport: Received', allInterests.length, 'total interests');
            
            // Filter to only interests for our authorized athletes
            const athleteTessere = new Set(authorizedAthletes.map(a => a.tessera));
            const userInts = allInterests.filter(int => athleteTessere.has(int.tessera_atleta));
            
            console.log('loadUserInterestsMassExport: Filtered to', userInts.length, 'interests for our athletes');
            
            userInts.forEach(interest => {
                // Store interests as array per competition to support multiple athletes
                if (!userInterests.has(interest.codice_gara)) {
                    userInterests.set(interest.codice_gara, []);
                }
                userInterests.get(interest.codice_gara).push(interest);
            });
        } else {
            console.warn('loadUserInterestsMassExport: Response not OK:', resp.status);
        }
    } catch (error) {
        console.error('Error loading interests via mass export:', error);
    }
    console.log('loadUserInterestsMassExport: Complete. Interests for', userInterests.size, 'competitions');
}

async function loadUserSubscriptions() {
    try {
        // DEPRECATED: Use loadUserSubscriptionsMassExport instead for better performance
        // Load subscriptions for all authorized athletes from Flask proxy
        for (const athlete of authorizedAthletes) {
            const resp = await fetch(`/archery/api/iscrizioni?tessera_atleta=${athlete.tessera}`);
            if (resp.ok) {
                const subscriptions = await resp.json();
                subscriptions.forEach(sub => {
                    // Store subscriptions as array per competition to support multiple athletes
                    if (!userSubscriptions.has(sub.codice_gara)) {
                        userSubscriptions.set(sub.codice_gara, []);
                    }
                    userSubscriptions.get(sub.codice_gara).push(sub);
                });
            }
        }
    } catch (error) {
        console.error('Error loading user subscriptions:', error);
    }
}

/**
 * Get competition status based on dates and invite data
 * Returns: {
 *   status: 'iscrizioni_chiuse'|'iscrizioni_aperte'|'in_arrivo'|'attesa_invito',
 *   canSubscribe: boolean,
 *   label: string,
 *   color: string (CSS classes)
 * }
 */
function getCompetitionStatus(competition) {
    // Parse dates in local timezone to avoid UTC conversion issues
    const now = new Date();
    now.setHours(0, 0, 0, 0); // Compare dates only, not times
    
    // Parse date strings as local dates (YYYY-MM-DD)
    const parseLocalDate = (dateStr) => {
        if (!dateStr) return null;
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day); // month is 0-indexed
        date.setHours(0, 0, 0, 0);
        return date;
    };
    
    const startDate = parseLocalDate(competition.data_inizio);
    
    const invito = allInviti[competition.codice];
    
    console.log(`Status for ${competition.codice} (${competition.nome}):`, {
        has_invito: !!invito,
        invito_data: invito,
        start_date: competition.data_inizio
    });
    
    // No invite associated = "attesa invito" (white)
    if (!invito) {
        return {
            status: 'attesa_invito',
            canSubscribe: false,
            canExpressInterest: true,
            label: window.translations.attesa_invito || 'Attesa invito',
            color: 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
        };
    }
    
    const aperturaDate = parseLocalDate(invito.data_apertura_iscrizioni);
    const chiusuraDate = parseLocalDate(invito.data_chiusura_iscrizioni);
    
    console.log(`  Dates: now=${now.toLocaleDateString()}, apertura=${aperturaDate?.toLocaleDateString()}, chiusura=${chiusuraDate?.toLocaleDateString()}, start=${startDate?.toLocaleDateString()}`);
    
    // Competition started OR subscription window closed = "iscrizioni chiuse" (red)
    if (startDate <= now || chiusuraDate < now) {
        console.log(`  → Status: CHIUSE (started=${startDate <= now}, closed=${chiusuraDate < now})`);
        return {
            status: 'iscrizioni_chiuse',
            canSubscribe: false,
            canExpressInterest: false,
            label: window.translations.iscrizioni_chiuse || 'Iscrizioni chiuse',
            color: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300'
        };
    }
    
    // Subscription window is currently open = "iscrizioni aperte" (green)
    if (now >= aperturaDate && now <= chiusuraDate && startDate > now) {
        console.log(`  → Status: APERTE`);
        return {
            status: 'iscrizioni_aperte',
            canSubscribe: true,
            canExpressInterest: false,
            label: window.translations.iscrizioni_aperte || 'Iscrizioni aperte',
            color: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
        };
    }
    
    // Subscription opens in the future = "in arrivo" (blue)
    if (aperturaDate > now && startDate > now) {
        console.log(`  → Status: IN ARRIVO`);
        return {
            status: 'in_arrivo',
            canSubscribe: true,  // Allow subscribing even if not yet open
            canExpressInterest: false,
            label: window.translations.in_arrivo || 'In arrivo',
            color: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300'
        };
    }
    
    // Fallback (shouldn't reach here)
    console.log(`  → Status: FALLBACK (attesa invito)`);
    return {
        status: 'attesa_invito',
        canSubscribe: false,
        canExpressInterest: true,
        label: 'Attesa invito',
        color: 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
    };
}

function filterCompetitions(filter) {
    currentFilter = filter;
    
    console.log('=== filterCompetitions called with:', filter);
    console.log('Total competitions:', allCompetitions.length);
    
    // Update tab styling
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-primary', 'text-primary');
        btn.classList.add('border-transparent', 'text-gray-600', 'dark:text-gray-400');
    });
    document.getElementById(`tab-${filter}`).classList.add('active', 'border-primary', 'text-primary');
    document.getElementById(`tab-${filter}`).classList.remove('border-transparent', 'text-gray-600', 'dark:text-gray-400');
    
    // Filter competitions based on selected tab
    let filtered = [];
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    
    console.log('Current date for filtering:', now.toISOString());
    
    switch(filter) {
        case 'upcoming':
            // Future competitions (not ended yet) - region 06 only
            console.log('Filtering for upcoming competitions...');
            filtered = allCompetitions.filter(c => {
                const endDate = new Date(c.data_fine);
                endDate.setHours(0, 0, 0, 0);
                const isUpcoming = endDate >= now;
                if (!isUpcoming) {
                    console.log(`  ${c.nome} (${c.codice}): PAST (end: ${c.data_fine})`);
                }
                return isUpcoming;
            });
            console.log('After date filter:', filtered.length);
            break;
        case 'open':
            // Competitions with OPEN subscription windows (today between apertura and chiusura dates)
            filtered = allCompetitions.filter(c => {
                const invito = allInviti[c.codice];
                if (!invito) return false;  // No invite = not open
                
                const aperturaDate = new Date(invito.data_apertura_iscrizioni);
                aperturaDate.setHours(0, 0, 0, 0);
                const chiusuraDate = new Date(invito.data_chiusura_iscrizioni);
                chiusuraDate.setHours(0, 0, 0, 0);
                const startDate = new Date(c.data_inizio);
                startDate.setHours(0, 0, 0, 0);
                
                // Open if: today is between apertura and chiusura, and competition hasn't started
                return now >= aperturaDate && now <= chiusuraDate && startDate > now;
            });
            break;
        case 'my':
            // User's subscriptions (actual subscriptions only)
            filtered = allCompetitions.filter(c => userSubscriptions.has(c.codice));
            break;
        case 'interested':
            // Competitions where user expressed interest
            filtered = allCompetitions.filter(c => userInterests.has(c.codice));
            break;
        default:
            // Default to upcoming
            filtered = allCompetitions.filter(c => {
                const endDate = new Date(c.data_fine);
                endDate.setHours(0, 0, 0, 0);
                return endDate >= now;
            });
            break;
    }
    
    // Filter by region 06 (Veneto) based on societa_codice
    // Show ALL region 06 competitions, including those WITHOUT published invites
    // Users can express interest in competitions without invites
    console.log('Before region filter:', filtered.length);
    const beforeRegionFilter = filtered.length;
    filtered = filtered.filter(c => c.societa_codice && c.societa_codice.startsWith('06'));
    console.log('After region 06 filter:', filtered.length);
    if (filtered.length === 0 && beforeRegionFilter > 0) {
        console.warn('ALL competitions filtered out by region filter!');
        console.log('Sample societa_codice values:', allCompetitions.slice(0, 5).map(c => ({
            nome: c.nome,
            societa_codice: c.societa_codice
        })));
    }
    
    console.log('Final filtered competitions:', filtered.length);
    renderCompetitions(filtered);
}

/**
 * Get subscription summary for a competition (handles multiple athletes)
 * Returns: { hasActiveSubscription, allCancelled, statusText, statusColor, primaryStatus, subscriptions }
 */
function getSubscriptionSummary(codiceGara) {
    if (!userSubscriptions.has(codiceGara)) {
        return { hasActiveSubscription: false, allCancelled: false, subscriptions: [] };
    }
    
    const subs = userSubscriptions.get(codiceGara);
    const activeSubs = subs.filter(s => s.stato !== 'cancellato');
    
    if (activeSubs.length === 0) {
        return { hasActiveSubscription: false, allCancelled: true, subscriptions: subs };
    }
    
    // Count by status
    const confirmed = activeSubs.filter(s => s.stato === 'confermato').length;
    const waiting = activeSubs.filter(s => s.stato === 'in attesa').length;
    const pending = activeSubs.filter(s => s.stato === 'richiesta_effettuata').length;
    
    // Determine primary status (priority: confirmed > waiting > pending)
    let primaryStatus, statusText, statusColor, statusIcon;
    if (confirmed > 0) {
        primaryStatus = 'confermato';
        statusIcon = 'fas fa-check-circle';
        statusColor = 'green';
        statusText = confirmed === 1 ? 'Iscritto' : `${confirmed} iscritti`;
    } else if (waiting > 0) {
        primaryStatus = 'in attesa';
        statusIcon = 'fas fa-clock';
        statusColor = 'yellow';
        statusText = waiting === 1 ? 'In attesa' : `${waiting} in attesa`;
    } else {
        primaryStatus = 'richiesta_effettuata';
        statusIcon = 'fas fa-paper-plane';
        statusColor = 'gray';
        statusText = pending === 1 ? 'Richiesta effettuata' : `${pending} richieste`;
    }
    
    return { 
        hasActiveSubscription: true, 
        allCancelled: false,
        primaryStatus, 
        statusText, 
        statusColor,
        statusIcon,
        subscriptions: subs,
        activeSubs,
        confirmed,
        waiting,
        pending
    };
}

function renderCompetitions(competitions) {
    const container = document.getElementById('competitions-container');
    const tableBody = document.getElementById('competitions-table-body');
    const mobileContainer = document.getElementById('competitions-mobile');
    const emptyState = document.getElementById('empty-state');
    
    // Clear both desktop and mobile containers
    if (tableBody) tableBody.innerHTML = '';
    if (mobileContainer) mobileContainer.innerHTML = '';
    
    if (competitions.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }
    
    container.classList.remove('hidden');
    emptyState.classList.add('hidden');
    
    competitions.forEach((competition, index) => {
        // Get competition status and subscription summary
        const competitionStatus = getCompetitionStatus(competition);
        const subSummary = getSubscriptionSummary(competition.codice);
        
        // Format date range
        const dateText = formatDateRange(competition.data_inizio, competition.data_fine);
        const locationText = competition.luogo || competition.societa_nome || competition.societa_codice || 'TBA';
        
        // Get organization name from loaded data
        const societa = allSocieta[competition.societa_codice];
        const organizerText = societa?.nome || competition.societa_codice || 'N/A';
        
        // Check for interests
        const hasExpressedInterest = userInterests.has(competition.codice) && 
            userInterests.get(competition.codice).some(i => i.stato === 'attivo');
        const activeInterests = hasExpressedInterest ? 
            userInterests.get(competition.codice).filter(i => i.stato === 'attivo') : [];
        
        // Filter out interests for athletes who are already subscribed
        const subscribedTessere = new Set(subSummary.subscriptions
            .filter(s => s.stato !== 'cancellato')
            .map(s => s.tessera_atleta));
        const unsubscribedInterests = activeInterests.filter(
            interest => !subscribedTessere.has(interest.tessera_atleta)
        );
        
        // ====== DESKTOP TABLE ROW ======
        if (tableBody) {
            const row = document.createElement('tr');
            row.className = 'competition-row border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer';
            row.dataset.competitionCode = competition.codice;
            row.onclick = (e) => toggleDetailsFromRow(row, e);
            
            row.innerHTML = `
                <td class="px-4 py-4">
                    <div class="flex items-center gap-2">
                        <i class="expand-icon fas fa-chevron-right text-sm text-gray-500 dark:text-gray-400 transition-transform"></i>
                        <span class="competition-badge px-2 py-1 rounded text-xs font-semibold whitespace-nowrap ${competitionStatus.color}">${competitionStatus.label}</span>
                    </div>
                </td>
                <td class="px-4 py-4">
                    <div class="text-base font-semibold text-gray-900 dark:text-white mb-1">${competition.nome}</div>
                    <div class="text-xs font-mono text-gray-500 dark:text-gray-400">${competition.codice}</div>
                </td>
                <td class="px-4 py-4">
                    <div class="flex items-center text-sm text-gray-700 dark:text-gray-300 mb-1">
                        <i class="fas fa-calendar mr-1 text-gray-400 text-xs"></i>
                        <span>${dateText}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400 mb-1">
                        <i class="fas fa-map-marker-alt mr-1 text-gray-400 text-xs"></i>
                        <span>${locationText}</span>
                    </div>
                    <div class="flex items-center text-xs text-gray-500 dark:text-gray-500">
                        <i class="fas fa-users mr-1 text-gray-400 text-xs"></i>
                        <span>${competition.societa_nome || competition.societa_codice || 'N/A'}</span>
                    </div>
                </td>
                <td class="px-4 py-4 text-center" onclick="event.stopPropagation()">
                    <div class="status-icons-cell"></div>
                </td>
                <td class="px-4 py-4 text-center" onclick="event.stopPropagation()">
                    <div class="action-cell"></div>
                </td>
                <td class="px-4 py-4 text-center">
                    ${competitionStatus.status !== 'attesa_invito' ? 
                        `<button class="btn-info text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition" title="Info" onclick="showCompetitionInfoById('${competition.codice}', event)">
                            <i class="fas fa-info-circle"></i>
                        </button>` : 
                        '<span class="text-gray-400">-</span>'}
                </td>
            `;
            
            // Populate status icons cell
            const statusCell = row.querySelector('.status-icons-cell');
            statusCell.innerHTML = renderStatusIcons(competition, competitionStatus, subSummary, unsubscribedInterests);
            
            // Populate action cell
            const actionCell = row.querySelector('.action-cell');
            actionCell.innerHTML = renderActionButton(competition, competitionStatus, subSummary);
            
            tableBody.appendChild(row);
            
            // Create expandable details row
            const detailsRow = document.createElement('tr');
            detailsRow.className = 'competition-details hidden border-b border-gray-200 dark:border-gray-700';
            detailsRow.dataset.competitionCode = competition.codice;
            
            detailsRow.innerHTML = `
                <td colspan="6" class="px-4 py-4 bg-gray-50 dark:bg-gray-800/50">
                    ${renderExpandedDetails(competition, competitionStatus, subSummary, unsubscribedInterests)}
                </td>
            `;
            
            tableBody.appendChild(detailsRow);
        }
        
        // ====== MOBILE CARD ======
        if (mobileContainer) {
            const card = document.createElement('div');
            card.className = 'competition-card-mobile bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden';
            card.dataset.competitionCode = competition.codice;
            
            card.innerHTML = `
                <div class="p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1 pr-2">
                            <div class="text-base font-semibold text-gray-900 dark:text-white mb-1">${competition.nome}</div>
                            <div class="text-xs font-mono text-gray-500 dark:text-gray-400 mb-2">${competition.codice}</div>
                            <div class="flex items-center text-sm text-gray-700 dark:text-gray-300 mb-1">
                                <i class="fas fa-calendar mr-1 text-gray-400 text-xs"></i>
                                <span>${dateText}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <i class="fas fa-map-marker-alt mr-1 text-gray-400 text-xs"></i>
                                <span>${locationText}</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="competition-badge px-2 py-1 rounded text-xs font-semibold whitespace-nowrap ${competitionStatus.color}">${competitionStatus.label}</span>
                            ${competitionStatus.status !== 'attesa_invito' ?
                                `<button class="text-blue-600 dark:text-blue-400 text-sm" onclick="showCompetitionInfoById('${competition.codice}', event)">
                                    <i class="fas fa-info-circle mr-1"></i>Info
                                </button>` : ''}
                        </div>
                    </div>
                    
                    ${renderMobileSubscriptionSection(competition, competitionStatus, subSummary)}
                    
                    <button class="w-full mt-3 text-sm text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-light transition flex items-center justify-center" onclick="toggleMobileDetails(this, event)">
                        <i class="fas fa-chevron-down mr-2"></i>
                        <span>Dettagli</span>
                    </button>
                    
                    <div class="mobile-details hidden mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                        ${renderExpandedDetails(competition, competitionStatus, subSummary, unsubscribedInterests)}
                    </div>
                </div>
            `;
            
            mobileContainer.appendChild(card);
        }
    });
}

// Helper function to render status icons (subscriptions + interests)
function renderStatusIcons(competition, status, subSummary, unsubscribedInterests) {
    const icons = [];
    
    // Show subscription status icon
    if (subSummary.hasActiveSubscription) {
        let icon = 'fa-check-circle';
        let color = subSummary.statusColor;
        if (subSummary.primaryStatus === 'in attesa') {
            icon = 'fa-hourglass-half';
        } else if (subSummary.primaryStatus === 'richiesta_effettuata') {
            icon = 'fa-paper-plane';
        }
        icons.push(`<div class="flex items-center gap-1" title="${subSummary.statusText}">
            <i class="fas ${icon} text-${color}-600"></i>
            <span class="text-xs font-medium text-${color}-800 dark:text-${color}-300">${subSummary.activeSubs.length}</span>
        </div>`);
    }
    
    // Show interest icon
    if (unsubscribedInterests.length > 0) {
        icons.push(`<div class="flex items-center gap-1" title="Interesse espresso">
            <i class="fas fa-star text-yellow-600"></i>
            <span class="text-xs font-medium text-yellow-800 dark:text-yellow-300">${unsubscribedInterests.length}</span>
        </div>`);
    }
    
    if (icons.length === 0) {
        return '<span class="text-gray-400">-</span>';
    }
    
    return `<div class="flex flex-col gap-1 items-center">${icons.join('')}</div>`;
}

// Helper function to render action button
function renderActionButton(competition, status, subSummary) {
    // Check if user can subscribe more athletes
    if (subSummary.hasActiveSubscription) {
        const canSubscribeMore = authorizedAthletes.length > 1 && 
                                  subSummary.activeSubs.length < authorizedAthletes.length &&
                                  status.canSubscribe;
        
        if (canSubscribeMore) {
            return `<button class="px-3 py-1 text-xs bg-primary hover:bg-primary-dark text-white rounded transition" onclick="openSubscriptionModalById('${competition.codice}', event)">
                <i class="fas fa-user-plus mr-1"></i>Aggiungi
            </button>`;
        }
        
        return '<span class="text-xs text-gray-500 dark:text-gray-400">-</span>';
    }
    
    // Show subscribe button
    let buttonHtml = '';
    if (status.canExpressInterest) {
        const hasInterest = userInterests.has(competition.codice) && 
            userInterests.get(competition.codice).some(i => i.stato === 'attivo');
        buttonHtml = `<button class="px-3 py-1 text-xs rounded transition ${hasInterest ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-yellow-500 hover:bg-yellow-600'} text-white" onclick="openSubscriptionModalById('${competition.codice}', event)">
            <i class="fas fa-star mr-1"></i>Interessa
        </button>`;
    } else if (status.canSubscribe) {
        buttonHtml = `<button class="px-3 py-1 text-xs bg-primary hover:bg-primary-dark text-white rounded transition" onclick="openSubscriptionModalById('${competition.codice}', event)">
            <i class="fas fa-user-plus mr-1"></i>Iscriviti
        </button>`;
    } else {
        buttonHtml = `<span class="text-xs text-gray-500 dark:text-gray-400">Chiuso</span>`;
    }
    
    return buttonHtml;
}

// Helper function to render mobile subscription section
function renderMobileSubscriptionSection(competition, status, subSummary) {
    if (subSummary.hasActiveSubscription) {
        // Determine icon based on primary status
        let icon = 'check-circle';
        if (subSummary.primaryStatus === 'in attesa') {
            icon = 'hourglass-half';
        } else if (subSummary.primaryStatus === 'richiesta_effettuata') {
            icon = 'paper-plane';
        }
        
        // Check if user can subscribe more athletes
        const canSubscribeMore = authorizedAthletes.length > 1 && 
                                  subSummary.activeSubs.length < authorizedAthletes.length &&
                                  status.canSubscribe;
        
        let html = `<div class="p-2 bg-${subSummary.statusColor}-50 dark:bg-${subSummary.statusColor}-900/20 border border-${subSummary.statusColor}-200 dark:border-${subSummary.statusColor}-800 rounded-lg mb-2">
            <div class="flex items-center text-sm">
                <i class="fas fa-${icon} text-${subSummary.statusColor}-600 mr-2"></i>
                <span class="font-medium text-${subSummary.statusColor}-800 dark:text-${subSummary.statusColor}-300">${subSummary.statusText}</span>
            </div>
        </div>`;
        
        if (canSubscribeMore) {
            html += `<button class="w-full px-4 py-2 text-sm bg-primary hover:bg-primary-dark text-white rounded transition mb-2" onclick="openSubscriptionModalById('${competition.codice}', event)">
                <i class="fas fa-user-plus mr-2"></i>Aggiungi atleta
            </button>`;
        }
        
        return html;
    }
    
    // Show subscribe button
    let buttonHtml = '';
    if (status.canExpressInterest) {
        const hasInterest = userInterests.has(competition.codice) && 
            userInterests.get(competition.codice).some(i => i.stato === 'attivo');
        buttonHtml = `<button class="w-full px-4 py-2 text-sm rounded transition ${hasInterest ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-yellow-500 hover:bg-yellow-600'} text-white" onclick="openSubscriptionModalById('${competition.codice}', event)">
            <i class="fas fa-star mr-2"></i>Mi interessa
        </button>`;
    } else if (status.canSubscribe) {
        buttonHtml = `<button class="w-full px-4 py-2 text-sm bg-primary hover:bg-primary-dark text-white rounded transition" onclick="openSubscriptionModalById('${competition.codice}', event)">
            <i class="fas fa-user-plus mr-2"></i>Iscriviti
        </button>`;
    } else {
        buttonHtml = `<button class="w-full px-4 py-2 text-sm bg-gray-400 text-white rounded cursor-not-allowed" disabled>
            Chiuso
        </button>`;
    }
    
    return buttonHtml;
}

// Helper function to render expanded details (both desktop and mobile)
function renderExpandedDetails(competition, status, subSummary, unsubscribedInterests) {
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">';
    
    // Left column - Competition info
    html += '<div class="space-y-2">';
    html += `<div class="flex items-start">
        <i class="fas fa-bullseye mr-2 mt-1 text-primary flex-shrink-0"></i>
        <div>
            <span class="font-medium text-gray-700 dark:text-gray-300">Tipo: </span>
            <span class="text-gray-600 dark:text-gray-400">${competition.tipo || 'N/A'}</span>
        </div>
    </div>`;
    
    // Get organization name from loaded data
    const societa = allSocieta[competition.societa_codice];
    let organizerDisplay = 'N/A';
    if (societa && societa.nome) {
        organizerDisplay = `${societa.nome} <span class="text-xs text-gray-500 dark:text-gray-400">(${competition.societa_codice})</span>`;
    } else if (competition.societa_codice) {
        organizerDisplay = competition.societa_codice;
    }
    
    html += `<div class="flex items-start">
        <i class="fas fa-users mr-2 mt-1 text-primary flex-shrink-0"></i>
        <div>
            <span class="font-medium text-gray-700 dark:text-gray-300">Organizzatore: </span>
            <span class="text-gray-600 dark:text-gray-400">${organizerDisplay}</span>
        </div>
    </div>`;
    
    // Deadline if available
    const invito = allInviti[competition.codice];
    if (invito && invito.data_chiusura_iscrizioni) {
        html += `<div class="flex items-start">
            <i class="fas fa-clock mr-2 mt-1 text-primary flex-shrink-0"></i>
            <div>
                <span class="font-medium text-gray-700 dark:text-gray-300">Scadenza: </span>
                <span class="text-gray-600 dark:text-gray-400">${formatDate(invito.data_chiusura_iscrizioni)}</span>
            </div>
        </div>`;
    }
    html += '</div>';
    
    // Right column - Subscription/Interest details
    html += '<div class="space-y-3">';
    
    // Show subscribed athletes
    if (subSummary.hasActiveSubscription) {
        html += `<div class="p-3 bg-white dark:bg-gray-700 border border-${subSummary.statusColor}-300 dark:border-${subSummary.statusColor}-700 rounded-lg">
            <div class="flex items-center text-sm mb-2">
                <i class="fas fa-check-circle mr-2 text-${subSummary.statusColor}-600"></i>
                <span class="font-medium text-gray-900 dark:text-white">${subSummary.statusText}</span>
            </div>
            <div class="space-y-1 text-xs">`;
        
        subSummary.activeSubs.forEach(sub => {
            const athlete = authorizedAthletes.find(a => a.tessera === sub.tessera_atleta);
            const athleteName = athlete ? athlete.display : sub.tessera_atleta;
            const hasTripla = sub.categoria === 'OL' && (sub.note || '').toLowerCase().includes('tripla');
            
            // Check if there's a user note (excluding auto-generated content)
            let hasUserNote = false;
            let userNote = '';
            if (sub.note) {
                userNote = sub.note;
                // Remove CAMBI RICHIESTI section
                if (userNote.includes('CAMBI RICHIESTI:')) {
                    const parts = userNote.split('CAMBI RICHIESTI:');
                    userNote = parts[0].trim();
                }
                // Remove 'tripla' mentions as they're system-generated
                userNote = userNote.replace(/\btripla\b/gi, '').trim();
                hasUserNote = userNote.length > 0;
            }
            
            // Build info line with turn, category, and class
            const infoItems = [];
            if (sub.turno) infoItems.push(`Turno ${sub.turno}`);
            if (sub.classe) infoItems.push(sub.classe);
            if (sub.categoria) infoItems.push(sub.categoria);
            const infoLine = infoItems.length > 0 ? infoItems.join(' • ') : '';
            
            html += `<div class="py-2 px-3 bg-gray-50 dark:bg-gray-800 rounded mb-2">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="font-medium text-gray-900 dark:text-white mb-1 flex items-center gap-2">
                            ${athleteName}
                            ${hasTripla ? '<span class="px-1.5 py-0.5 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded" title="3-spot">3⊙</span>' : ''}
                            ${hasUserNote ? `<i class="fas fa-sticky-note text-blue-500 text-sm" title="${userNote.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"></i>` : ''}
                        </div>
                        ${infoLine ? `<div class="text-xs text-gray-600 dark:text-gray-400">${infoLine}</div>` : ''}
                    </div>
                    <div class="flex items-center gap-2 ml-3">
                        <button class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition" onclick="editUserSubscription(${sub.id}, '${competition.codice}', event)" title="Modifica">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-gray-600 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition" onclick="deleteSubscriptionById(${sub.id}, '${competition.codice}', event)" title="Elimina">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        });
        
        html += '</div></div>';
    }
    
    // Show interested athletes
    if (unsubscribedInterests.length > 0) {
        html += `<div class="p-3 bg-white dark:bg-gray-700 border border-yellow-300 dark:border-yellow-700 rounded-lg">
            <div class="flex items-center text-sm mb-2">
                <i class="fas fa-star mr-2 text-yellow-600"></i>
                <span class="font-medium text-gray-900 dark:text-white">Interesse espresso</span>
            </div>
            <div class="space-y-1 text-xs">`;
        
        unsubscribedInterests.forEach(interest => {
            const athlete = authorizedAthletes.find(a => a.tessera === interest.tessera_atleta);
            const athleteName = athlete ? athlete.display : interest.tessera_atleta;
            const canConvert = status.canSubscribe;
            
            // Check if there's a user note
            const hasUserNote = interest.note && interest.note.trim().length > 0;
            const noteTooltip = hasUserNote ? interest.note.replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
            
            html += `<div class="flex items-center justify-between py-1 px-2 bg-gray-50 dark:bg-gray-800 rounded">
                <span class="text-gray-700 dark:text-gray-300 flex items-center gap-2">
                    ${athleteName}
                    ${hasUserNote ? `<i class="fas fa-sticky-note text-blue-500 text-sm" title="${noteTooltip}"></i>` : ''}
                </span>
                <div class="flex items-center gap-1">
                    ${canConvert ? `<button class="px-2 py-0.5 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded" onclick="convertInterestToSubscription(${interest.id}, '${competition.codice}', event)" title="Converti">
                        <i class="fas fa-exchange-alt"></i>
                    </button>` : ''}
                    <button class="text-gray-600 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400" onclick="deleteInterestById(${interest.id}, '${competition.codice}', event)" title="Rimuovi">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
        });
        
        html += '</div></div>';
    }
    
    html += '</div></div>';
    
    return html;
}

// Toggle functions for expand/collapse
function toggleDetailsFromRow(row, event) {
    // Don't toggle if clicking on buttons or links
    if (event.target.closest('button') || event.target.closest('a')) {
        return;
    }
    
    const code = row.dataset.competitionCode;
    const detailsRow = document.querySelector(`tr.competition-details[data-competition-code="${code}"]`);
    const icon = row.querySelector('.expand-icon');
    
    if (detailsRow.classList.contains('hidden')) {
        detailsRow.classList.remove('hidden');
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
        icon.style.transform = 'rotate(90deg)';
    } else {
        detailsRow.classList.add('hidden');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
        icon.style.transform = 'rotate(0deg)';
    }
}

function toggleMobileDetails(button, event) {
    event.stopPropagation();
    const card = button.closest('.competition-card-mobile');
    const details = card.querySelector('.mobile-details');
    const icon = button.querySelector('i');
    const text = button.querySelector('span');
    
    if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        text.textContent = 'Nascondi';
    } else {
        details.classList.add('hidden');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        text.textContent = 'Dettagli';
    }
}

// Helper functions to call existing modal functions
function openSubscriptionModalById(codiceGara, event) {
    event.stopPropagation();
    const competition = allCompetitions.find(c => c.codice === codiceGara);
    if (competition) openSubscriptionModal(competition);
}

function showCompetitionInfoById(codiceGara, event) {
    event.stopPropagation();
    const competition = allCompetitions.find(c => c.codice === codiceGara);
    if (competition) showCompetitionInfo(competition);
}

function deleteSubscriptionById(subId, codiceGara, event) {
    event.stopPropagation();
    const competition = allCompetitions.find(c => c.codice === codiceGara);
    const subscriptions = userSubscriptions.get(codiceGara) || [];
    const sub = subscriptions.find(s => s.id === subId);
    if (sub && competition) deleteSubscription(sub, competition);
}

function deleteInterestById(interestId, codiceGara, event) {
    event.stopPropagation();
    const competition = allCompetitions.find(c => c.codice === codiceGara);
    const interests = userInterests.get(codiceGara) || [];
    const interest = interests.find(i => i.id === interestId);
    if (interest && competition) deleteInterest(interest, competition);
}

async function openSubscriptionModal(competition) {
    // Get subscription summary to check who's already subscribed (NOT interested)
    const subSummary = getSubscriptionSummary(competition.codice);
    const subscribedAthletes = new Set(subSummary.subscriptions
        .filter(s => s.stato !== 'cancellato')
        .map(s => s.tessera_atleta));
    
    // Filter to only show athletes who aren't already subscribed (interests are allowed to be re-expressed)
    const availableAthletes = authorizedAthletes.filter(a => !subscribedAthletes.has(a.tessera));
    
    if (availableAthletes.length === 0) {
        showNotification('Tutti gli atleti sono già iscritti a questa gara', 'info');
        return;
    }
    
    // Populate modal with competition info
    document.getElementById('competition-id').value = competition.codice;
    document.getElementById('modal-competition-info').textContent = 
        `${competition.nome} - ${formatDate(competition.data_inizio)}`;
    
    // Load turns for this competition from Flask proxy
    try {
        const turnsResp = await fetch(`/archery/api/turni?codice_gara=${competition.codice}`);
        if (turnsResp.ok) {
            const turns = await turnsResp.json();
            
            console.log(`Turns for ${competition.codice}:`, turns);
            
            // Store turns for later use (e.g., in edit modal)
            allTurni[competition.codice] = turns;
            
            // Check if invite is published (has turns)
            if (!turns || turns.length === 0) {
                // No invite published - show "Express Interest" mode
                console.log(`No turns found for ${competition.codice} - showing express interest`);
                showExpressInterestMode(competition, availableAthletes);
                return;
            }
            
            // Has turns - show normal subscription mode
            console.log(`${turns.length} turns found for ${competition.codice} - showing normal subscription`);
            populateTurnsDropdown(turns);
            showNormalSubscriptionMode(competition, availableAthletes);
        } else {
            // API error - assume no invite, allow express interest
            console.log(`API error loading turns for ${competition.codice} - showing express interest`);
            showExpressInterestMode(competition, availableAthletes);
            return;
        }
    } catch (error) {
        console.error('Error loading turns:', error);
        showExpressInterestMode(competition, availableAthletes);
        return;
    }
}

function showNormalSubscriptionMode(competition, availableAthletes = null) {
    // Reset modal to normal subscription mode
    
    // Reset modal title
    document.getElementById('modal-title').textContent = 'Iscriviti alla Gara';
    
    // Show turn selection
    const turnContainer = document.getElementById('turn-selection-container');
    if (turnContainer) turnContainer.style.display = 'block';
    
    // Reset submit button text
    const submitBtn = document.getElementById('modal-submit-btn');
    if (submitBtn) {
        submitBtn.textContent = 'Conferma Iscrizione';
    }
    
    // Reset info message
    const infoEl = document.getElementById('modal-competition-info');
    infoEl.innerHTML = `<p class="text-gray-600 dark:text-gray-400">${competition.nome} - ${formatDate(competition.data_inizio)}</p>`;
    
    // Populate athlete dropdown (filter if provided)
    populateAthleteDropdown(availableAthletes);
    
    // Show modal
    document.getElementById('subscription-modal').classList.remove('hidden');
}

function showExpressInterestMode(competition, availableAthletes = null) {
    // Competition doesn't have published invite yet
    // Show modal with "Express Interest" instead of full subscription
    
    // Update modal title
    document.getElementById('modal-title').textContent = 'Esprimi Interesse';
    
    // Hide turn selection (no turns available)
    const turnContainer = document.getElementById('turn-selection-container');
    if (turnContainer) turnContainer.style.display = 'none';
    
    // Update submit button text
    const submitBtn = document.getElementById('modal-submit-btn');
    if (submitBtn) {
        submitBtn.textContent = 'Conferma Interesse';
    }
    
    // Add info message
    const infoEl = document.getElementById('modal-competition-info');
    infoEl.innerHTML = `
        <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg mb-4">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-yellow-600 dark:text-yellow-400 mt-0.5 mr-2"></i>
                <div class="text-sm text-yellow-800 dark:text-yellow-300">
                    <strong>Invito Non Ancora Pubblicato</strong><br>
                    L'invito ufficiale per questa gara non è ancora stato pubblicato. Puoi esprimere interesse e ti avviseremo quando le iscrizioni saranno aperte.
                </div>
            </div>
        </div>
        <p class="text-gray-600 dark:text-gray-400">${competition.nome} - ${formatDate(competition.data_inizio)}</p>
    `;
    
    // Filter out athletes who already expressed interest
    const interestedAthletes = userInterests.get(competition.codice) || [];
    const interestedTessere = new Set(interestedAthletes.filter(i => i.stato === 'attivo').map(i => i.tessera_atleta));
    const filteredAthletes = availableAthletes ? availableAthletes.filter(a => !interestedTessere.has(a.tessera)) : null;
    
    // Populate athlete dropdown with filtered list
    populateAthleteDropdown(filteredAthletes);
    
    // Show modal
    document.getElementById('subscription-modal').classList.remove('hidden');
}

function populateTurnsDropdown(turns) {
    const select = document.getElementById('turn');
    select.innerHTML = `<option value="">Scegli turno...</option>`;
    
    turns.forEach(turn => {
        const option = document.createElement('option');
        option.value = turn.numero_turno || turn.turno;
        // Build display text, only including non-null parts
        const parts = [];
        if (turn.giorno) parts.push(turn.giorno);
        if (turn.fase) parts.push(turn.fase);
        if (turn.ora_ritrovo) {
            // Format time - handle both string ("08:45:00") and number (seconds since midnight: 68400 = 19:30:00)
            let timeFormatted;
            if (typeof turn.ora_ritrovo === 'string') {
                timeFormatted = turn.ora_ritrovo.substring(0, 5);  // "08:45:00" -> "08:45"
            } else if (typeof turn.ora_ritrovo === 'number') {
                // Convert seconds since midnight to HH:MM format
                // Example: 68400 seconds = 19 hours * 3600 + 30 minutes * 60 = 19:30
                const hours = Math.floor(turn.ora_ritrovo / 3600);
                const minutes = Math.floor((turn.ora_ritrovo % 3600) / 60);
                timeFormatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            } else {
                timeFormatted = String(turn.ora_ritrovo);
            }
            parts.push(timeFormatted);
        }
        option.textContent = parts.length > 0 ? parts.join(' - ') : `Turno ${turn.numero_turno || turn.turno}`;
        select.appendChild(option);
    });
}

function populateAthleteDropdown(filteredAthletes = null) {
    const container = document.getElementById('athlete-select-container');
    const athletes = filteredAthletes || authorizedAthletes;
    
    console.log('populateAthleteDropdown: athletes=', athletes);
    
    if (athletes.length === 0) {
        container.innerHTML = '<p class="text-sm text-yellow-600 dark:text-yellow-400">No authorized athletes. Contact admin to add athletes to your account.</p>';
        return;
    }
    
    if (athletes.length === 1) {
        // Only one athlete - auto-select and hide dropdown, pre-fill form fields
        const athlete = athletes[0];
        console.log('Single athlete mode, pre-filling:', { categoria: athlete.categoria, classe: athlete.classe });
        container.innerHTML = `<input type="hidden" id="selected-athlete" value="${athlete.tessera}">
                              <p class="text-sm text-gray-600 dark:text-gray-400">Subscribing: ${athlete.display}</p>`;
        // Pre-fill age category and bow type from athlete data
        if (athlete.categoria) {
            const ageCategoryEl = document.getElementById('age-category');
            if (ageCategoryEl) {
                // Populate with valid categories only
                const validCategories = getValidCategoryChanges(athlete.categoria);
                const categoryNames = {
                    'GM': 'GM - Giovanissimi Maschile',
                    'GF': 'GF - Giovanissimi Femminile',
                    'RM': 'RM - Ragazzi Maschile',
                    'RF': 'RF - Ragazzi Femminile',
                    'AM': 'AM - Allievi Maschile',
                    'AF': 'AF - Allievi Femminile',
                    'JM': 'JM - Junior Maschile',
                    'JF': 'JF - Junior Femminile',
                    'SM': 'SM - Senior Maschile',
                    'SF': 'SF - Senior Femminile',
                    'MM': 'MM - Master Maschile',
                    'MF': 'MF - Master Femminile'
                };
                
                ageCategoryEl.innerHTML = '<option value="">Seleziona categoria...</option>' +
                    validCategories.map(cat => 
                        `<option value="${cat}" ${cat === athlete.categoria ? 'selected' : ''}>${categoryNames[cat] || cat}</option>`
                    ).join('');
                
                console.log('Set age-category options to valid categories:', validCategories);
            }
        }
        if (athlete.classe) {
            const bowTypeEl = document.getElementById('bow-type');
            if (bowTypeEl) {
                bowTypeEl.value = athlete.classe;
                console.log('Set bow-type to:', athlete.classe);
                // Trigger Tripla visibility check
                toggleTriplaVisibility(athlete.classe);
            }
        }
        return;
    }
    
    // Multiple athletes - show dropdown with theme matching
    const select = document.createElement('select');
    select.id = 'selected-athlete';
    select.className = 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary';
    
    select.innerHTML = '<option value="">Seleziona atleta...</option>';
    athletes.forEach(athlete => {
        const option = document.createElement('option');
        option.value = athlete.tessera;
        option.textContent = athlete.display;
        option.dataset.ageCategory = athlete.categoria || '';  // Changed from age_category to categoria
        option.dataset.bowType = athlete.classe || '';
        select.appendChild(option);
    });
    
    // Add event listener to pre-fill form when athlete is selected
    select.addEventListener('change', function(e) {
        const selectedOption = e.target.selectedOptions[0];
        if (selectedOption && selectedOption.value) {
            // Add listener for bow type changes to show/hide Tripla
            setTimeout(() => {
                const bowTypeSelect = document.getElementById('bow-type');
                if (bowTypeSelect) {
                    bowTypeSelect.addEventListener('change', function() {
                        toggleTriplaVisibility(this.value);
                    });
                    // Trigger initial check
                    toggleTriplaVisibility(bowTypeSelect.value);
                }
            }, 100);
            console.log('Athlete selected:', { 
                value: selectedOption.value, 
                ageCategory: selectedOption.dataset.ageCategory, 
                bowType: selectedOption.dataset.bowType 
            });
            // Pre-fill age category and bow type from selected athlete
            const ageCategoryEl = document.getElementById('age-category');
            const bowTypeEl = document.getElementById('bow-type');
            
            if (selectedOption.dataset.ageCategory && ageCategoryEl) {
                // Populate category dropdown with valid options based on athlete's current category
                const validCategories = getValidCategoryChanges(selectedOption.dataset.ageCategory);
                const categoryNames = {
                    'GM': 'GM - Giovanissimi Maschile',
                    'GF': 'GF - Giovanissimi Femminile',
                    'RM': 'RM - Ragazzi Maschile',
                    'RF': 'RF - Ragazzi Femminile',
                    'AM': 'AM - Allievi Maschile',
                    'AF': 'AF - Allievi Femminile',
                    'JM': 'JM - Junior Maschile',
                    'JF': 'JF - Junior Femminile',
                    'SM': 'SM - Senior Maschile',
                    'SF': 'SF - Senior Femminile',
                    'MM': 'MM - Master Maschile',
                    'MF': 'MF - Master Femminile'
                };
                
                ageCategoryEl.innerHTML = '<option value="">Seleziona categoria...</option>' +
                    validCategories.map(cat => 
                        `<option value="${cat}" ${cat === selectedOption.dataset.ageCategory ? 'selected' : ''}>${categoryNames[cat] || cat}</option>`
                    ).join('');
                
                console.log('Set age-category options to valid categories:', validCategories);
            }
            if (selectedOption.dataset.bowType && bowTypeEl) {
                bowTypeEl.value = selectedOption.dataset.bowType;
                console.log('Set bow-type to:', selectedOption.dataset.bowType);
                // Trigger Tripla visibility check
                toggleTriplaVisibility(selectedOption.dataset.bowType);
            }
        } else {
            // Reset fields if no athlete selected
            document.getElementById('age-category').innerHTML = `
                <option value="">Seleziona categoria...</option>
                <option value="GM">GM - Giovanissimi Maschile</option>
                <option value="GF">GF - Giovanissimi Femminile</option>
                <option value="RM">RM - Ragazzi Maschile</option>
                <option value="RF">RF - Ragazzi Femminile</option>
                <option value="AM">AM - Allievi Maschile</option>
                <option value="AF">AF - Allievi Femminile</option>
                <option value="JM">JM - Junior Maschile</option>
                <option value="JF">JF - Junior Femminile</option>
                <option value="SM">SM - Senior Maschile</option>
                <option value="SF">SF - Senior Femminile</option>
                <option value="MM">MM - Master Maschile</option>
                <option value="MF">MF - Master Femminile</option>
            `;
            document.getElementById('bow-type').value = '';
            // Hide Tripla when no athlete selected
            toggleTriplaVisibility('');
        }
    });
    
    // Add change listener to bow-type field for manual changes
    setTimeout(() => {
        const bowTypeEl = document.getElementById('bow-type');
        if (bowTypeEl) {
            bowTypeEl.addEventListener('change', function() {
                toggleTriplaVisibility(this.value);
            });
        }
    }, 100);
    
    container.innerHTML = '';
    container.appendChild(select);
}

function closeSubscriptionModal() {
    document.getElementById('subscription-modal').classList.add('hidden');
    document.getElementById('subscription-form').reset();
    // Reset tripla visibility
    toggleTriplaVisibility('');
}

async function submitSubscription() {
    const codiceGara = document.getElementById('competition-id').value;
    const turn = document.getElementById('turn').value;
    const tessera = document.getElementById('selected-athlete')?.value;
    const ageCategory = document.getElementById('age-category').value;
    const bowType = document.getElementById('bow-type').value;
    let notes = document.getElementById('notes').value;
    
    // Handle Tripla for OL division
    if (bowType === 'OL') {
        const triplaChecked = document.getElementById('sub-tripla').checked;
        notes = manageTriplaInNotes(notes, triplaChecked);
    }
    
    // Check if turn selection is visible (normal subscription) or hidden (express interest)
    const turnContainer = document.getElementById('turn-selection-container');
    const isExpressInterest = turnContainer && turnContainer.style.display === 'none';
    
    if (!isExpressInterest && !turn) {
        showNotification(window.translations.competitions?.select_turn_required || 'Seleziona un turno', 'warning');
        return;
    }
    
    if (!tessera) {
        showNotification('Seleziona un atleta', 'warning');
        return;
    }
    
    if (!ageCategory) {
        showNotification('Seleziona una categoria', 'warning');
        return;
    }
    
    if (!bowType) {
        showNotification('Seleziona un arco', 'warning');
        return;
    }
    
    try {
        // Submit to Flask proxy (which forwards to FastAPI with auth)
        // IMPORTANT: Field names are REVERSED between athlete data and iscrizioni API:
        // - From athlete: categoria=age_category, classe=bow_type
        // - To iscrizioni: categoria=bow_type, classe=age_category
        
        let response, result;
        
        if (isExpressInterest) {
            // Check for existing cancelled interest expression first
            const existingInterests = userInterests.get(codiceGara) || [];
            const cancelledInterest = existingInterests.find(int => 
                int.tessera_atleta === tessera && int.stato === 'cancellato'
            );
            
            if (cancelledInterest) {
                // Reactivate cancelled interest via PATCH
                console.log('Found cancelled interest, reactivating:', cancelledInterest.id);
                response = await fetch(`/archery/api/interesse/${cancelledInterest.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stato: 'in attesa',
                        categoria: bowType,         // Bow type: CO (Compound), OL (Olympic), AN (Barebow)
                        classe: ageCategory,        // Age category: SM, SF, MM, MF, etc.
                        note: notes
                    })
                });
            } else {
                // Use interesse API for interest expressions
                response = await fetch(`/archery/api/interesse`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codice_gara: codiceGara,
                        tessera_atleta: tessera,
                        categoria: bowType,             // Bow type: CO (Compound), OL (Olympic), AN (Barebow)
                        classe: ageCategory,            // Age category: SM, SF, MM, MF, etc.
                        note: notes
                    })
                });
            }
        } else {
            // Check for existing cancelled subscription first
            const existingSubscriptions = userSubscriptions.get(codiceGara) || [];
            const cancelledSubscription = existingSubscriptions.find(sub => 
                sub.tessera_atleta === tessera && sub.stato === 'cancellato'
            );
            
            if (cancelledSubscription) {
                // Reactivate cancelled subscription via PATCH
                console.log('Found cancelled subscription, reactivating:', cancelledSubscription.id);
                response = await fetch(`/archery/api/iscrizioni/${cancelledSubscription.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stato: 'in attesa',
                        categoria: bowType,         // Bow type: CO (Compound), OL (Olympic), AN (Barebow)
                        classe: ageCategory,        // Age category: SM, SF, MM, MF, GM, GF, RM, RF, AM, AF, JM, JF
                        turno: parseInt(turn),
                        note: notes
                    })
                });
            } else {
                // Use iscrizioni API for actual subscriptions
                response = await fetch(`/archery/api/iscrizioni`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codice_gara: codiceGara,
                        tessera_atleta: tessera,
                        categoria: bowType,             // Bow type: CO (Compound), OL (Olympic), AN (Barebow)
                        classe: ageCategory,            // Age category: SM, SF, MM, MF, GM, GF, RM, RF, AM, AF, JM, JF
                        turno: parseInt(turn),
                        stato: 'in attesa',  // Pending - admin must confirm manually
                        note: notes
                    })
                });
            }
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || (isExpressInterest ? 'Errore nell\'espressione di interesse' : 'Errore nell\'iscrizione'));
        }
        
        result = await response.json();
        console.log(isExpressInterest ? 'Interest response:' : 'Subscription response:', result);
        
        // Validate response has required id field
        if (!result || !result.id) {
            console.error('Invalid API response - missing id field:', result);
            throw new Error('Risposta del server non valida');
        }
        
        // Determine if this was a reactivation or new subscription
        const isReactivation = (response.url && (response.url.includes('/interesse/') || response.url.includes('/iscrizioni/'))) && 
                              !response.url.endsWith('/interesse') && !response.url.endsWith('/iscrizioni');
        
        if (isExpressInterest) {
            if (isReactivation) {
                // Update existing interest object in the map
                const interests = userInterests.get(codiceGara) || [];
                const existingIdx = interests.findIndex(int => int.id === result.id);
                if (existingIdx !== -1) {
                    interests[existingIdx] = {
                        ...interests[existingIdx],
                        categoria: bowType,
                        classe: ageCategory,
                        stato: 'attivo',
                        note: notes
                    };
                }
            } else {
                // Create interest object from response
                const interest = {
                    id: result.id,
                    codice_gara: codiceGara,
                    tessera_atleta: tessera,
                    categoria: bowType,
                    classe: ageCategory,
                    stato: 'attivo',
                    note: notes
                };
                
                // Add to interests array
                if (!userInterests.has(codiceGara)) {
                    userInterests.set(codiceGara, []);
                }
                userInterests.get(codiceGara).push(interest);
            }
        } else {
            if (isReactivation) {
                // Update existing subscription object in the map
                const subscriptions = userSubscriptions.get(codiceGara) || [];
                const existingIdx = subscriptions.findIndex(sub => sub.id === result.id);
                if (existingIdx !== -1) {
                    subscriptions[existingIdx] = {
                        ...subscriptions[existingIdx],
                        categoria: bowType,
                        classe: ageCategory,
                        turno: parseInt(turn),
                        stato: 'in attesa',
                        note: notes
                    };
                }
            } else {
                // Create subscription object from response
                const subscription = {
                    id: result.id,
                    codice_gara: codiceGara,
                    tessera_atleta: tessera,
                    categoria: bowType,
                    classe: ageCategory,
                    turno: parseInt(turn),
                    stato: 'in attesa',
                    note: notes
                };
                
                // Add to subscriptions array
                if (!userSubscriptions.has(codiceGara)) {
                    userSubscriptions.set(codiceGara, []);
                }
                userSubscriptions.get(codiceGara).push(subscription);
            }
        }
        
        closeSubscriptionModal();
        const successMessage = isReactivation ?
            (isExpressInterest ? 'Interesse riattivato con successo!' : 'Iscrizione riattivata con successo!') :
            (isExpressInterest ? 'Interesse espresso con successo!' : (window.translations.competitions?.subscription_success || 'Iscrizione effettuata con successo!'));
        showNotification(successMessage, 'success');
        filterCompetitions(currentFilter);
    } catch (error) {
        console.error('Error subscribing:', error);
        showNotification(error.message || window.translations.competitions?.subscription_error || 'Errore nell\'iscrizione', 'error');
    }
}

function showDeleteSubscriptionModal(subscriptions, competition) {
    const activeSubs = subscriptions.filter(s => s.stato !== 'cancellato');
    if (activeSubs.length === 0) return;
    
    // For single subscription, delete directly with simple confirm
    if (activeSubs.length === 1) {
        deleteSubscription(activeSubs[0], competition);
        return;
    }
    
    // For multiple subscriptions, show selection modal
    const modal = document.getElementById('delete-subscription-modal');
    const competitionInfo = document.getElementById('delete-modal-competition-info');
    const subscriptionsList = document.getElementById('delete-subscriptions-list');
    
    competitionInfo.textContent = `${competition.nome} - ${formatDate(competition.data_inizio)}`;
    
    // Build checkboxes for each subscription
    subscriptionsList.innerHTML = '';
    activeSubs.forEach(sub => {
        const athlete = authorizedAthletes.find(a => a.tessera === sub.tessera_atleta);
        const athleteName = athlete ? athlete.display : sub.tessera_atleta;
        
        // Status badge
        let statusBadge = '';
        if (sub.stato === 'confermato') {
            statusBadge = '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">Confermato</span>';
        } else if (sub.stato === 'in attesa') {
            statusBadge = '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300">In attesa</span>';
        } else if (sub.stato === 'cancellazione richiesta') {
            statusBadge = '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300">Cancellazione richiesta</span>';
        } else if (sub.stato === 'richiesta_effettuata') {
            statusBadge = '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300">Richiesta</span>';
        }
        
        // Check if tripla is in notes (for OL division)
        const hasTripla = sub.categoria === 'OL' && (sub.note || '').toLowerCase().includes('tripla');
        const triplaIcon = hasTripla ? '<span class="ml-1 px-1.5 py-0.5 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded" title="3-spot target">3⊙</span>' : '';
        
        const checkbox = document.createElement('label');
        checkbox.className = 'flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-750 cursor-pointer';
        checkbox.innerHTML = `
            <input type="checkbox" value="${sub.id}" class="subscription-delete-checkbox h-4 w-4 text-primary border-gray-300 dark:border-gray-600 rounded focus:ring-primary">
            <span class="ml-3 flex-1 text-sm text-gray-900 dark:text-white">
                ${athleteName}${statusBadge}
                <span class="block text-xs text-gray-500 dark:text-gray-400 mt-1">
                    ${sub.categoria || ''}${triplaIcon} - ${sub.classe || ''} - Turno ${sub.turno}
                </span>
            </span>
        `;
        subscriptionsList.appendChild(checkbox);
    });
    
    // Store competition reference for later
    modal.dataset.competitionCode = competition.codice;
    
    modal.classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('delete-subscription-modal').classList.add('hidden');
}

async function confirmDeleteSelected() {
    const modal = document.getElementById('delete-subscription-modal');
    const checkboxes = modal.querySelectorAll('.subscription-delete-checkbox:checked');
    const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (idsToDelete.length === 0) {
        showNotification('Seleziona almeno un\'iscrizione da eliminare', 'warning');
        return;
    }
    
    const competitionCode = modal.dataset.competitionCode;
    const subscriptions = userSubscriptions.get(competitionCode) || [];
    
    // Separate confirmed from non-confirmed subscriptions
    const confirmedIds = [];
    const nonConfirmedIds = [];
    
    idsToDelete.forEach(id => {
        const sub = subscriptions.find(s => s.id === id);
        if (sub && sub.stato === 'confermato') {
            confirmedIds.push(id);
        } else {
            nonConfirmedIds.push(id);
        }
    });
    
    try {
        // Delete non-confirmed subscriptions directly
        if (nonConfirmedIds.length > 0) {
            await Promise.all(nonConfirmedIds.map(id => deleteSubscriptionInternal(id)));
        }
        
        // Request cancellation for confirmed subscriptions
        if (confirmedIds.length > 0) {
            await Promise.all(confirmedIds.map(id => requestCancellationInternal(id)));
        }
        
        // Update local cache
        if (userSubscriptions.has(competitionCode)) {
            const subs = userSubscriptions.get(competitionCode);
            
            // Remove deleted (non-confirmed) subscriptions
            const remaining = subs.filter(sub => !nonConfirmedIds.includes(sub.id));
            
            // Update status for confirmed subscriptions
            confirmedIds.forEach(id => {
                const sub = remaining.find(s => s.id === id);
                if (sub) {
                    sub.stato = 'cancellazione richiesta';
                }
            });
            
            if (remaining.length > 0) {
                userSubscriptions.set(competitionCode, remaining);
            } else {
                userSubscriptions.delete(competitionCode);
            }
        }
        
        closeDeleteModal();
        
        // Show appropriate message
        if (confirmedIds.length > 0 && nonConfirmedIds.length > 0) {
            showNotification(
                `${nonConfirmedIds.length} iscrizioni eliminate, ${confirmedIds.length} richieste di cancellazione inviate`,
                'success'
            );
        } else if (confirmedIds.length > 0) {
            showNotification(
                confirmedIds.length === 1 ? 
                    'Richiesta di cancellazione inviata con successo' : 
                    `${confirmedIds.length} richieste di cancellazione inviate con successo`,
                'success'
            );
        } else {
            showNotification(
                nonConfirmedIds.length === 1 ? 
                    'Iscrizione eliminata con successo' : 
                    `${nonConfirmedIds.length} iscrizioni eliminate con successo`,
                'success'
            );
        }
        
        filterCompetitions(currentFilter);
    } catch (error) {
        console.error('Error deleting subscriptions:', error);
        showNotification('Errore durante l\'operazione: ' + error.message, 'error');
    }
}

async function deleteSubscriptionInternal(subscriptionId) {
    const response = await fetch(`/archery/api/iscrizioni/${subscriptionId}`, {
        method: 'DELETE'
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Delete failed');
    }
    
    return response.json();
}

async function requestCancellationInternal(subscriptionId) {
    const response = await fetch(`/archery/api/iscrizioni/${subscriptionId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ stato: 'cancellazione richiesta' })
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to request cancellation');
    }
    
    return response.json();
}

async function deleteSubscription(subscription, competition) {
    // Check if subscription is confirmed
    if (subscription.stato === 'confermato') {
        const confirmMsg = 'Questa iscrizione è confermata. Vuoi richiedere la cancellazione?';
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        try {
            await requestCancellationInternal(subscription.id);
            
            // Update local cache
            subscription.stato = 'cancellazione richiesta';
            
            showNotification('Richiesta di cancellazione inviata con successo', 'success');
            filterCompetitions(currentFilter);
        } catch (error) {
            console.error('Error requesting cancellation:', error);
            showNotification('Errore durante la richiesta di cancellazione: ' + error.message, 'error');
        }
        
        return;
    }
    
    // For non-confirmed subscriptions, delete directly
    const confirmMsg = window.translations.competitions?.confirm_delete || 
        `Are you sure you want to delete your subscription to ${competition.nome}?`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await fetch(`/archery/api/iscrizioni/${subscription.id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Delete failed');
        }
        
        // Remove from local cache - only remove the specific subscription, not all
        if (userSubscriptions.has(competition.codice)) {
            const remaining = userSubscriptions.get(competition.codice)
                .filter(s => s.id !== subscription.id);
            if (remaining.length > 0) {
                userSubscriptions.set(competition.codice, remaining);
            } else {
                userSubscriptions.delete(competition.codice);
            }
        }
        
        showNotification(window.translations.competitions?.delete_success || 'Subscription deleted successfully', 'success');
        
        // Refresh the competition list
        filterCompetitions(currentFilter);
    } catch (error) {
        console.error('Error deleting subscription:', error);
        showNotification(error.message || window.translations.competitions?.delete_error || 'Failed to delete subscription', 'error');
    }
}

// Interest deletion functions
function showDeleteInterestModal(interests, competition) {
    const activeInterests = interests.filter(i => i.stato === 'attivo');
    if (activeInterests.length === 0) return;
    
    // For single interest, delete directly with simple confirm
    if (activeInterests.length === 1) {
        deleteInterest(activeInterests[0], competition);
        return;
    }
    
    // For multiple interests, show selection modal (reuse subscription modal structure)
    const modal = document.getElementById('delete-subscription-modal');
    const competitionInfo = document.getElementById('delete-modal-competition-info');
    const subscriptionsList = document.getElementById('delete-subscriptions-list');
    
    // Change modal title
    const modalTitle = modal.querySelector('h2');
    if (modalTitle) modalTitle.textContent = 'Rimuovi Interesse';
    
    competitionInfo.textContent = `${competition.nome} - ${formatDate(competition.data_inizio)}`;
    
    // Build checkboxes for each interest
    subscriptionsList.innerHTML = '';
    activeInterests.forEach(interest => {
        const athlete = authorizedAthletes.find(a => a.tessera === interest.tessera_atleta);
        const athleteName = athlete ? athlete.display : interest.tessera_atleta;
        
        const checkbox = document.createElement('label');
        checkbox.className = 'flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer';
        checkbox.innerHTML = `
            <input type="checkbox" value="${interest.id}" class="interest-delete-checkbox h-4 w-4 text-primary border-gray-300 dark:border-gray-600 rounded focus:ring-primary">
            <span class="ml-3 flex-1 text-sm text-gray-900 dark:text-white">
                ${athleteName}
                <span class="block text-xs text-gray-500 dark:text-gray-400 mt-1">
                    ${interest.categoria || ''} - ${interest.classe || ''}
                    ${interest.note ? ' - ' + interest.note : ''}
                </span>
            </span>
        `;
        subscriptionsList.appendChild(checkbox);
    });
    
    // Store competition reference and mark as interest mode
    modal.dataset.competitionCode = competition.codice;
    modal.dataset.deleteMode = 'interest';
    
    // Update confirm button to call interest deletion
    const confirmBtn = modal.querySelector('button[onclick="confirmDeleteSelected()"]');
    if (confirmBtn) {
        confirmBtn.onclick = confirmDeleteSelectedInterests;
    }
    
    modal.classList.remove('hidden');
}

async function confirmDeleteSelectedInterests() {
    const modal = document.getElementById('delete-subscription-modal');
    const checkboxes = modal.querySelectorAll('.interest-delete-checkbox:checked');
    const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (idsToDelete.length === 0) {
        showNotification('Seleziona almeno un interesse da eliminare', 'warning');
        return;
    }
    
    const competitionCode = modal.dataset.competitionCode;
    
    try {
        // Delete all selected interests
        await Promise.all(idsToDelete.map(id => deleteInterestInternal(id)));
        
        // Update local cache - remove deleted interests
        if (userInterests.has(competitionCode)) {
            const remaining = userInterests.get(competitionCode)
                .filter(interest => !idsToDelete.includes(interest.id));
            if (remaining.length > 0) {
                userInterests.set(competitionCode, remaining);
            } else {
                userInterests.delete(competitionCode);
            }
        }
        
        closeDeleteModal();
        showNotification(
            idsToDelete.length === 1 ? 
                'Interesse rimosso con successo' : 
                `${idsToDelete.length} interessi rimossi con successo`,
            'success'
        );
        
        // Restore modal title and button for next use
        const modalTitle = modal.querySelector('h2');
        if (modalTitle) modalTitle.textContent = 'Elimina Iscrizione';
        const confirmBtn = modal.querySelector('button[onclick="confirmDeleteSelectedInterests()"]');
        if (confirmBtn) {
            confirmBtn.onclick = confirmDeleteSelected;
        }
        
        filterCompetitions(currentFilter);
    } catch (error) {
        console.error('Error deleting interests:', error);
        showNotification('Errore durante la rimozione degli interessi', 'error');
    }
}

async function deleteInterest(interest, competition) {
    const athlete = authorizedAthletes.find(a => a.tessera === interest.tessera_atleta);
    const athleteName = athlete ? athlete.display : interest.tessera_atleta;
    
    const confirmMsg = `Rimuovere l'interesse di ${athleteName} per ${competition.nome}?`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        await deleteInterestInternal(interest.id);
        
        // Remove from local cache
        if (userInterests.has(competition.codice)) {
            const remaining = userInterests.get(competition.codice)
                .filter(i => i.id !== interest.id);
            if (remaining.length > 0) {
                userInterests.set(competition.codice, remaining);
            } else {
                userInterests.delete(competition.codice);
            }
        }
        
        showNotification('Interesse rimosso con successo', 'success');
        filterCompetitions(currentFilter);
    } catch (error) {
        console.error('Error deleting interest:', error);
        showNotification('Errore durante la rimozione dell\'interesse', 'error');
    }
}

async function deleteInterestInternal(interestId) {
    const response = await fetch(`/archery/api/interesse/${interestId}`, {
        method: 'DELETE'
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Delete failed');
    }
    
    return response.json();
}

function showCompetitionDetails(competition) {
    // TODO: Implement details modal or redirect to details page
    console.log('Show details for:', competition);
    showNotification('Competition details coming soon', 'info');
}

function toggleAthleteList(element) {
    // Find the athlete list container within the same status box
    const statusBox = element.closest('.competition-subscription-status, .competition-interest-status');
    const athleteList = statusBox.querySelector('.athlete-list');
    const toggleIcon = element.querySelector('.athlete-list-toggle');
    
    if (athleteList.classList.contains('hidden')) {
        athleteList.classList.remove('hidden');
        toggleIcon.classList.remove('fa-chevron-down');
        toggleIcon.classList.add('fa-chevron-up');
    } else {
        athleteList.classList.add('hidden');
        toggleIcon.classList.remove('fa-chevron-up');
        toggleIcon.classList.add('fa-chevron-down');
    }
}

function formatDate(dateStr) {
    if (!dateStr) return 'TBA';
    // Parse as local date to avoid timezone issues
    const [year, month, day] = dateStr.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    const locale = window.translations._lang === 'it' ? 'it-IT' : 'en-US';
    
    if (locale === 'it-IT') {
        // Italian format: 17-Ott-2025
        const monthShort = date.toLocaleDateString('it-IT', { month: 'short' });
        return `${day}-${monthShort.charAt(0).toUpperCase() + monthShort.slice(1)}-${year}`;
    }
    
    return date.toLocaleDateString(locale, {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function formatDateRange(startStr, endStr) {
    if (!startStr) return 'TBA';
    // Parse as local dates to avoid timezone issues
    const [startYear, startMonth, startDay] = startStr.split('-').map(Number);
    const start = new Date(startYear, startMonth - 1, startDay);
    const end = endStr ? (() => {
        const [y, m, d] = endStr.split('-').map(Number);
        return new Date(y, m - 1, d);
    })() : null;
    
    const locale = window.translations._lang === 'it' ? 'it-IT' : 'en-US';
    
    if (locale === 'it-IT') {
        // Italian format: 17-Ott or 17-18 Ott or 17 Ott - 20 Nov
        const startMonthShort = start.toLocaleDateString('it-IT', { month: 'short' });
        const startMonth = startMonthShort.charAt(0).toUpperCase() + startMonthShort.slice(1);
        
        if (end && end.getTime() !== start.getTime()) {
            const endDay = end.getDate();
            const endMonthShort = end.toLocaleDateString('it-IT', { month: 'short' });
            const endMonth = endMonthShort.charAt(0).toUpperCase() + endMonthShort.slice(1);
            
            if (start.getMonth() === end.getMonth()) {
                // Same month: 17-18 Ott
                return `${startDay}-${endDay} ${startMonth}`;
            } else {
                // Different months: 28 Ott - 2 Nov
                return `${startDay} ${startMonth} - ${endDay} ${endMonth}`;
            }
        }
        
        return `${startDay} ${startMonth}`;
    }
    
    // English format
    const startFormatted = start.toLocaleDateString(locale, { month: 'short', day: 'numeric' });
    
    if (end && end.getTime() !== start.getTime()) {
        const endFormatted = end.toLocaleDateString(locale, { month: 'short', day: 'numeric', year: 'numeric' });
        return `${startFormatted} - ${endFormatted}`;
    }
    
    return start.toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' });
}

function showLoading(show) {
    console.log('showLoading called with:', show);
    const loading = document.getElementById('loading');
    const grid = document.getElementById('competitions-grid');
    const emptyState = document.getElementById('empty-state');
    
    if (show) {
        loading.classList.remove('hidden');
        grid.classList.add('hidden');
        emptyState.classList.add('hidden');
        console.log('Spinner shown');
    } else {
        loading.classList.add('hidden');
        grid.classList.remove('hidden');
        console.log('Spinner hidden, grid shown');
    }
}

function showError(message) {
    showNotification(message, 'error');
    document.getElementById('empty-state').classList.remove('hidden');
}

// Category validation rules
// G -> R, R -> A, A -> J, J -> S, M -> S
// Gender must remain the same (M stays M, F stays F)
function getValidCategoryChanges(currentCategory) {
    if (!currentCategory || currentCategory.length !== 2) return [];
    
    const ageCode = currentCategory[0];  // G, R, A, J, S, M
    const gender = currentCategory[1];   // M or F
    
    const validAges = [];
    
    switch(ageCode) {
        case 'G':
            validAges.push('G', 'R');  // G can change to R
            break;
        case 'R':
            validAges.push('R', 'A');  // R can change to A
            break;
        case 'A':
            validAges.push('A', 'J');  // A can change to J
            break;
        case 'J':
            validAges.push('J', 'S');  // J can change to S
            break;
        case 'S':
            validAges.push('S');       // S cannot change
            break;
        case 'M':
            validAges.push('M', 'S');  // M can change to S
            break;
        default:
            validAges.push(ageCode);   // Unknown, allow only same
    }
    
    // Generate valid categories with same gender
    return validAges.map(age => age + gender);
}

// Build change description
function buildChangeDescription(originalData, newData) {
    const changes = [];
    
    if (originalData.turno !== newData.turno) {
        changes.push(`TURNO cambia da ${originalData.turno} a ${newData.turno}`);
    }
    
    if (originalData.categoria !== newData.categoria) {
        changes.push(`CATEGORIA cambia da ${originalData.categoria} a ${newData.categoria}`);
    }
    
    if (originalData.classe !== newData.classe) {
        changes.push(`CLASSE cambia da "${originalData.classe || 'nessuna'}" a "${newData.classe || 'nessuna'}"`);
    }
    
    return changes;
}

// Apply changes to notes
function applyChangesToNotes(originalNotes, changes) {
    if (changes.length === 0) return originalNotes;
    
    const changeText = 'CAMBI RICHIESTI: ' + changes.join('; ');
    
    // If notes already contain "CAMBI RICHIESTI:", replace it
    if (originalNotes && originalNotes.includes('CAMBI RICHIESTI:')) {
        const beforeChanges = originalNotes.substring(0, originalNotes.indexOf('CAMBI RICHIESTI:'));
        return beforeChanges.trim() + (beforeChanges.trim() ? '\n\n' : '') + changeText;
    }
    
    // Otherwise append to existing notes
    return (originalNotes || '').trim() + (originalNotes ? '\n\n' : '') + changeText;
}

// Edit user subscription
let editingSubscription = null;

async function editUserSubscription(subscriptionId, codiceGara, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    // Find subscription
    const subs = userSubscriptions.get(codiceGara) || [];
    const sub = subs.find(s => s.id === subscriptionId);
    if (!sub) return;
    
    editingSubscription = { ...sub, codiceGara };
    
    // Populate form
    const athlete = authorizedAthletes.find(a => a.tessera === sub.tessera_atleta);
    const athleteName = athlete ? `${athlete.cognome} ${athlete.nome} (${athlete.tessera})` : sub.tessera_atleta;
    document.getElementById('edit-user-sub-athlete').value = athleteName;
    document.getElementById('edit-user-sub-id').value = sub.id;
    
    // REMEMBER: In iscrizioni table, categoria=bow_type and classe=age_category (REVERSED!)
    // But in the form we use the natural labeling, so we need to swap when reading/writing
    const ageCategory = sub.classe;  // In DB: classe = age category
    const bowType = sub.categoria;    // In DB: categoria = bow type
    
    document.getElementById('edit-user-sub-original-categoria').value = ageCategory;
    
    // Load turns if not already cached
    if (!allTurni[codiceGara]) {
        try {
            const turnsResp = await fetch(`/archery/api/turni?codice_gara=${codiceGara}`);
            if (turnsResp.ok) {
                allTurni[codiceGara] = await turnsResp.json();
            } else {
                allTurni[codiceGara] = [];
            }
        } catch (error) {
            console.error('Error loading turns for edit:', error);
            allTurni[codiceGara] = [];
        }
    }
    
    // Populate turno dropdown
    const turnoSelect = document.getElementById('edit-user-sub-turno');
    const turni = allTurni[codiceGara] || [];
    turnoSelect.innerHTML = turni.map(t => {
        // Build display text with proper time formatting
        const parts = [];
        if (t.giorno) parts.push(t.giorno);
        if (t.fase) parts.push(t.fase);
        if (t.ora_ritrovo) {
            // Format time - handle both string and seconds since midnight
            let timeFormatted;
            if (typeof t.ora_ritrovo === 'string') {
                timeFormatted = t.ora_ritrovo.substring(0, 5);
            } else if (typeof t.ora_ritrovo === 'number') {
                const hours = Math.floor(t.ora_ritrovo / 3600);
                const minutes = Math.floor((t.ora_ritrovo % 3600) / 60);
                timeFormatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            } else {
                timeFormatted = String(t.ora_ritrovo);
            }
            parts.push(timeFormatted);
        }
        const displayText = parts.length > 0 ? parts.join(' - ') : `Turno ${t.numero_turno || t.turno}`;
        return `<option value="${t.numero_turno || t.turno}" ${(t.numero_turno || t.turno) == sub.turno ? 'selected' : ''}>${displayText}</option>`;
    }).join('');
    
    // Populate categoria dropdown with valid options (age categories)
    const validCategories = getValidCategoryChanges(ageCategory);
    const categoriaSelect = document.getElementById('edit-user-sub-categoria');
    const categoryNames = {
        'GM': 'GM - Giovanissimi Maschile',
        'GF': 'GF - Giovanissimi Femminile',
        'RM': 'RM - Ragazzi Maschile',
        'RF': 'RF - Ragazzi Femminile',
        'AM': 'AM - Allievi Maschile',
        'AF': 'AF - Allievi Femminile',
        'JM': 'JM - Junior Maschile',
        'JF': 'JF - Junior Femminile',
        'SM': 'SM - Senior Maschile',
        'SF': 'SF - Senior Femminile',
        'MM': 'MM - Master Maschile',
        'MF': 'MF - Master Femminile'
    };
    
    categoriaSelect.innerHTML = validCategories.map(cat => 
        `<option value="${cat}" ${cat === ageCategory ? 'selected' : ''}>${categoryNames[cat] || cat}</option>`
    ).join('');
    
    // Set classe field to bow type
    document.getElementById('edit-user-sub-classe').value = bowType || '';
    
    // Set notes (exclude CAMBI RICHIESTI part)
    let userNotes = sub.note || '';
    if (userNotes.includes('CAMBI RICHIESTI:')) {
        userNotes = userNotes.substring(0, userNotes.indexOf('CAMBI RICHIESTI:')).trim();
    }
    document.getElementById('edit-user-sub-note').value = userNotes;
    
    // Handle Tripla toggle based on bow class
    toggleUserTriplaVisibility(bowType);
    
    // Check if "tripla" is in notes
    const hasTripla = (sub.note || '').toLowerCase().includes('tripla');
    document.getElementById('edit-user-sub-tripla').checked = hasTripla;
    
    // Add listener for bow class changes
    document.getElementById('edit-user-sub-classe').addEventListener('change', function() {
        toggleUserTriplaVisibility(this.value);
    });
    
    // Setup change tracking
    setupSubscriptionChangeTracking();
    
    // Show modal
    document.getElementById('edit-user-subscription-modal').classList.remove('hidden');
}

function setupSubscriptionChangeTracking() {
    const form = document.getElementById('edit-user-subscription-form');
    const inputs = form.querySelectorAll('select, textarea');
    
    inputs.forEach(input => {
        input.addEventListener('change', updateSubscriptionChangesPreview);
    });
    
    // Initial preview
    updateSubscriptionChangesPreview();
}

function updateSubscriptionChangesPreview() {
    if (!editingSubscription) return;
    
    // Form uses natural naming, but DB is reversed
    const newAgeCategory = document.getElementById('edit-user-sub-categoria').value;
    const newBowType = document.getElementById('edit-user-sub-classe').value;
    
    const newData = {
        turno: parseInt(document.getElementById('edit-user-sub-turno').value),
        categoria: newAgeCategory,  // For comparison, use natural naming
        classe: newBowType
    };
    
    // Original data from DB (reversed): sub.categoria=bowType, sub.classe=ageCategory
    const changes = buildChangeDescription({
        turno: editingSubscription.turno,
        categoria: editingSubscription.classe,  // ageCategory from DB classe
        classe: editingSubscription.categoria   // bowType from DB categoria
    }, newData);
    
    const preview = document.getElementById('edit-user-sub-changes-preview');
    const changesList = document.getElementById('edit-user-sub-changes-list');
    
    if (changes.length > 0) {
        changesList.innerHTML = changes.map(c => `<li>${c}</li>`).join('');
        preview.classList.remove('hidden');
    } else {
        preview.classList.add('hidden');
    }
}

async function submitUserSubscriptionEdit() {
    if (!editingSubscription) return;
    
    // Get values from form (natural naming)
    const newAgeCategory = document.getElementById('edit-user-sub-categoria').value;
    const newBowType = document.getElementById('edit-user-sub-classe').value;
    const newTurno = parseInt(document.getElementById('edit-user-sub-turno').value);
    
    // Prepare data for API (REVERSED: categoria=bowType, classe=ageCategory)
    const newData = {
        turno: newTurno,
        categoria: newBowType,      // Send bow type as categoria
        classe: newAgeCategory      // Send age category as classe
    };
    
    // Build change description using natural names for user display
    const changes = buildChangeDescription({
        turno: editingSubscription.turno,
        categoria: editingSubscription.classe,   // Original age category from DB classe
        classe: editingSubscription.categoria    // Original bow type from DB categoria
    }, {
        turno: newTurno,
        categoria: newAgeCategory,  // New age category
        classe: newBowType          // New bow type
    });
    
    // Get user notes and apply changes
    let userNotes = document.getElementById('edit-user-sub-note').value || '';
    const finalNotes = applyChangesToNotes(userNotes, changes);
    
    // Handle Tripla in notes for OL division
    let notesWithTripla = finalNotes;
    if (newBowType === 'OL') {
        const triplaChecked = document.getElementById('edit-user-sub-tripla').checked;
        notesWithTripla = manageTriplaInNotes(finalNotes, triplaChecked);
    }
    
    newData.note = notesWithTripla;
    
    // Set status to "modifica richiesta" if there are changes
    if (changes.length > 0) {
        newData.stato = 'modifica richiesta';
    } else {
        newData.stato = editingSubscription.stato;  // Keep current status
    }
    
    try {
        const response = await fetch(`/archery/api/iscrizioni/${editingSubscription.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newData)
        });
        
        if (response.ok) {
            showNotification(changes.length > 0 ? 
                'Richiesta di modifica inviata con successo' : 
                'Iscrizione aggiornata con successo', 'success');
            closeEditUserSubscriptionModal();
            
            // Reload data
            await loadInitialData();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update subscription');
        }
    } catch (error) {
        console.error('Error updating subscription:', error);
        showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
    }
}

function closeEditUserSubscriptionModal() {
    document.getElementById('edit-user-subscription-modal').classList.add('hidden');
    document.getElementById('edit-user-subscription-form').reset();
    editingSubscription = null;
}

// Edit user interest
let editingInterest = null;

function editUserInterest(interestId, codiceGara, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    // Find interest
    const interests = userInterests.get(codiceGara) || [];
    const interest = interests.find(i => i.id === interestId);
    if (!interest) return;
    
    editingInterest = { ...interest, codiceGara };
    
    // Populate form
    const athlete = authorizedAthletes.find(a => a.tessera === interest.tessera_atleta);
    const athleteName = athlete ? `${athlete.cognome} ${athlete.nome} (${athlete.tessera})` : interest.tessera_atleta;
    document.getElementById('edit-user-int-athlete').value = athleteName;
    document.getElementById('edit-user-int-id').value = interest.id;
    
    // REMEMBER: In interesse table, categoria=bow_type and classe=age_category (REVERSED!)
    const ageCategory = interest.classe;  // In DB: classe = age category
    const bowType = interest.categoria;    // In DB: categoria = bow type
    
    document.getElementById('edit-user-int-original-categoria').value = ageCategory;
    
    // Populate categoria dropdown with valid options (age categories)
    const validCategories = getValidCategoryChanges(ageCategory);
    const categoriaSelect = document.getElementById('edit-user-int-categoria');
    const categoryNames = {
        'GM': 'GM - Giovanissimi Maschile',
        'GF': 'GF - Giovanissimi Femminile',
        'RM': 'RM - Ragazzi Maschile',
        'RF': 'RF - Ragazzi Femminile',
        'AM': 'AM - Allievi Maschile',
        'AF': 'AF - Allievi Femminile',
        'JM': 'JM - Junior Maschile',
        'JF': 'JF - Junior Femminile',
        'SM': 'SM - Senior Maschile',
        'SF': 'SF - Senior Femminile',
        'MM': 'MM - Master Maschile',
        'MF': 'MF - Master Femminile'
    };
    
    categoriaSelect.innerHTML = validCategories.map(cat => 
        `<option value="${cat}" ${cat === ageCategory ? 'selected' : ''}>${categoryNames[cat] || cat}</option>`
    ).join('');
    
    // Set classe (bow type)
    document.getElementById('edit-user-int-classe').value = bowType || '';
    
    // Set notes
    document.getElementById('edit-user-int-note').value = interest.note || '';
    
    // Show modal
    document.getElementById('edit-user-interest-modal').classList.remove('hidden');
}

async function submitUserInterestEdit() {
    if (!editingInterest) return;
    
    // Get values from form (natural naming)
    const newAgeCategory = document.getElementById('edit-user-int-categoria').value;
    const newBowType = document.getElementById('edit-user-int-classe').value;
    
    // Prepare data for API (REVERSED: categoria=bowType, classe=ageCategory)
    const newData = {
        categoria: newBowType,      // Send bow type as categoria
        classe: newAgeCategory,     // Send age category as classe
        note: document.getElementById('edit-user-int-note').value || ''
    };
    
    try {
        const response = await fetch(`/archery/api/interesse/${editingInterest.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newData)
        });
        
        if (response.ok) {
            showNotification('Espressione di interesse aggiornata con successo', 'success');
            closeEditUserInterestModal();
            
            // Reload data
            await loadInitialData();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update interest');
        }
    } catch (error) {
        console.error('Error updating interest:', error);
        showNotification('Errore durante l\'aggiornamento: ' + error.message, 'error');
    }
}

function closeEditUserInterestModal() {
    document.getElementById('edit-user-interest-modal').classList.add('hidden');
    document.getElementById('edit-user-interest-form').reset();
    editingInterest = null;
}

// Single subscription delete (per-row action)
async function deleteSingleSubscription(subscriptionId, codiceGara, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const subs = userSubscriptions.get(codiceGara) || [];
    const sub = subs.find(s => s.id === subscriptionId);
    if (!sub) return;
    
    const competition = allCompetitions.find(c => c.codice === codiceGara);
    if (!competition) return;
    
    // Check if subscription is confirmed
    if (sub.stato === 'confermato') {
        const athlete = authorizedAthletes.find(a => a.tessera === sub.tessera_atleta);
        const athleteName = athlete ? athlete.display : sub.tessera_atleta;
        const confirmMsg = `L'iscrizione di ${athleteName} è confermata. Vuoi richiedere la cancellazione?`;
        
        if (!confirm(confirmMsg)) return;
        
        try {
            await requestCancellationInternal(subscriptionId);
            showNotification('Richiesta di cancellazione inviata', 'success');
            await loadInitialData();
        } catch (error) {
            console.error('Error requesting cancellation:', error);
            showNotification('Errore: ' + error.message, 'error');
        }
        return;
    }
    
    // For non-confirmed subscriptions, delete directly
    const athlete = authorizedAthletes.find(a => a.tessera === sub.tessera_atleta);
    const athleteName = athlete ? athlete.display : sub.tessera_atleta;
    const confirmMsg = `Eliminare l'iscrizione di ${athleteName}?`;
    
    if (!confirm(confirmMsg)) return;
    
    try {
        await deleteSubscriptionInternal(subscriptionId);
        showNotification('Iscrizione eliminata con successo', 'success');
        await loadInitialData();
    } catch (error) {
        console.error('Error deleting subscription:', error);
        showNotification('Errore: ' + error.message, 'error');
    }
}

// Single interest delete (per-row action)
async function deleteSingleInterest(interestId, codiceGara, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const interests = userInterests.get(codiceGara) || [];
    const interest = interests.find(i => i.id === interestId);
    if (!interest) return;
    
    const athlete = authorizedAthletes.find(a => a.tessera === interest.tessera_atleta);
    const athleteName = athlete ? athlete.display : interest.tessera_atleta;
    const confirmMsg = `Rimuovere l'interesse di ${athleteName}?`;
    
    if (!confirm(confirmMsg)) return;
    
    try {
        await deleteInterestInternal(interestId);
        showNotification('Interesse rimosso con successo', 'success');
        await loadInitialData();
    } catch (error) {
        console.error('Error deleting interest:', error);
        showNotification('Errore: ' + error.message, 'error');
    }
}

// Convert interest to subscription
async function convertInterestToSubscription(interestId, codiceGara, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const interests = userInterests.get(codiceGara) || [];
    const interest = interests.find(i => i.id === interestId);
    if (!interest) return;
    
    const competition = allCompetitions.find(c => c.codice === codiceGara);
    if (!competition) return;
    
    // Check if turns are available
    if (!allTurni[codiceGara]) {
        try {
            const turnsResp = await fetch(`/archery/api/turni?codice_gara=${codiceGara}`);
            if (turnsResp.ok) {
                allTurni[codiceGara] = await turnsResp.json();
            } else {
                allTurni[codiceGara] = [];
            }
        } catch (error) {
            console.error('Error loading turns:', error);
            showNotification('Errore nel caricamento dei turni', 'error');
            return;
        }
    }
    
    const turni = allTurni[codiceGara] || [];
    if (turni.length === 0) {
        showNotification('Nessun turno disponibile per questa gara', 'warning');
        return;
    }
    
    // Show modal to select a turn
    const athlete = authorizedAthletes.find(a => a.tessera === interest.tessera_atleta);
    const athleteName = athlete ? athlete.display : interest.tessera_atleta;
    
    // Check if OL division - need to ask about Tripla
    const isOL = interest.categoria === 'OL';
    
    showTurnSelectionModal(turni, athleteName, isOL, async (selectedTurn, useTripla) => {
        await performInterestConversion(interestId, codiceGara, interest, selectedTurn, useTripla);
    });
}

// Helper function to show turn selection modal
function showTurnSelectionModal(turni, athleteName, isOL, onSelectCallback) {
    const modal = document.getElementById('selection-modal');
    const modalTitle = document.getElementById('selection-modal-title');
    const selectionList = document.getElementById('selection-list');
    
    modalTitle.innerHTML = `<i class="fas fa-exchange-alt mr-2"></i>Seleziona turno per ${athleteName}`;
    
    // Add Tripla toggle if OL division
    const triplaToggleHtml = isOL ? `
        <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" id="convert-tripla-toggle" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-2 focus:ring-primary dark:border-gray-600 dark:bg-gray-700">
                <span class="text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-bullseye mr-1 text-blue-600"></i>
                    Tripla (3-spot target)
                </span>
            </label>
        </div>
    ` : '';
    
    selectionList.innerHTML = triplaToggleHtml + turni.map(t => {
        const parts = [];
        if (t.giorno) parts.push(t.giorno);
        if (t.fase) parts.push(t.fase);
        if (t.ora_ritrovo) {
            let timeFormatted;
            if (typeof t.ora_ritrovo === 'string') {
                timeFormatted = t.ora_ritrovo.substring(0, 5);
            } else if (typeof t.ora_ritrovo === 'number') {
                const hours = Math.floor(t.ora_ritrovo / 3600);
                const minutes = Math.floor((t.ora_ritrovo % 3600) / 60);
                timeFormatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            } else {
                timeFormatted = String(t.ora_ritrovo);
            }
            parts.push(timeFormatted);
        }
        const displayText = parts.length > 0 ? parts.join(' - ') : `Turno ${t.numero_turno || t.turno}`;
        const turnId = t.numero_turno || t.turno;
        
        return `
            <button data-turn-id="${turnId}" class="turn-selection-btn w-full text-left p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-300 dark:hover:border-blue-700 transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">
                            <i class="fas fa-clock mr-2 text-blue-600"></i>${displayText}
                        </div>
                        ${t.note ? `<div class="text-sm text-gray-600 dark:text-gray-400 mt-1">${t.note}</div>` : ''}
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            </button>
        `;
    }).join('');
    
    // Store turns for later lookup and add click handlers
    window._availableTurns = turni;
    
    // Store callback for later use
    window._turnSelectionCallback = onSelectCallback;
    
    // Add click handlers to all turn buttons
    setTimeout(() => {
        document.querySelectorAll('.turn-selection-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const turnId = parseInt(this.dataset.turnId);
                const selectedTurn = window._availableTurns.find(t => 
                    (t.numero_turno || t.turno) === turnId
                );
                
                if (selectedTurn) {
                    // Check if Tripla is selected (for OL athletes)
                    const triplaToggle = document.getElementById('convert-tripla-toggle');
                    const useTripla = triplaToggle ? triplaToggle.checked : false;
                    
                    closeSelectionModal();
                    if (window._turnSelectionCallback) {
                        window._turnSelectionCallback(selectedTurn, useTripla);
                        window._turnSelectionCallback = null;
                        window._availableTurns = null;
                    }
                }
            });
        });
    }, 100);
    
    modal.classList.remove('hidden');
}

// Helper function to perform the actual conversion
async function performInterestConversion(interestId, codiceGara, interest, selectedTurn, useTripla) {
    
    try {
        // Prepare notes with Tripla if needed
        let notes = interest.note || '';
        if (useTripla && interest.categoria === 'OL') {
            notes = manageTriplaInNotes(notes, true);
        }
        
        // Create subscription
        const subscriptionData = {
            codice_gara: codiceGara,
            tessera_atleta: interest.tessera_atleta,
            turno: selectedTurn.numero_turno || selectedTurn.turno,
            categoria: interest.categoria,  // bow type
            classe: interest.classe,        // age category
            note: notes,
            stato: 'richiesta_effettuata'
        };
        
        const response = await fetch('/archery/api/iscrizioni', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(subscriptionData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Errore nella conversione');
        }
        
        // Delete the interest
        await deleteInterestInternal(interestId);
        
        showNotification('Interesse convertito in iscrizione con successo!', 'success');
        await loadInitialData();
    } catch (error) {
        console.error('Error converting interest:', error);
        showNotification('Errore nella conversione: ' + error.message, 'error');
    }
}

// Show selection menu for multiple subscriptions/interests
function showSubscriptionSelectionForEdit(subscriptions, codiceGara) {
    document.getElementById('selection-modal-title').innerHTML = '<i class="fas fa-edit mr-2"></i>Seleziona quale iscrizione modificare';
    
    const listHtml = subscriptions.map(sub => {
        const athlete = authorizedAthletes.find(a => a.tessera === sub.tessera_atleta);
        const athleteName = athlete ? `${athlete.cognome} ${athlete.nome}` : sub.tessera_atleta;
        
        // Check if tripla is in notes (for OL division)
        const hasTripla = sub.categoria === 'OL' && (sub.note || '').toLowerCase().includes('tripla');
        const triplaIcon = hasTripla ? '<span class="ml-1 px-1.5 py-0.5 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded" title="3-spot target">3⊙</span>' : '';
        
        return `
            <button onclick="editUserSubscription(${sub.id}, '${codiceGara}'); closeSelectionModal();" 
                    class="w-full text-left px-4 py-3 bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-700 transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">${athleteName}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            ${sub.categoria || '-'}${triplaIcon} ${sub.classe || '-'} • Turno ${sub.turno}
                        </p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            </button>
        `;
    }).join('');
    
    document.getElementById('selection-list').innerHTML = listHtml;
    document.getElementById('selection-modal').classList.remove('hidden');
}

function showInterestSelectionForEdit(interests, codiceGara) {
    document.getElementById('selection-modal-title').innerHTML = '<i class="fas fa-edit mr-2"></i>Seleziona quale interesse modificare';
    
    const listHtml = interests.map(interest => {
        const athlete = authorizedAthletes.find(a => a.tessera === interest.tessera_atleta);
        const athleteName = athlete ? `${athlete.cognome} ${athlete.nome}` : interest.tessera_atleta;
        
        return `
            <button onclick="editUserInterest(${interest.id}, '${codiceGara}'); closeSelectionModal();" 
                    class="w-full text-left px-4 py-3 bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-700 transition-colors">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">${athleteName}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            ${interest.categoria || '-'} ${interest.classe || '-'}
                        </p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            </button>
        `;
    }).join('');
    
    document.getElementById('selection-list').innerHTML = listHtml;
    document.getElementById('selection-modal').classList.remove('hidden');
}

function closeSelectionModal() {
    document.getElementById('selection-modal').classList.add('hidden');
    document.getElementById('selection-list').innerHTML = '';
}

/**
 * Show competition invite modal
 */
async function showCompetitionInfo(competition) {
    const modal = document.getElementById('invite-modal');
    const loading = document.getElementById('invite-loading');
    const error = document.getElementById('invite-error');
    const content = document.getElementById('invite-content');
    
    // Show modal with loading state
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    content.classList.add('hidden');
    
    // Set title
    document.getElementById('invite-modal-title').textContent = competition.nome;
    document.getElementById('invite-modal-subtitle').textContent = 
        `${competition.codice} • ${competition.luogo || 'Sede da definire'}`;
    
    try {
        // Fetch invite details from API (via Flask proxy for Cloudflare Zero Trust)
        const response = await fetch(`/archery/api/inviti/${competition.codice}/text`);
        
        if (!response.ok) {
            throw new Error(response.status === 404 ? 'Invito non disponibile' : 'Errore nel caricamento');
        }
        
        const invite = await response.json();
        
        // Populate info card
        document.getElementById('invite-dates').textContent = 
            formatDateRange(competition.data_inizio, competition.data_fine);
        
        document.getElementById('invite-registration-dates').textContent = 
            invite.data_apertura_iscrizioni && invite.data_chiusura_iscrizioni
                ? formatDateRange(invite.data_apertura_iscrizioni, invite.data_chiusura_iscrizioni)
                : 'Non specificate';
        
        document.getElementById('invite-turns').textContent = 
            invite.numero_turni ? `${invite.numero_turni} turni` : 'Non specificato';
        
        // Show youth-only badge if applicable
        const youthOnlyBadge = document.getElementById('invite-youth-only');
        if (invite.solo_giovanile) {
            youthOnlyBadge.classList.remove('hidden');
        } else {
            youthOnlyBadge.classList.add('hidden');
        }
        
        // Display content (preserving formatting with textContent for plain text)
        const htmlContent = document.getElementById('invite-html-content');
        if (invite.invite_raw && invite.invite_raw.trim()) {
            // Check if content looks like HTML or plain text
            if (invite.invite_raw.includes('<') && invite.invite_raw.includes('>')) {
                // Looks like HTML - render as HTML
                htmlContent.innerHTML = invite.invite_raw;
            } else {
                // Plain text - use textContent to preserve newlines with white-space: pre-wrap
                htmlContent.textContent = invite.invite_raw;
            }
        } else {
            htmlContent.innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                    <i class="fas fa-file-alt text-4xl mb-3"></i>
                    <p>Contenuto invito non disponibile</p>
                    <p class="text-sm mt-2">L'invito potrebbe non essere stato ancora pubblicato</p>
                </div>
            `;
        }
        
        // Show content, hide loading
        loading.classList.add('hidden');
        content.classList.remove('hidden');
        
    } catch (err) {
        console.error('Error loading invite:', err);
        
        // Show error state
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('invite-error-message').textContent = 
            err.message || 'Errore nel caricamento dell\'invito';
    }
}

/**
 * Close invite modal
 */
function closeInviteModal() {
    document.getElementById('invite-modal').classList.add('hidden');
    //         displayInviteModal(data.invite_url);
    //     });
}

// Toggle dropdown menu
function toggleDropdown(event, dropdownId) {
    event.stopPropagation();
    event.preventDefault();
    
    const dropdown = document.getElementById(`dropdown-${dropdownId}`);
    if (!dropdown) return;
    
    // Close all other dropdowns
    document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
        if (d.id !== `dropdown-${dropdownId}`) {
            d.classList.add('hidden');
        }
    });
    
    // Toggle this dropdown
    dropdown.classList.toggle('hidden');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick*="toggleDropdown"]')) {
        document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
            d.classList.add('hidden');
        });
    }
});

// Toggle Tripla visibility based on bow class (for subscription modal)
function toggleTriplaVisibility(bowClass) {
    const container = document.getElementById('tripla-container');
    if (!container) return;
    
    // Get current competition to check if it's indoor
    const codiceGara = document.getElementById('competition-id')?.value;
    const competition = codiceGara ? allCompetitions.find(c => c.codice === codiceGara) : null;
    const isIndoor = competition && competition.tipo_gara && (competition.tipo_gara.includes('18m') || competition.tipo_gara.includes('25m'));
    
    // Show tripla only for OL bow class AND indoor competitions
    if (bowClass === 'OL' && isIndoor) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
        // Uncheck if hidden
        document.getElementById('sub-tripla').checked = false;
    }
}

// Toggle Tripla visibility based on bow class (for user edit modal)
function toggleUserTriplaVisibility(bowClass) {
    const container = document.getElementById('edit-user-tripla-container');
    if (!container) return;
    
    // Get current competition from editingSubscription to check if it's indoor
    const competition = editingSubscription ? allCompetitions.find(c => c.codice === editingSubscription.codiceGara) : null;
    const isIndoor = competition && competition.tipo_gara && (competition.tipo_gara.includes('18m') || competition.tipo_gara.includes('25m'));
    
    // Show tripla only for OL bow class AND indoor competitions
    if (bowClass === 'OL' && isIndoor) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
        // Uncheck if hidden
        document.getElementById('edit-user-sub-tripla').checked = false;
    }
}

// Manage "tripla" in notes
function manageTriplaInNotes(notes, shouldHaveTripla) {
    // Remove any existing "tripla" mentions (case-insensitive)
    let cleanNotes = notes.replace(/\btripla\b/gi, '').trim();
    // Clean up extra whitespace
    cleanNotes = cleanNotes.replace(/\s+/g, ' ').trim();
    
    // Add "tripla" if checked
    if (shouldHaveTripla) {
        if (cleanNotes) {
            return cleanNotes + ' tripla';
        } else {
            return 'tripla';
        }
    }
    
    return cleanNotes;
}


</script>

{% endblock %}
