{% extends "base.html" %}

{% block title %}{{ item['title_' + session.get('language', 'it')] }} - {{ super() }}{% endblock %}

{% block head %}
<style>
    /* Parallax PCB Background (solo per elettronica) */
    .pcb-parallax {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        opacity: 0.5; /* Aumentato per test - dovrebbe essere MOLTO visibile */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        will-change: transform;
        transition: transform 0.1s ease-out;
        /* Debug border */
        border: 5px solid red;
    }
    
    /* Gradient overlay per migliorare leggibilità */
    .pcb-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
        background: linear-gradient(
            to bottom,
            rgba(255, 255, 255, 0.3) 0%,
            rgba(255, 255, 255, 0.2) 50%,
            rgba(255, 255, 255, 0.3) 100%
        );
        /* Debug border */
        border: 5px solid blue;
    }
    
    .dark .pcb-overlay {
        background: linear-gradient(
            to bottom,
            rgba(17, 24, 39, 0.3) 0%,
            rgba(17, 24, 39, 0.2) 50%,
            rgba(17, 24, 39, 0.3) 100%
        );
    }
    
    /* Blog post content styling */
    .blog-content {
        font-size: 1.125rem;
        line-height: 1.8;
    }
    
    .blog-content h2 {
        @apply text-3xl font-bold mt-8 mb-4 text-gray-900 dark:text-white;
    }
    
    .blog-content h3 {
        @apply text-2xl font-bold mt-6 mb-3 text-gray-800 dark:text-gray-100;
    }
    
    .blog-content p {
        @apply mb-4 text-gray-700 dark:text-gray-300;
    }
    
    .blog-content ul, .blog-content ol {
        @apply mb-4 ml-6 text-gray-700 dark:text-gray-300;
    }
    
    .blog-content li {
        @apply mb-2;
    }
    
    .blog-content code {
        @apply bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded text-sm font-mono;
    }
    
    .blog-content pre {
        @apply bg-gray-100 dark:bg-gray-800 p-4 rounded-lg mb-4 overflow-x-auto;
    }
    
    .blog-content img {
        @apply rounded-lg shadow-lg my-6 w-full;
    }
    
    .blog-content a {
        @apply text-primary hover:text-primary-dark underline;
    }
    
    /* Image gallery grid */
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- PCB Parallax Background (solo se elettronica E ha pcb_background) -->
{% if item.category == 'electronics' and item.pcb_background %}
<div class="pcb-parallax" id="pcb-bg" style="
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: -2 !important;
    opacity: 0.12 !important;
    background-image: url('{{ url_for('static', filename='uploads/pcb/' + item.pcb_background) }}') !important;
    background-size: cover !important;
    background-position: center center !important;
    background-repeat: no-repeat !important;
    will-change: transform !important;
    transition: transform 0.1s ease-out !important;
"></div>
<div class="pcb-overlay" style="
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: -1 !important;
    background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(255,255,255,0.85)) !important;
    pointer-events: none !important;
"></div>
{% else %}
<!-- No PCB background for this project -->
{% endif %}

<!-- Main Article - position: relative per contenere gli sfondi absolute -->
<article class="py-12 bg-transparent" {% if item.category == 'electronics' and item.pcb_background %}style="position: relative; min-height: 100vh;"{% else %}style="position: relative;"{% endif %}>
    <div class="container mx-auto px-4 max-w-4xl">
        
        <!-- Breadcrumb -->
        <nav class="mb-8 text-sm">
            <ol class="flex items-center space-x-2 text-gray-600 dark:text-gray-400">
                <li><a href="{{ url_for('main.index') }}" class="hover:text-primary">Home</a></li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li><a href="{{ url_for('main.projects_by_category', category=item.category) }}" class="hover:text-primary">
                    {% if item.category == '3dprinting' %}Stampa 3D{% else %}Elettronica{% endif %}
                </a></li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li class="text-gray-900 dark:text-white">{{ item['title_' + session.get('language', 'it')] }}</li>
            </ol>
        </nav>
        
        <!-- Header -->
        <header class="mb-8 md:mb-12 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md p-4 md:p-8 rounded-xl md:rounded-2xl shadow-xl">
            <div class="flex flex-wrap items-center gap-2 md:gap-4 mb-4">
                {% if item.category == '3dprinting' %}
                <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-300 rounded-full text-sm font-semibold">
                    <i class="fas fa-cube mr-1"></i>Stampa 3D
                </span>
                {% else %}
                <span class="px-3 py-1 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-300 rounded-full text-sm font-semibold">
                    <i class="fas fa-microchip mr-1"></i>Elettronica
                </span>
                {% endif %}
                
                {% if item.tags %}
                    {% for tag in item.tags.split(',')[:3] %}
                    <span class="px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-xs">
                        {{ tag.strip() }}
                    </span>
                    {% endfor %}
                {% endif %}
            </div>
            
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4 text-gray-900 dark:text-white break-words">
                {{ item['title_' + session.get('language', 'it')] }}
            </h1>
            
            <div class="flex flex-wrap items-center gap-3 md:gap-6 text-gray-600 dark:text-gray-400 text-xs md:text-sm">
                <span><i class="far fa-calendar mr-2"></i>{{ item.created_at.strftime('%d %B %Y') if item.created_at else 'Data sconosciuta' }}</span>
                {% if item.updated_at and item.updated_at != item.created_at %}
                <span><i class="far fa-clock mr-2"></i>Aggiornato: {{ item.updated_at.strftime('%d %B %Y') }}</span>
                {% endif %}
                <span><i class="far fa-eye mr-2"></i>{{ item.view_count or 0 }} visualizzazioni</span>
            </div>
        </header>
        
        <!-- Main Image -->
        {% if item.main_image %}
        <div class="mb-12">
            <img src="{{ url_for('static', filename='uploads/gallery/' + item.main_image) }}" 
                 alt="{{ item['title_' + session.get('language', 'it')] }}"
                 class="w-full rounded-2xl shadow-2xl">
        </div>
        {% endif %}
        
        <!-- Description (lead paragraph) -->
        {% if item['description_' + session.get('language', 'it')] %}
        <div class="mb-8 text-base md:text-xl text-gray-700 dark:text-gray-300 leading-relaxed border-l-4 border-primary pl-4 md:pl-6 italic bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm p-4 md:p-6 rounded-lg shadow-lg">
            {{ item['description_' + session.get('language', 'it')] }}
        </div>
        {% endif %}
        
        <!-- Main Content -->
        <div class="blog-content bg-white/90 dark:bg-gray-800/90 backdrop-blur-md rounded-xl md:rounded-2xl shadow-lg p-4 md:p-8 mb-12 text-sm md:text-base">
            {% if item['content_' + session.get('language', 'it')] %}
                {{ item['content_' + session.get('language', 'it')] | safe }}
            {% else %}
                <p class="text-gray-600 dark:text-gray-400 italic">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    Contenuto completo non ancora disponibile. Torna presto!
                </p>
            {% endif %}
        </div>
        
        <!-- Additional Images Gallery -->
        {% if item.images %}
        <div class="mb-12">
            <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Galleria</h2>
            <div class="image-grid">
                {% set image_list = item.images | from_json if item.images else [] %}
                {% for image in image_list %}
                <div class="relative group cursor-pointer" onclick="openImageModal('{{ url_for('static', filename='uploads/gallery/' + image) }}')">
                    <img src="{{ url_for('static', filename='uploads/gallery/' + image) }}" 
                         alt="Immagine progetto"
                         class="w-full h-64 object-cover rounded-lg shadow-md group-hover:shadow-xl transition-shadow">
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center">
                        <i class="fas fa-search-plus text-white text-3xl opacity-0 group-hover:opacity-100 transition-opacity"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- External Link -->
        {% if item.external_url %}
        <div class="mb-12 bg-gradient-to-r from-primary to-primary-dark p-4 md:p-6 rounded-xl md:rounded-2xl shadow-lg">
            <div class="flex flex-col md:flex-row items-center justify-between text-white gap-4">
                <div class="text-center md:text-left">
                    <h3 class="text-lg md:text-xl font-bold mb-2">Vuoi saperne di più?</h3>
                    <p class="opacity-90 text-sm md:text-base">Visita la pagina del progetto su GitHub o Printables</p>
                </div>
                <a href="{{ item.external_url }}" target="_blank" rel="noopener noreferrer"
                   class="w-full md:w-auto px-6 py-3 bg-white text-primary rounded-lg font-semibold hover:bg-gray-100 transition-colors text-center whitespace-nowrap">
                    <i class="fas fa-external-link-alt mr-2"></i>Vai al progetto
                </a>
            </div>
        </div>
        {% endif %}
        
        <!-- Related Products -->
        {% if item.products %}
        <div class="mb-12">
            <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Prodotti Correlati</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for product in item.products %}
                <a href="{{ url_for('shop.product_detail', product_id=product.id) }}"
                   class="block bg-white dark:bg-gray-800 rounded-xl shadow-lg hover:shadow-xl transition-shadow p-6">
                    <div class="flex items-center gap-4">
                        {% if product.image_url %}
                        <img src="{{ url_for('static', filename='uploads/products/' + product.image_url) }}"
                             alt="{{ product['name_' + session.get('language', 'it')] }}"
                             class="w-24 h-24 object-cover rounded-lg">
                        {% endif %}
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">
                                {{ product['name_' + session.get('language', 'it')] }}
                            </h3>
                            <p class="text-2xl font-bold text-primary">€{{ '%.2f' | format(product.price) }}</p>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Related Projects -->
        {% if related %}
        <div class="mb-12">
            <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Progetti Correlati</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                {% for rel_item in related %}
                <a href="{{ url_for('main.project_detail', slug=rel_item.slug) }}"
                   class="block bg-white dark:bg-gray-800 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
                    {% if rel_item.main_image %}
                    <img src="{{ url_for('static', filename='uploads/gallery/' + rel_item.main_image) }}"
                         alt="{{ rel_item['title_' + session.get('language', 'it')] }}"
                         class="w-full h-48 object-cover rounded-t-xl">
                    {% endif %}
                    <div class="p-4">
                        <h3 class="font-bold text-gray-900 dark:text-white mb-2">
                            {{ rel_item['title_' + session.get('language', 'it')] }}
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            {{ rel_item['description_' + session.get('language', 'it')][:100] }}...
                        </p>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
    </div>
</article>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4" onclick="closeImageModal()">
    <div class="relative max-w-6xl max-h-full">
        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300">
            <i class="fas fa-times"></i>
        </button>
        <img id="modalImage" src="" alt="" class="max-w-full max-h-screen rounded-lg">
    </div>
</div>

<script>
// PCB Parallax effect
{% if item.category == 'electronics' and item.pcb_background %}
function initPCBParallax() {
    const pcbBg = document.getElementById('pcb-bg');
    if (!pcbBg) return;
    
    // Imposta dimensioni contenitore per coprire tutta la pagina
    function updateDimensions() {
        const pageHeight = document.body.scrollHeight;
        const viewportHeight = window.innerHeight;
        // Aggiungi extra height per il parallax (30% del scroll range)
        const extraHeight = (pageHeight - viewportHeight) * 0.3;
        pcbBg.style.height = `${pageHeight + extraHeight}px`;
    }
    
    updateDimensions();
    window.addEventListener('resize', updateDimensions);
    
    // Effetto parallax: muove in base allo scroll
    document.addEventListener('scroll', function() {
        const scrolled = window.pageYOffset;
        const parallaxSpeed = 0.3; // Velocità ridotta per effetto smooth
        // Muove verso l'alto mentre scrolli
        pcbBg.style.transform = `translateY(${-scrolled * parallaxSpeed}px)`;
    });
}

// Inizializza dopo che DOM è caricato
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPCBParallax);
} else {
    initPCBParallax();
}
{% endif %}

// Image modal functions
function openImageModal(imageSrc) {
    document.getElementById('imageModal').classList.remove('hidden');
    document.getElementById('modalImage').src = imageSrc;
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endblock %}
