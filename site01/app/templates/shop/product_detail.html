{% extends "base.html" %}

{% block title %}{{ product.name_it if session.get('language') == 'it' else product.name_en }} - {{ super() }}{% endblock %}

{% block content %}
<section class="py-12 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 max-w-6xl">
        <!-- Smart Back button -->
        <a href="javascript:history.back()" 
           class="inline-flex items-center text-primary hover:text-primary-dark mb-6 transition">
            <i class="fas fa-arrow-left mr-2"></i>{{ t('common.back') }}
        </a>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <!-- Image -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                {% if product.main_image %}
                <img src="{{ url_for('static', filename='uploads/gallery/' + product.main_image) }}" 
                     alt="{{ product.name_it if session.get('language') == 'it' else product.name_en }}" 
                     class="w-full h-auto object-cover">
                {% else %}
                <div class="w-full h-96 bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                    <i class="fas fa-image text-6xl text-gray-400"></i>
                </div>
                {% endif %}
            </div>
            
            <!-- Details -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
                    {{ product.name_it if session.get('language') == 'it' else product.name_en }}
                </h1>
                
                <div class="flex items-center gap-2 mb-6">
                    <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm font-medium">
                        <i class="fas fa-tag mr-1"></i>{{ product.category }}
                    </span>
                    {% if product.in_stock %}
                    <span class="px-3 py-1 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-full text-sm font-medium">
                        <i class="fas fa-check-circle mr-1"></i>{{ t('shop.in_stock') }}
                    </span>
                    {% else %}
                    <span class="px-3 py-1 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-full text-sm font-medium">
                        <i class="fas fa-times-circle mr-1"></i>{{ t('shop.out_of_stock') }}
                    </span>
                    {% endif %}
                </div>
                
                <!-- Price -->
                <div class="mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-baseline gap-2">
                        <span class="text-4xl font-bold text-primary">€{{ "%.2f"|format(product.price) }}</span>
                        {% if product.stock_quantity %}
                        <span class="text-sm text-gray-600 dark:text-gray-400">
                            {% if product.stock_quantity == 999 %}
                            (<i class="fas fa-tools mr-1"></i>{{ t('shop.made_to_order') if session.get('language') == 'it' else 'Made to Order' }})
                            {% else %}
                            ({{ product.stock_quantity }} {{ t('common.available') if session.get('language') == 'it' else 'available' }})
                            {% endif %}
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                {% if product.description_it or product.description_en %}
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-3">
                        {{ t('common.description') if session.get('language') == 'it' else 'Description' }}
                    </h2>
                    <p class="text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line">
                        {{ product.description_it if session.get('language') == 'it' else product.description_en }}
                    </p>
                </div>
                {% endif %}
                
                {% if product.tags %}
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-3">Tags</h2>
                    <div class="flex flex-wrap gap-2">
                        {% for tag in product.tags.split(',') %}
                        <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full text-sm">
                            {{ tag.strip() }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Variant Selection -->
                {% if product.variant_config and not product.is_custom_string and not product.is_custom_print %}
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                        {{ t('shop.select_options') if session.get('language') == 'it' else 'Select Options' }}
                    </h2>
                    <div id="variant-options" class="space-y-4">
                        <!-- Variant options will be inserted here by JavaScript -->
                    </div>
                </div>
                {% endif %}
                
                <!-- Link to Gallery Item -->
                {% if product.gallery_item %}
                <div class="mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
                    <a href="{% if product.gallery_item.category == '3dprinting' %}{{ url_for('printing.item_detail', item_id=product.gallery_item.id) }}{% else %}{{ url_for('electronics.item_detail', item_id=product.gallery_item.id) }}{% endif %}" 
                       class="inline-flex items-center text-primary hover:text-primary-dark transition">
                        <i class="fas fa-images mr-2"></i>
                        {{ t('shop.view_project') if session.get('language') == 'it' else 'View Project Gallery' }}
                    </a>
                </div>
                {% endif %}
                
                <!-- Add to Cart Button -->
                {% if product.in_stock %}
                <div class="pt-6 border-t border-gray-200 dark:border-gray-700 space-y-3">
                    <!-- Customize Button (if customization enabled) -->
                    {% if product.is_custom_string %}
                    <a href="{{ url_for('shop.customize_string', product_id=product.id) }}"
                       class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition font-semibold flex items-center justify-center gap-2">
                        <i class="fas fa-sliders-h"></i>{{ t('shop.customize_string') }}
                    </a>
                    <p class="text-sm text-center text-gray-600 dark:text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>{{ t('shop.customization_required') if session.get('language') == 'it' else 'Customization required for this product' }}
                    </p>
                    {% endif %}
                    
                    {% if product.is_custom_print %}
                    <a href="{{ url_for('shop.customize_print', product_id=product.id) }}"
                       class="w-full px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 transition font-semibold flex items-center justify-center gap-2">
                        <i class="fas fa-cube"></i>{{ t('shop.customize_print') }}
                    </a>
                    <p class="text-sm text-center text-gray-600 dark:text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>{{ t('shop.customization_required') if session.get('language') == 'it' else 'Customization required for this product' }}
                    </p>
                    {% endif %}
                    
                    <!-- Standard Add to Cart (only if NOT customizable) -->
                    {% if not product.is_custom_string and not product.is_custom_print %}
                    <button 
                        data-product-id="{{ product.id }}"
                        data-product-name="{{ product.name_it if session.get('language') == 'it' else product.name_en }}"
                        data-product-price="{{ product.price }}"
                        data-product-image="/static/uploads/gallery/{{ product.main_image }}"
                        data-product-desc="{{ (product.description_it if session.get('language') == 'it' else product.description_en)|truncate(100) }}"
                        onclick="addToCartFromButton(this)"
                        class="w-full px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition font-semibold flex items-center justify-center gap-2">
                        <i class="fas fa-shopping-cart"></i>{{ t('shop.add_to_cart') }}
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Related Products -->
        {% if related_products %}
        <div class="mt-12">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">
                {{ t('common.related_products') if session.get('language') == 'it' else 'Related Products' }}
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {% for related in related_products[:4] %}
                <a href="{{ url_for('shop.product_detail', product_id=related.id) }}" 
                   class="group block bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition">
                    {% if related.main_image %}
                    <img src="{{ url_for('static', filename='uploads/gallery/' + related.main_image) }}" 
                         alt="{{ related.name_it if session.get('language') == 'it' else related.name_en }}" 
                         class="w-full h-48 object-cover grayscale group-hover:grayscale-0 transition-all">
                    {% else %}
                    <div class="w-full h-48 bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                        <i class="fas fa-image text-3xl text-gray-400"></i>
                    </div>
                    {% endif %}
                    <div class="p-4">
                        <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-primary transition line-clamp-2 mb-2">
                            {{ related.name_it if session.get('language') == 'it' else related.name_en }}
                        </h3>
                        <p class="text-lg font-bold text-primary">€{{ "%.2f"|format(related.price) }}</p>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</section>

<script>
// Render variant options
document.addEventListener('DOMContentLoaded', () => {
    const variantConfigRaw = {{ product.variant_config|tojson if product.variant_config else '{}' }};
    console.log('Raw variant config:', variantConfigRaw);
    console.log('Type:', typeof variantConfigRaw);
    
    // Parse if it's a string
    const variantConfig = typeof variantConfigRaw === 'string' ? JSON.parse(variantConfigRaw) : variantConfigRaw;
    console.log('Parsed variant config:', variantConfig);
    
    const variantContainer = document.getElementById('variant-options');
    
    if (variantContainer && Object.keys(variantConfig).length > 0) {
        Object.entries(variantConfig).forEach(([fieldName, fieldConfig]) => {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'variant-field';
            
            const label = fieldConfig.label || fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
            const required = fieldConfig.required !== false;
            
            let fieldHTML = `
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    ${label}${fieldConfig.unit ? ` (${fieldConfig.unit})` : ''}
                    ${required ? '<span class="text-red-500">*</span>' : ''}
                </label>
            `;
            
            if (fieldConfig.type === 'select' && fieldConfig.options) {
                fieldHTML += `
                    <select name="variant_${fieldName}" ${required ? 'required' : ''}
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">{{ t('common.select') }}</option>
                        ${fieldConfig.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                `;
            } else if (fieldConfig.type === 'color' && fieldConfig.options) {
                fieldHTML += '<div class="grid grid-cols-4 gap-2">';
                Object.entries(fieldConfig.options).forEach(([name, hex]) => {
                    fieldHTML += `
                        <label class="cursor-pointer">
                            <input type="radio" name="variant_${fieldName}" value="${name}" ${required ? 'required' : ''}
                                   class="sr-only peer">
                            <div class="border-2 border-gray-300 peer-checked:border-primary rounded-lg p-2 hover:border-gray-400 transition text-center">
                                <div class="w-full h-8 rounded mb-1" style="background-color: ${hex}"></div>
                                <span class="text-xs text-gray-700 dark:text-gray-300">${name}</span>
                            </div>
                        </label>
                    `;
                });
                fieldHTML += '</div>';
            } else if (fieldConfig.type === 'number') {
                fieldHTML += `
                    <input type="number" name="variant_${fieldName}" ${required ? 'required' : ''}
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
                           placeholder="${label}">
                `;
            }
            
            fieldDiv.innerHTML = fieldHTML;
            variantContainer.appendChild(fieldDiv);
        });
    }
});
</script>
{% endblock %}

