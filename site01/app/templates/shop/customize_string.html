{% extends "base.html" %}

{% block title %}{{ t('customize.string_customizer') }} - {{ product.name_en }}{% endblock %}

{% block content %}
<section class="py-12 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Header -->
        <div class="mb-8">
            <a href="{{ url_for('shop.product_detail', product_id=product.id) }}" 
               class="inline-flex items-center text-primary hover:text-primary-dark transition mb-4">
                <i class="fas fa-arrow-left mr-2"></i>{{ t('common.back') }}
            </a>
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-sliders-h text-primary mr-3"></i>{{ t('customize.string_customizer') }}
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">{{ product.name_en }}</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- String Preview -->
            <div class="lg:col-span-3 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white text-center">
                        {{ t('customize.string_preview') }}
                    </h2>
                    <div class="relative w-full overflow-x-auto">
                        <!-- Canvas preview - simplified for custom implementation -->
                        <div id="string-preview-container" class="relative w-full h-[150px] border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-900 overflow-hidden">
                            <canvas id="string-canvas" width="1200" height="150" class="w-full h-full"></canvas>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center mt-3">
                        {{ t('customize.preview_description') }}
                    </p>
                </div>
            </div>

            <!-- Customization Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">
                        {{ t('customize.configure_string') }}
                    </h2>

                    <!-- String Length -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.string_length') }} *
                        </label>
                        <input type="number" 
                               id="string-length" 
                               min="40" 
                               max="75" 
                               step="0.25"
                               placeholder="68.5"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               onchange="updateSummary()">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                            {{ t('customize.length_hint_recurve') }}
                        </p>
                    </div>

                    <!-- Main String Material -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.string_material') }} *
                        </label>
                        <select id="string-material" 
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                onchange="loadMaterialColors('string')">
                            <option value="">{{ t('customize.select_material') }}</option>
                        </select>
                    </div>

                    <!-- Main String Color -->
                    <div class="mb-6" id="string-color-container" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.string_color') }} *
                        </label>
                        <div id="string-color-options" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                            <!-- Color options will be loaded here -->
                        </div>
                    </div>

                    <!-- Color Pattern (shown after first color selected) -->
                    <div class="mb-6" id="color-pattern-container" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.color_pattern') }}
                        </label>
                        <select id="color-pattern"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                onchange="updateColorPattern()">
                            <option value="single">{{ t('customize.pattern_single') }}</option>
                            <option value="double">{{ t('customize.pattern_double') }}</option>
                            <option value="triple">{{ t('customize.pattern_triple') }}</option>
                        </select>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                            {{ t('customize.pattern_hint') }}
                        </p>
                    </div>

                    <!-- Pinstripe Option (shown after base pattern selected) -->
                    <div class="mb-6" id="pinstripe-container" style="display: none;">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="add-pinstripe" 
                                   class="w-4 h-4 text-primary border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-primary"
                                   onchange="updateColorPattern()">
                            <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ t('customize.add_pinstripe') }}
                            </span>
                        </label>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-6">
                            {{ t('customize.pinstripe_hint') }}
                        </p>
                    </div>

                    <!-- Additional Colors (shown for multi-color patterns) -->
                    <div class="mb-6" id="additional-colors-container" style="display: none;">
                        <!-- Second Color -->
                        <div class="mb-4" id="color2-section">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ t('customize.second_color') }} *
                            </label>
                            <div id="string-color2-options" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                                <!-- Color options will be loaded here -->
                            </div>
                        </div>

                        <!-- Third Color (for triple pattern) -->
                        <div class="mb-4" id="color3-section" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ t('customize.third_color') }} *
                            </label>
                            <div id="string-color3-options" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                                <!-- Color options will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Number of Strands -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.strand_count') }} *
                        </label>
                        <input type="number" 
                               id="strand-count" 
                               min="8" 
                               max="24" 
                               step="2"
                               placeholder="16"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               onchange="updateSummary()">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                            {{ t('customize.strand_hint_recurve') }}
                        </p>
                    </div>

                    <!-- Nock Size -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.nock_size') }} *
                        </label>
                        <select id="nock-size"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                onchange="updateSummary()">
                            <option value="">{{ t('customize.select_nock_size') }}</option>
                            <option value="1">{{ t('customize.small_nock') }}</option>
                            <option value="2">{{ t('customize.large_nock') }}</option>
                        </select>
                    </div>

                    <!-- End Serving Material -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.end_serving_material') }} *
                        </label>
                        <select id="serving-material" 
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                onchange="loadMaterialColors('serving')">
                            <option value="">{{ t('customize.select_material') }}</option>
                        </select>
                    </div>

                    <!-- End Serving Color -->
                    <div class="mb-6" id="serving-color-container" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.end_serving_color') }} *
                        </label>
                        <div id="serving-color-options" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                            <!-- Color options will be loaded here -->
                        </div>
                    </div>

                    <!-- End Serving Length -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.end_serving_length') }}
                        </label>
                        <input type="number" 
                               id="end-serving-length" 
                               min="1" 
                               max="10" 
                               step="0.25"
                               value="2.5"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               onchange="updateSummary()">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                            {{ t('customize.end_serving_hint') }}
                        </p>
                    </div>

                    <!-- Center Serving (Always Included) -->
                    <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                        <h3 class="text-md font-semibold text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-bullseye text-blue-600 mr-2"></i>{{ t('customize.center_serving_section') }}
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Center Serving Type (Standard or Custom) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ t('customize.center_serving_type') }}
                                </label>
                                <select id="center-serving-type"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                        onchange="toggleCenterServingCustomization()">
                                    <option value="standard">{{ t('customize.center_serving_standard') }}</option>
                                    <option value="custom">{{ t('customize.center_serving_custom') }}</option>
                                </select>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    {{ t('customize.center_serving_type_hint') }}
                                </p>
                            </div>

                            <!-- Custom Center Serving Options (Hidden by default) -->
                            <div id="center-serving-custom-options" style="display: none;">
                                <!-- Center Serving Material -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('customize.center_serving_material') }} (+€{{ "%.2f"|format(pricing.different_center_serving_color) }})
                                    </label>
                                    <select id="center-serving-material" 
                                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                            onchange="loadMaterialColors('center')">
                                        <option value="">{{ t('customize.same_as_end_serving') }}</option>
                                    </select>
                                </div>

                                <!-- Center Serving Color -->
                                <div id="center-color-container" class="mb-4" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('customize.center_serving_color') }}
                                    </label>
                                    <div id="center-color-options" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                                        <!-- Color options will be loaded here -->
                                    </div>
                                </div>

                                <!-- Center Serving Length -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('customize.center_serving_length') }}
                                    </label>
                                    <input type="number" 
                                           id="center-serving-length" 
                                           min="3" 
                                           max="12" 
                                           step="0.25"
                                           value="6"
                                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           onchange="updateSummary()">
                                </div>

                                <!-- Center Serving Position -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('customize.center_serving_position') }}
                                    </label>
                                    <select id="center-serving-position"
                                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                            onchange="toggleCustomPosition()">
                                        <option value="middle">{{ t('customize.position_middle') }}</option>
                                        <option value="upper">{{ t('customize.position_upper') }}</option>
                                        <option value="lower">{{ t('customize.position_lower') }}</option>
                                        <option value="custom">{{ t('customize.position_custom') }}</option>
                                    </select>
                                </div>

                                <!-- Custom Position (Hidden by default) -->
                                <div id="custom-position-section" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ t('customize.custom_position') }}
                                    </label>
                                    <input type="number" 
                                           id="custom-position" 
                                           min="0" 
                                           step="0.25"
                                           placeholder="{{ t('customize.custom_position_placeholder') }}"
                                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           onchange="updateSummary()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pre-stretch Option -->
                    <div class="mb-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   id="pre-stretch"
                                   class="rounded border-gray-300 text-primary focus:ring-primary"
                                   onchange="updateSummary()">
                            <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ t('customize.pre_stretch') }}
                            </span>
                        </label>
                        <p class="ml-6 mt-1 text-xs text-gray-500 dark:text-gray-400">
                            {{ t('customize.pre_stretch_hint') }}
                        </p>
                    </div>

                    <!-- Have Existing String Option -->
                    <div class="mb-6 p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   id="have-existing-string"
                                   class="rounded border-gray-300 text-amber-600 focus:ring-amber-500"
                                   onchange="updateSummary()">
                            <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ t('customize.have_existing_string') }}
                            </span>
                        </label>
                        <p class="ml-6 mt-2 text-xs text-gray-600 dark:text-gray-400">
                            {{ t('customize.have_existing_string_hint') }}
                        </p>
                    </div>

                    <!-- Special Instructions -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.special_instructions') }}
                        </label>
                        <textarea id="special-instructions" 
                                  rows="3"
                                  placeholder="{{ t('customize.instructions_placeholder') }}"
                                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                </div>
            </div>

            <!-- Summary Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 sticky top-4">
                    <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">
                        {{ t('customize.configuration_summary') }}
                    </h3>

                    <div id="summary-content" class="space-y-3 mb-6 text-sm">
                        <p class="text-gray-500 dark:text-gray-400 italic">
                            {{ t('customize.select_options') }}
                        </p>
                    </div>

                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700 dark:text-gray-300">{{ t('customize.base_price') }}:</span>
                            <span class="font-semibold text-gray-900 dark:text-white" id="base-price">€15.00</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700 dark:text-gray-300">{{ t('customize.customization') }}:</span>
                            <span class="font-semibold text-gray-900 dark:text-white" id="custom-price">€0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold border-t border-gray-200 dark:border-gray-700 pt-2">
                            <span class="text-gray-900 dark:text-white">{{ t('customize.total') }}:</span>
                            <span class="text-primary" id="total-price">€15.00</span>
                        </div>
                    </div>

                    <button onclick="addToCart()" 
                            id="add-to-cart-btn"
                            disabled
                            class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-shopping-cart mr-2"></i>{{ t('customize.add_to_cart') }}
                    </button>

                    <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-4">
                        {{ t('customize.production_time') }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
let materials = [];
let selectedConfig = {
    length: null,
    stringMaterial: null,
    stringColor: null,
    stringColor2: null,
    stringColor3: null,
    colorPattern: 'single', // single, double, triple
    hasPinstripe: false,
    strandCount: null,
    nockSize: null,
    
    endServingMaterial: null,
    endServingColor: null,
    endServingLength: 2.5,
    
    // Center serving always included
    centerServingMaterial: null,
    centerServingColor: null,
    centerServingLength: 6,
    centerServingPosition: 'middle',
    centerServingCustomPosition: null,
    
    preStretch: false,
    haveExistingString: false,
    
    instructions: ''
};

// Get pricing from server (prevents manipulation)
const PRICING = {
    basePrice: {{ pricing.base_price }},
    colorPatternPrices: {{ pricing.color_pattern_prices | tojson }},
    pinstripePrice: {{ pricing.pinstripe_prices | tojson }},
    differentCenterServingColor: {{ pricing.different_center_serving_color }}
};

// Load materials on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadMaterials();
    updatePricingLabels(); // Add pricing info to labels
    updateSummary();
});

function updatePricingLabels() {
    // Update color pattern dropdown options
    const colorPatternSelect = document.getElementById('color-pattern');
    const options = colorPatternSelect.options;
    
    for (let i = 0; i < options.length; i++) {
        const option = options[i];
        const pattern = option.value;
        const price = PRICING.colorPatternPrices[pattern];
        
        if (price > 0) {
            const originalText = option.text.split(' (+')[0]; // Remove existing price if any
            option.text = `${originalText} (+€${price.toFixed(2)})`;
        }
    }
    
    // Update pinstripe checkbox label will be done dynamically in updateColorPattern()
}

async function loadMaterials() {
    try {
        const response = await fetch('/api/materiali');
        if (!response.ok) throw new Error('Failed to load materials');
        materials = await response.json();
        
        console.log('Materials loaded:', materials); // Debug
        
        // Populate string materials (corda)
        const stringMaterials = materials.filter(m => m.tipo === 'corda');
        console.log('String materials:', stringMaterials); // Debug
        populateSelect('string-material', stringMaterials);
        
        // Populate serving materials
        const servingMaterials = materials.filter(m => m.tipo === 'serving');
        console.log('Serving materials:', servingMaterials); // Debug
        populateSelect('serving-material', servingMaterials);
        populateSelect('center-serving-material', servingMaterials);
    } catch (error) {
        console.error('Error loading materials:', error);
        alert('{{ t("customize.error_loading_materials") }}');
    }
}

function populateSelect(selectId, materialsList) {
    const select = document.getElementById(selectId);
    if (!select) {
        console.error('Select not found:', selectId);
        return;
    }
    
    // Keep first option (placeholder)
    const firstOption = select.options[0];
    select.innerHTML = '';
    select.appendChild(firstOption);
    
    // Group materials - for serving, include thickness in grouping key
    const grouped = {};
    const isServingSelect = selectId.includes('serving');
    
    materialsList.forEach(m => {
        let key;
        if (isServingSelect && m.spessore) {
            // For serving materials, group by material + thickness
            key = `${m.materiale}|${m.spessore}`;
        } else {
            // For string materials, group by material name only
            key = m.materiale;
        }
        
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(m);
    });
    
    console.log('Grouped materials for', selectId, ':', grouped); // Debug
    
    // Add options
    Object.keys(grouped).sort().forEach(key => {
        const colors = grouped[key];
        const material = colors[0];
        const option = document.createElement('option');
        
        // Store the full key (material|thickness) or just material name
        if (isServingSelect && material.spessore) {
            option.value = key; // Store "Material|thickness"
            option.textContent = `${material.materiale} (${material.spessore}) - ${colors.length} {{ t("customize.colors") }}`;
        } else {
            option.value = material.materiale;
            option.textContent = `${material.materiale} (${colors.length} {{ t("customize.colors") }})`;
        }
        
        select.appendChild(option);
    });
}

function loadMaterialColors(type) {
    let materialSelect, materialName, thickness;
    
    if (type === 'string') {
        materialSelect = document.getElementById('string-material');
    } else if (type === 'string2' || type === 'string3') {
        // For additional colors, use the same material as the primary string
        materialName = selectedConfig.stringMaterial;
    } else if (type === 'serving') {
        materialSelect = document.getElementById('serving-material');
    } else if (type === 'center') {
        materialSelect = document.getElementById('center-serving-material');
    }
    
    if (materialSelect && !materialName) {
        const value = materialSelect.value;
        // Check if it's in "Material|thickness" format (for serving)
        if (value.includes('|')) {
            const parts = value.split('|');
            materialName = parts[0];
            thickness = parts[1];
        } else {
            materialName = value;
        }
    }
    
    if (!materialSelect && !materialName) {
        console.error('Material select not found for type:', type);
        return;
    }
    
    console.log('Loading colors for', type, ':', materialName, thickness ? `(${thickness})` : ''); // Debug
    
    if (!materialName) {
        // Hide color container if "same as" is selected for center
        if (type === 'center') {
            document.getElementById('center-color-container').style.display = 'none';
        }
        return;
    }
    
    // Filter materials by name and thickness (if applicable)
    let materialsList;
    if (thickness) {
        materialsList = materials.filter(m => m.materiale === materialName && m.spessore === thickness);
    } else {
        materialsList = materials.filter(m => m.materiale === materialName);
    }
    console.log('Filtered materials:', materialsList); // Debug
    
    const containerMap = {
        'string': 'string-color-container',
        'string2': 'additional-colors-container',
        'string3': 'additional-colors-container',
        'serving': 'serving-color-container',
        'center': 'center-color-container'
    };
    const optionsMap = {
        'string': 'string-color-options',
        'string2': 'string-color2-options',
        'string3': 'string-color3-options',
        'serving': 'serving-color-options',
        'center': 'center-color-options'
    };
    
    const container = document.getElementById(containerMap[type]);
    const optionsDiv = document.getElementById(optionsMap[type]);
    
    if (!container || !optionsDiv) {
        console.error('Container or options div not found for type:', type);
        return;
    }
    
    // Clear existing colors
    optionsDiv.innerHTML = '';
    
    // Add color options
    materialsList.forEach(material => {
        const colorBtn = document.createElement('button');
        colorBtn.type = 'button';
        colorBtn.className = 'relative p-3 rounded-lg border-2 border-transparent hover:border-primary transition flex flex-col items-center gap-2';
        colorBtn.onclick = () => selectColor(type, material);
        
        const colorSwatch = document.createElement('div');
        colorSwatch.className = 'w-12 h-12 rounded-lg shadow-md';
        colorSwatch.style.backgroundColor = getColorCode(material.colore);
        
        const colorName = document.createElement('span');
        colorName.className = 'text-xs text-gray-700 dark:text-gray-300 text-center';
        colorName.textContent = material.colore;
        
        colorBtn.appendChild(colorSwatch);
        colorBtn.appendChild(colorName);
        optionsDiv.appendChild(colorBtn);
    });
    
    container.style.display = 'block';
    updateSummary();
}

function selectColor(type, material) {
    console.log('Color selected:', type, material); // Debug
    
    // Update config
    if (type === 'string') {
        selectedConfig.stringMaterial = material.materiale;
        selectedConfig.stringColor = material.colore;
        // Show color pattern options after first color is selected
        document.getElementById('color-pattern-container').style.display = 'block';
        document.getElementById('pinstripe-container').style.display = 'block';
    } else if (type === 'string2') {
        selectedConfig.stringColor2 = material.colore;
    } else if (type === 'string3') {
        selectedConfig.stringColor3 = material.colore;
    } else if (type === 'serving') {
        selectedConfig.endServingMaterial = material.materiale;
        selectedConfig.endServingColor = material.colore;
    } else if (type === 'center') {
        selectedConfig.centerServingMaterial = material.materiale;
        selectedConfig.centerServingColor = material.colore;
    }
    
    // Visual feedback
    const optionsMap = {
        'string': 'string-color-options',
        'string2': 'string-color2-options',
        'string3': 'string-color3-options',
        'serving': 'serving-color-options',
        'center': 'center-color-options'
    };
    const optionsDiv = document.getElementById(optionsMap[type]);
    if (optionsDiv) {
        optionsDiv.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('border-primary', 'bg-primary/10');
        });
        event.currentTarget.classList.add('border-primary', 'bg-primary/10');
    }
    
    updateSummary();
}

function updateColorPattern() {
    const pattern = document.getElementById('color-pattern').value;
    const hasPinstripe = document.getElementById('add-pinstripe').checked;
    
    selectedConfig.colorPattern = pattern;
    selectedConfig.hasPinstripe = hasPinstripe;
    
    const pinstripeContainer = document.getElementById('pinstripe-container');
    const additionalColorsContainer = document.getElementById('additional-colors-container');
    const color2Section = document.getElementById('color2-section');
    const color3Section = document.getElementById('color3-section');
    
    // Show pinstripe checkbox after pattern is selected and update its label with price
    pinstripeContainer.style.display = 'block';
    const pinstripePrice = PRICING.pinstripePrice[pattern] || 0;
    const pinstripeLabel = pinstripeContainer.querySelector('span');
    if (pinstripePrice > 0) {
        pinstripeLabel.innerHTML = `{{ t("customize.add_pinstripe") }} (+€${pinstripePrice.toFixed(2)})`;
    } else {
        pinstripeLabel.innerHTML = `{{ t("customize.add_pinstripe") }}`;
    }
    
    // Determine how many colors are needed
    let needsColor2 = false;
    let needsColor3 = false;
    
    if (pattern === 'single') {
        // Single color: pinstripe becomes 2nd color
        needsColor2 = hasPinstripe;
    } else if (pattern === 'double') {
        // Double color: always needs 2nd, pinstripe becomes 3rd
        needsColor2 = true;
        needsColor3 = hasPinstripe;
    } else if (pattern === 'triple') {
        // Triple color: always needs 2nd and 3rd, pinstripe checkbox disabled
        needsColor2 = true;
        needsColor3 = true;
        document.getElementById('add-pinstripe').disabled = true;
        document.getElementById('add-pinstripe').checked = false;
        selectedConfig.hasPinstripe = false;
    } else {
        // Re-enable pinstripe checkbox for single/double
        document.getElementById('add-pinstripe').disabled = false;
    }
    
    // Show/hide additional color sections
    if (needsColor2 || needsColor3) {
        additionalColorsContainer.style.display = 'block';
        color2Section.style.display = needsColor2 ? 'block' : 'none';
        color3Section.style.display = needsColor3 ? 'block' : 'none';
        
        // Update labels based on whether it's a pinstripe or not
        const color2Label = document.querySelector('#color2-section label');
        const color3Label = document.querySelector('#color3-section label');
        
        if (pattern === 'single' && hasPinstripe) {
            color2Label.innerHTML = '{{ t("customize.pinstripe_color") }} *';
        } else if (pattern === 'double' && !hasPinstripe) {
            color2Label.innerHTML = '{{ t("customize.second_color") }} *';
        } else if (pattern === 'double' && hasPinstripe) {
            color2Label.innerHTML = '{{ t("customize.second_color") }} *';
            color3Label.innerHTML = '{{ t("customize.pinstripe_color") }} *';
        } else if (pattern === 'triple') {
            color2Label.innerHTML = '{{ t("customize.second_color") }} *';
            color3Label.innerHTML = '{{ t("customize.third_color") }} *';
        }
        
        // Load colors if not already loaded
        if (selectedConfig.stringMaterial) {
            if (needsColor2 && document.getElementById('string-color2-options').children.length === 0) {
                loadMaterialColors('string2');
            }
            if (needsColor3 && document.getElementById('string-color3-options').children.length === 0) {
                loadMaterialColors('string3');
            }
        }
    } else {
        additionalColorsContainer.style.display = 'none';
    }
    
    // Reset colors that are no longer needed
    if (!needsColor2) {
        selectedConfig.stringColor2 = null;
    }
    if (!needsColor3) {
        selectedConfig.stringColor3 = null;
    }
    
    updateSummary();
}

function getColorCode(colorName) {
    const colors = {
        'black': '#000000', 'nero': '#000000',
        'white': '#FFFFFF', 'bianco': '#FFFFFF',
        'red': '#FF0000', 'rosso': '#FF0000',
        'blue': '#0000FF', 'blu': '#0000FF',
        'green': '#00FF00', 'verde': '#00FF00',
        'yellow': '#FFFF00', 'giallo': '#FFFF00',
        'orange': '#FFA500', 'arancione': '#FFA500',
        'purple': '#800080', 'viola': '#800080',
        'pink': '#FFC0CB', 'rosa': '#FFC0CB',
        'brown': '#8B4513', 'marrone': '#8B4513',
        'gray': '#808080', 'grigio': '#808080',
        'grey': '#808080', 'silver': '#C0C0C0', 'argento': '#C0C0C0',
        'gold': '#FFD700', 'oro': '#FFD700'
    };
    
    const nameLower = colorName.toLowerCase();
    
    // Check if it's a "Fluo" color
    const isFluo = nameLower.includes('fluo');
    
    // Try to find the base color by removing "fluo" and extra spaces
    let baseColorName = nameLower.replace(/fluo/g, '').trim();
    
    // Get the base color code
    let colorCode = colors[baseColorName] || colors[nameLower] || '#CCCCCC';
    
    // If it's a Fluo color, make it brighter and more vibrant
    if (isFluo && colorCode !== '#CCCCCC') {
        colorCode = makeFluoColor(colorCode);
    }
    
    return colorCode;
}

function makeFluoColor(hexColor) {
    // Convert hex to RGB
    const r = parseInt(hexColor.slice(1, 3), 16);
    const g = parseInt(hexColor.slice(3, 5), 16);
    const b = parseInt(hexColor.slice(5, 7), 16);
    
    // Increase saturation and brightness for fluo effect
    // Convert to HSL for easier manipulation
    const max = Math.max(r, g, b) / 255;
    const min = Math.min(r, g, b) / 255;
    const l = (max + min) / 2;
    
    let h, s;
    if (max === min) {
        h = s = 0;
    } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        
        if (max === r / 255) h = ((g / 255 - b / 255) / d + (g < b ? 6 : 0)) / 6;
        else if (max === g / 255) h = ((b / 255 - r / 255) / d + 2) / 6;
        else h = ((r / 255 - g / 255) / d + 4) / 6;
    }
    
    // Boost saturation and lightness for fluo effect
    s = Math.min(1, s * 1.5 + 0.3); // Increase saturation
    const newL = Math.min(0.7, l * 1.3); // Increase brightness but not too much
    
    // Convert back to RGB
    function hslToRgb(h, s, l) {
        let r, g, b;
        if (s === 0) {
            r = g = b = l;
        } else {
            const hue2rgb = (p, q, t) => {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1/6) return p + (q - p) * 6 * t;
                if (t < 1/2) return q;
                if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
            };
            const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            const p = 2 * l - q;
            r = hue2rgb(p, q, h + 1/3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1/3);
        }
        return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
    }
    
    const [newR, newG, newB] = hslToRgb(h, s, newL);
    
    // Convert back to hex
    return '#' + [newR, newG, newB].map(x => {
        const hex = x.toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    }).join('').toUpperCase();
}

function toggleCenterServingCustomization() {
    const type = document.getElementById('center-serving-type').value;
    const customOptions = document.getElementById('center-serving-custom-options');
    
    if (type === 'custom') {
        customOptions.style.display = 'block';
    } else {
        customOptions.style.display = 'none';
        // Reset custom settings to standard
        selectedConfig.centerServingMaterial = null;
        selectedConfig.centerServingColor = null;
        selectedConfig.centerServingLength = 6;
        selectedConfig.centerServingPosition = 'middle';
        selectedConfig.centerServingCustomPosition = null;
    }
    updateSummary();
}

function toggleCustomPosition() {
    const position = document.getElementById('center-serving-position').value;
    const customSection = document.getElementById('custom-position-section');
    customSection.style.display = position === 'custom' ? 'block' : 'none';
    updateSummary();
}

function updateSummary() {
    // Collect all configuration values
    selectedConfig.length = parseFloat(document.getElementById('string-length').value) || null;
    selectedConfig.strandCount = parseInt(document.getElementById('strand-count').value) || null;
    selectedConfig.nockSize = document.getElementById('nock-size').value;
    selectedConfig.endServingLength = parseFloat(document.getElementById('end-serving-length').value) || 2.5;
    selectedConfig.centerServingLength = parseFloat(document.getElementById('center-serving-length').value) || 6;
    selectedConfig.centerServingPosition = document.getElementById('center-serving-position').value || 'middle';
    selectedConfig.centerServingCustomPosition = parseFloat(document.getElementById('custom-position')?.value) || null;
    selectedConfig.preStretch = document.getElementById('pre-stretch').checked;
    selectedConfig.haveExistingString = document.getElementById('have-existing-string').checked;
    selectedConfig.instructions = document.getElementById('special-instructions').value;
    
    // If center serving material not selected, use end serving
    if (!selectedConfig.centerServingMaterial && selectedConfig.endServingMaterial) {
        selectedConfig.centerServingMaterial = selectedConfig.endServingMaterial;
        selectedConfig.centerServingColor = selectedConfig.endServingColor;
    }
    
    // Build summary HTML
    const summaryDiv = document.getElementById('summary-content');
    let html = '';
    
    if (selectedConfig.length) {
        html += `<div><span class="font-semibold">{{ t("customize.length") }}:</span> ${selectedConfig.length}"</div>`;
    }
    if (selectedConfig.stringMaterial && selectedConfig.stringColor) {
        let colorText = selectedConfig.stringColor;
        
        // Build color description based on pattern and pinstripe
        if (selectedConfig.colorPattern === 'single' && selectedConfig.hasPinstripe && selectedConfig.stringColor2) {
            colorText = `${selectedConfig.stringColor} with ${selectedConfig.stringColor2} pinstripe`;
        } else if (selectedConfig.colorPattern === 'double' && selectedConfig.stringColor2) {
            if (selectedConfig.hasPinstripe && selectedConfig.stringColor3) {
                colorText = `${selectedConfig.stringColor} + ${selectedConfig.stringColor2} with ${selectedConfig.stringColor3} pinstripe`;
            } else {
                colorText = `${selectedConfig.stringColor} + ${selectedConfig.stringColor2}`;
            }
        } else if (selectedConfig.colorPattern === 'triple' && selectedConfig.stringColor2 && selectedConfig.stringColor3) {
            colorText = `${selectedConfig.stringColor} + ${selectedConfig.stringColor2} + ${selectedConfig.stringColor3}`;
        }
        
        html += `<div><span class="font-semibold">{{ t("customize.string") }}:</span> ${selectedConfig.stringMaterial} - ${colorText}</div>`;
    }
    if (selectedConfig.strandCount) {
        html += `<div><span class="font-semibold">{{ t("customize.strands") }}:</span> ${selectedConfig.strandCount}</div>`;
    }
    if (selectedConfig.nockSize) {
        const nockText = selectedConfig.nockSize === '1' ? '{{ t("customize.small") }}' : '{{ t("customize.large") }}';
        html += `<div><span class="font-semibold">{{ t("customize.nock") }}:</span> ${nockText}</div>`;
    }
    if (selectedConfig.endServingMaterial && selectedConfig.endServingColor) {
        html += `<div><span class="font-semibold">{{ t("customize.end_serving") }}:</span> ${selectedConfig.endServingMaterial} - ${selectedConfig.endServingColor} (${selectedConfig.endServingLength}")</div>`;
    }
    
    // Center serving (always shown)
    const centerMat = selectedConfig.centerServingMaterial || selectedConfig.endServingMaterial || '{{ t("customize.not_selected") }}';
    const centerCol = selectedConfig.centerServingColor || selectedConfig.endServingColor || '';
    if (centerMat !== '{{ t("customize.not_selected") }}') {
        html += `<div><span class="font-semibold">{{ t("customize.center_serving") }}:</span> ${centerMat} - ${centerCol} (${selectedConfig.centerServingLength}")</div>`;
    }
    
    if (selectedConfig.preStretch) {
        html += `<div class="text-blue-600 dark:text-blue-400"><i class="fas fa-check mr-1"></i>{{ t("customize.prestretched") }}</div>`;
    }
    if (selectedConfig.haveExistingString) {
        html += `<div class="text-amber-600 dark:text-amber-400"><i class="fas fa-copy mr-1"></i>{{ t("customize.copy_existing") }}</div>`;
    }
    
    summaryDiv.innerHTML = html || '<p class="text-gray-500 dark:text-gray-400 italic">{{ t("customize.select_options") }}</p>';
    
    // Check if all required fields are filled
    let isValid = selectedConfig.length && 
                    selectedConfig.stringMaterial && 
                    selectedConfig.stringColor && 
                    selectedConfig.strandCount && 
                    selectedConfig.nockSize &&
                    selectedConfig.endServingMaterial && 
                    selectedConfig.endServingColor;
    
    // Additional validation for multicolor patterns
    if (isValid) {
        // Single + pinstripe: needs 2nd color
        if (selectedConfig.colorPattern === 'single' && selectedConfig.hasPinstripe) {
            isValid = isValid && selectedConfig.stringColor2;
        }
        // Double: always needs 2nd color
        else if (selectedConfig.colorPattern === 'double') {
            isValid = isValid && selectedConfig.stringColor2;
            // Double + pinstripe: also needs 3rd color
            if (selectedConfig.hasPinstripe) {
                isValid = isValid && selectedConfig.stringColor3;
            }
        }
        // Triple: always needs 2nd and 3rd colors
        else if (selectedConfig.colorPattern === 'triple') {
            isValid = isValid && selectedConfig.stringColor2 && selectedConfig.stringColor3;
        }
    }
    
    document.getElementById('add-to-cart-btn').disabled = !isValid;
    
    // Update pricing
    updatePrice();
    
    // Redraw preview
    drawStringPreview();
}

function updatePrice() {
    // Calculate price client-side for immediate feedback using server-provided pricing
    let totalPrice = PRICING.basePrice;
    let customizationCost = 0;
    
    // String color pattern costs
    const patternCost = PRICING.colorPatternPrices[selectedConfig.colorPattern] || 0;
    customizationCost += patternCost;
    
    // Pinstripe costs
    if (selectedConfig.hasPinstripe) {
        const pinstripeCost = PRICING.pinstripePrice[selectedConfig.colorPattern] || 0;
        customizationCost += pinstripeCost;
    }
    
    // Extra cost if center serving color is different from end serving
    if (selectedConfig.centerServingColor && 
        selectedConfig.endServingColor &&
        selectedConfig.centerServingColor.toLowerCase() !== selectedConfig.endServingColor.toLowerCase()) {
        customizationCost += PRICING.differentCenterServingColor;
    }
    
    const total = totalPrice + customizationCost;
    
    document.getElementById('base-price').textContent = `€${totalPrice.toFixed(2)}`;
    document.getElementById('custom-price').textContent = `€${customizationCost.toFixed(2)}`;
    document.getElementById('total-price').textContent = `€${total.toFixed(2)}`;
    
    // Validate price with server (debounced)
    clearTimeout(window.priceValidationTimer);
    window.priceValidationTimer = setTimeout(validatePriceWithServer, 500);
}

async function validatePriceWithServer() {
    // Only validate if configuration is complete enough
    if (!selectedConfig.stringMaterial || !selectedConfig.stringColor) {
        return;
    }
    
    try {
        const response = await fetch('/shop/api/calculate-string-price', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(selectedConfig)
        });
        
        if (!response.ok) {
            console.warn('Price validation failed');
            return;
        }
        
        const serverPrice = await response.json();
        const clientTotal = parseFloat(document.getElementById('total-price').textContent.replace('€', ''));
        
        // Check if prices match (allow 0.01 difference for rounding)
        if (Math.abs(clientTotal - serverPrice.total) > 0.01) {
            console.error('Price mismatch! Client:', clientTotal, 'Server:', serverPrice.total);
            // Update to server price
            document.getElementById('base-price').textContent = `€${serverPrice.base.toFixed(2)}`;
            document.getElementById('custom-price').textContent = `€${serverPrice.customization.toFixed(2)}`;
            document.getElementById('total-price').textContent = `€${serverPrice.total.toFixed(2)}`;
        }
    } catch (error) {
        console.error('Error validating price:', error);
    }
}

function drawStringPreview() {
    // Get canvas
    const canvas = document.getElementById('string-canvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas
    const isDark = document.documentElement.classList.contains('dark');
    const bgColor = isDark ? '#111827' : '#F9FAFB';
    
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, width, height);
    
    // Get configuration
    const strandCount = selectedConfig.strandCount || 16;
    const stringColor = selectedConfig.stringColor ? getColorCode(selectedConfig.stringColor) : '#8B4513';
    const servingColor = selectedConfig.endServingColor ? getColorCode(selectedConfig.endServingColor) : '#000000';
    const centerServingColor = selectedConfig.centerServingColor ? getColorCode(selectedConfig.centerServingColor) : servingColor;
    const stringLength = selectedConfig.length || 68;
    
    // Build color array based on pattern and pinstripe
    const colors = [];
    
    // Determine strand colors based on color pattern
    if (selectedConfig.colorPattern === 'single') {
        // Single color
        for (let i = 0; i < strandCount; i++) {
            if (selectedConfig.hasPinstripe && selectedConfig.stringColor2 && i === 0) {
                colors.push(getColorCode(selectedConfig.stringColor2)); // Pinstripe at position 0
            } else {
                colors.push(stringColor);
            }
        }
    } else if (selectedConfig.colorPattern === 'double') {
        // Double color
        const color2 = selectedConfig.stringColor2 ? getColorCode(selectedConfig.stringColor2) : stringColor;
        for (let i = 0; i < strandCount; i++) {
            if (selectedConfig.hasPinstripe && selectedConfig.stringColor3) {
                // Pinstripes at positions 0 and halfway
                if (i === 0 || i === Math.floor(strandCount / 2)) {
                    colors.push(getColorCode(selectedConfig.stringColor3));
                } else if (i < strandCount / 2) {
                    colors.push(stringColor);
                } else {
                    colors.push(color2);
                }
            } else {
                // No pinstripe - just split in half
                if (i < strandCount / 2) {
                    colors.push(stringColor);
                } else {
                    colors.push(color2);
                }
            }
        }
    } else if (selectedConfig.colorPattern === 'triple') {
        // Triple color
        const color2 = selectedConfig.stringColor2 ? getColorCode(selectedConfig.stringColor2) : stringColor;
        const color3 = selectedConfig.stringColor3 ? getColorCode(selectedConfig.stringColor3) : stringColor;
        for (let i = 0; i < strandCount; i++) {
            if (i < strandCount / 3) {
                colors.push(stringColor);
            } else if (i < (strandCount / 3) * 2) {
                colors.push(color2);
            } else {
                colors.push(color3);
            }
        }
    } else {
        // Fallback - all same color
        for (let i = 0; i < strandCount; i++) {
            colors.push(stringColor);
        }
    }
    
    // Drawing parameters (similar to C# implementation)
    const w = width;
    const h = height;
    const strandWidth = 11; // Width of each strand (12 - 1px margin)
    const spacing = 13; // Total spacing between strand centers (11px strand + 1px margin + 1px gap)
    const length = spacing * strandCount; // Total vertical space per repetition
    
    // Calculate how many repetitions needed to fill canvas
    // The pattern starts above the canvas and goes diagonally
    const xi = -30;
    const xf = w + 30;
    const y1 = h;
    const y0 = -h - 90;
    
    // Calculate required repetitions to fill from top (y=0) to bottom (y=h)
    // Add extra repetitions to ensure full coverage
    const repetitionsNeeded = Math.ceil((h + Math.abs(y0)) / length) + 4; // +4 for safety margin
    
    // Draw the twisted string pattern
    for (let j = 0; j < repetitionsNeeded; j++) {
        for (let i = 0; i < strandCount; i++) {
            // Coordinates for diagonal lines
            const yi = y0 + i * spacing + j * length;
            const yf = y1 + i * spacing + j * length;
            
            // Draw strand
            ctx.strokeStyle = colors[i];
            ctx.lineWidth = strandWidth;
            ctx.lineCap = 'round';
            
            ctx.beginPath();
            ctx.moveTo(xi, yi);
            ctx.lineTo(xf, yf);
            ctx.stroke();
        }
    }
}

async function addToCart() {
    if (document.getElementById('add-to-cart-btn').disabled) {
        return;
    }
    
    const addButton = document.getElementById('add-to-cart-btn');
    const originalText = addButton.innerHTML;
    
    try {
        // Disable button and show loading
        addButton.disabled = true;
        addButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>{{ t("customize.adding") }}...';
        
        // Get client-side price
        const clientPrice = parseFloat(document.getElementById('total-price').textContent.replace('€', ''));
        
        // Send to server for validation and processing
        const response = await fetch('/shop/api/add-to-cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                productId: {{ product.id }},
                name: '{{ product.name_en }}',
                type: 'custom_string',
                config: selectedConfig,
                price: clientPrice
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            // Server rejected (price mismatch or validation error)
            showNotification(result.error || 'Error adding to cart', 'error');
            
            // If price mismatch, update display with correct price
            if (result.expected_price) {
                document.getElementById('total-price').textContent = `€${result.expected_price.toFixed(2)}`;
                showNotification('Price has been updated. Please review and try again.', 'warning');
            }
            
            addButton.disabled = false;
            addButton.innerHTML = originalText;
            return;
        }
        
        // Success - add to localStorage cart with server-validated price
        const cartItem = {
            productId: {{ product.id }},
            name: '{{ product.name_en }}',
            type: 'custom_string',
            config: selectedConfig,
            price: result.price,  // Use server-validated price
            priceBreakdown: result.price_breakdown
        };
        
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.push(cartItem);
        localStorage.setItem('cart', JSON.stringify(cart));
        
        showNotification('{{ t("customize.added_to_cart") }}', 'success');
        
        setTimeout(() => {
            window.location.href = '/shop/cart';
        }, 1500);
        
    } catch (error) {
        console.error('Error adding to cart:', error);
        showNotification('Error adding to cart. Please try again.', 'error');
        addButton.disabled = false;
        addButton.innerHTML = originalText;
    }
}

function showNotification(message, type = 'success') {
    const bgColor = type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-green-500';
    const icon = type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle';
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    notification.innerHTML = `<i class="fas ${icon} mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>

{% endblock %}
