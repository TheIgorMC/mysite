{% extends "base.html" %}

{% block title %}{{ t('customize.string_customizer') }} - {{ product.name_en }}{% endblock %}

{% block content %}
<section class="py-12 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Header -->
        <div class="mb-8">
            <a href="{{ url_for('shop.product_detail', product_id=product.id) }}" 
               class="inline-flex items-center text-primary hover:text-primary-dark transition mb-4">
                <i class="fas fa-arrow-left mr-2"></i>{{ t('common.back') }}
            </a>
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-sliders-h text-primary mr-3"></i>{{ t('customize.string_customizer') }}
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">{{ product.name_en }}</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- String Preview Canvas -->
            <div class="lg:col-span-3 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white text-center">
                        {{ t('customize.string_preview') }}
                    </h2>
                    <div class="relative w-full overflow-x-auto">
                        <canvas id="string-canvas" 
                                width="1200" 
                                height="150" 
                                class="w-full border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-900">
                        </canvas>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center mt-3">
                        {{ t('customize.preview_description') }}
                    </p>
                </div>
            </div>

            <!-- Customization Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">
                        {{ t('customize.configure_string') }}
                    </h2>

                    <!-- String Type -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.string_type') }} *
                        </label>
                        <select id="string-type" 
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                onchange="updateSummary()">
                            <option value="">{{ t('customize.select_string_type') }}</option>
                            <option value="recurve">{{ t('customize.recurve') }}</option>
                            <option value="compound">{{ t('customize.compound') }}</option>
                        </select>
                    </div>

                    <!-- Length -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.string_length') }} (inches) *
                        </label>
                        <input type="number" 
                               id="string-length" 
                               min="40" 
                               max="75" 
                               step="0.25"
                               placeholder="e.g., 68.5"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               onchange="updateSummary()">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                            {{ t('customize.length_hint') }}
                        </p>
                    </div>

                    <!-- Main String Material -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.string_material') }} *
                        </label>
                        <select id="string-material" 
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                onchange="loadMaterialColors('string'); updateSummary()">
                            <option value="">{{ t('customize.loading_materials') }}</option>
                        </select>
                    </div>

                    <!-- Main String Color -->
                    <div class="mb-6" id="string-color-container" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.string_color') }} *
                        </label>
                        <div id="string-color-options" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                            <!-- Color options will be loaded here -->
                        </div>
                    </div>

                    <!-- Number of Strands -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.strand_count') }} *
                        </label>
                        <input type="number" 
                               id="strand-count" 
                               min="8" 
                               max="24" 
                               step="2"
                               placeholder="e.g., 16"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               onchange="updateSummary()">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                            {{ t('customize.strand_hint') }}
                        </p>
                    </div>

                    <!-- Nock Size -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.nock_size') }} *
                        </label>
                        <select id="nock-size"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                onchange="updateSummary()">
                            <option value="">{{ t('customize.select_nock_size') }}</option>
                            <option value="1">{{ t('customize.small_nock') }}</option>
                            <option value="2">{{ t('customize.large_nock') }}</option>
                        </select>
                    </div>

                    <!-- End Serving Material -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.end_serving_material') }} *
                        </label>
                        <select id="serving-material" 
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                onchange="loadMaterialColors('serving'); updateSummary()">
                            <option value="">{{ t('customize.loading_materials') }}</option>
                        </select>
                    </div>

                    <!-- End Serving Color -->
                    <div class="mb-6" id="serving-color-container" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.end_serving_color') }} *
                        </label>
                        <div id="serving-color-options" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                            <!-- Color options will be loaded here -->
                        </div>
                    </div>

                    <!-- End Serving Length -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.end_serving_length') }} (inches)
                        </label>
                        <input type="number" 
                               id="end-serving-length" 
                               min="1" 
                               max="10" 
                               step="0.25"
                               value="2.5"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               onchange="updateSummary()">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                            {{ t('customize.end_serving_hint') }}
                        </p>
                    </div>

                    <!-- Center Serving (Optional) -->
                    <div class="mb-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   id="include-center-serving"
                                   class="rounded border-gray-300 text-primary focus:ring-primary"
                                   onchange="toggleCenterServing()">
                            <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ t('customize.add_center_serving') }}
                            </span>
                        </label>
                    </div>

                    <!-- Center Serving Options (Hidden by default) -->
                    <div id="center-serving-options" style="display: none;">
                        <div class="mb-6 pl-6 border-l-2 border-primary space-y-4">
                            <!-- Center Serving Material -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ t('customize.center_serving_material') }}
                                </label>
                                <select id="center-serving-material" 
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                        onchange="loadMaterialColors('center'); updateSummary()">
                                    <option value="">{{ t('customize.same_as_end_serving') }}</option>
                                </select>
                            </div>

                            <!-- Center Serving Color -->
                            <div id="center-color-container" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ t('customize.center_serving_color') }}
                                </label>
                                <div id="center-color-options" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                                    <!-- Color options will be loaded here -->
                                </div>
                            </div>

                            <!-- Center Serving Length -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ t('customize.center_serving_length') }} (inches)
                                </label>
                                <input type="number" 
                                       id="center-serving-length" 
                                       min="3" 
                                       max="12" 
                                       step="0.25"
                                       value="6"
                                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                       onchange="updateSummary()">
                            </div>

                            <!-- Center Serving Position -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ t('customize.center_serving_position') }}
                                </label>
                                <select id="center-serving-position"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                        onchange="toggleCustomPosition(); updateSummary()">
                                    <option value="middle">{{ t('customize.position_middle') }}</option>
                                    <option value="upper">{{ t('customize.position_upper') }}</option>
                                    <option value="lower">{{ t('customize.position_lower') }}</option>
                                    <option value="custom">{{ t('customize.position_custom') }}</option>
                                </select>
                            </div>

                            <!-- Custom Position (Hidden by default) -->
                            <div id="custom-position-section" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ t('customize.custom_position') }}
                                </label>
                                <input type="number" 
                                       id="custom-position" 
                                       min="0" 
                                       step="0.25"
                                       placeholder="inches from bottom"
                                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                       onchange="updateSummary()">
                            </div>
                        </div>
                    </div>

                    <!-- Pre-stretch Option -->
                    <div class="mb-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   id="pre-stretch"
                                   class="rounded border-gray-300 text-primary focus:ring-primary"
                                   onchange="updateSummary()">
                            <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ t('customize.pre_stretch') }}
                            </span>
                        </label>
                        <p class="ml-6 mt-1 text-xs text-gray-500 dark:text-gray-400">
                            {{ t('customize.pre_stretch_hint') }}
                        </p>
                    </div>

                    <!-- Have Existing String Option -->
                    <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   id="have-existing-string"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                   onchange="updateSummary()">
                            <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ t('customize.have_existing_string') }}
                            </span>
                        </label>
                        <p class="ml-6 mt-2 text-xs text-gray-600 dark:text-gray-400">
                            {{ t('customize.have_existing_string_hint') }}
                        </p>
                    </div>

                    <!-- Special Instructions -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ t('customize.special_instructions') }}
                        </label>
                        <textarea id="special-instructions" 
                                  rows="3"
                                  placeholder="{{ t('customize.instructions_placeholder') }}"
                                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                </div>
            </div>

            <!-- Summary Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 sticky top-4">
                    <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">
                        {{ t('customize.configuration_summary') }}
                    </h3>

                    <div id="summary-content" class="space-y-3 mb-6 text-sm">
                        <p class="text-gray-500 dark:text-gray-400 italic">
                            {{ t('customize.select_options') }}
                        </p>
                    </div>

                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700 dark:text-gray-300">{{ t('customize.base_price') }}:</span>
                            <span class="font-semibold text-gray-900 dark:text-white" id="base-price">€15.00</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700 dark:text-gray-300">{{ t('customize.customization') }}:</span>
                            <span class="font-semibold text-gray-900 dark:text-white" id="custom-price">€0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold border-t border-gray-200 dark:border-gray-700 pt-2">
                            <span class="text-gray-900 dark:text-white">{{ t('customize.total') }}:</span>
                            <span class="text-primary" id="total-price">€15.00</span>
                        </div>
                    </div>

                    <button onclick="addToCart()" 
                            id="add-to-cart-btn"
                            disabled
                            class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-shopping-cart mr-2"></i>{{ t('customize.add_to_cart') }}
                    </button>

                    <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-4">
                        {{ t('customize.production_time') }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
let materials = [];
let selectedConfig = {
    stringType: null,
    length: null,
    stringMaterial: null,
    stringColor: null,
    strandCount: null,
    nockSize: null,
    
    endServingMaterial: null,
    endServingColor: null,
    endServingLength: 2.5,
    
    centerServing: false,
    centerServingMaterial: null,
    centerServingColor: null,
    centerServingLength: 6,
    centerServingPosition: 'middle',
    centerServingCustomPosition: null,
    
    preStretch: false,
    haveExistingString: false,
    
    instructions: ''
};

const basePrice = 15.00;

// Load materials on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadMaterials();
    updateSummary();
});

async function loadMaterials() {
    try {
        const response = await fetch('/api/materiali');
        if (!response.ok) throw new Error('Failed to load materials');
        materials = await response.json();
        
        // Populate string materials (corda)
        const stringMaterials = materials.filter(m => m.tipo === 'corda');
        populateSelect('string-material', stringMaterials);
        
        // Populate serving materials
        const servingMaterials = materials.filter(m => m.tipo === 'serving');
        populateSelect('serving-material', servingMaterials);
        populateSelect('center-serving-material', servingMaterials, true); // true = add "same as" option
    } catch (error) {
        console.error('Error loading materials:', error);
    }
}

function populateSelect(selectId, materialsList, addSameAsOption = false) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Clear existing options except first
    select.innerHTML = select.options[0].outerHTML;
    
    // Group materials by name
    const grouped = {};
    materialsList.forEach(m => {
        if (!grouped[m.nome]) grouped[m.nome] = [];
        grouped[m.nome].push(m);
    });
    
    // Add options
    Object.keys(grouped).sort().forEach(name => {
        const colors = grouped[name];
        const option = document.createElement('option');
        option.value = name;
        option.textContent = `${name} (${colors.length} colors)`;
        select.appendChild(option);
    });
}

function loadMaterialColors(type) {
    const materialName = document.getElementById(`${type === 'string' ? 'string' : type === 'serving' ? 'serving' : 'center-serving'}-material`).value;
    if (!materialName) return;
    
    const materialsList = materials.filter(m => m.nome === materialName);
    const containerMap = {
        'string': 'string-color-container',
        'serving': 'serving-color-container',
        'center': 'center-color-container'
    };
    const optionsMap = {
        'string': 'string-color-options',
        'serving': 'serving-color-options',
        'center': 'center-color-options'
    };
    
    const container = document.getElementById(containerMap[type]);
    const optionsDiv = document.getElementById(optionsMap[type]);
    
    if (!container || !optionsDiv) return;
    
    // Clear existing colors
    optionsDiv.innerHTML = '';
    
    // Add color options
    materialsList.forEach(material => {
        const colorBtn = document.createElement('button');
        colorBtn.type = 'button';
        colorBtn.className = 'relative p-3 rounded-lg border-2 border-transparent hover:border-primary transition flex flex-col items-center gap-2';
        colorBtn.onclick = () => selectColor(type, material);
        
        const colorSwatch = document.createElement('div');
        colorSwatch.className = 'w-12 h-12 rounded-lg shadow-md';
        colorSwatch.style.backgroundColor = getColorCode(material.colore);
        
        const colorName = document.createElement('span');
        colorName.className = 'text-xs text-gray-700 dark:text-gray-300 text-center';
        colorName.textContent = material.colore;
        
        colorBtn.appendChild(colorSwatch);
        colorBtn.appendChild(colorName);
        optionsDiv.appendChild(colorBtn);
    });
    
    container.style.display = 'block';
}

function selectColor(type, material) {
    // Update config
    if (type === 'string') {
        selectedConfig.stringMaterial = material.nome;
        selectedConfig.stringColor = material.colore;
    } else if (type === 'serving') {
        selectedConfig.endServingMaterial = material.nome;
        selectedConfig.endServingColor = material.colore;
    } else if (type === 'center') {
        selectedConfig.centerServingMaterial = material.nome;
        selectedConfig.centerServingColor = material.colore;
    }
    
    // Visual feedback
    const optionsMap = {
        'string': 'string-color-options',
        'serving': 'serving-color-options',
        'center': 'center-color-options'
    };
    const optionsDiv = document.getElementById(optionsMap[type]);
    if (optionsDiv) {
        optionsDiv.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('border-primary', 'bg-primary/10');
        });
        event.currentTarget.classList.add('border-primary', 'bg-primary/10');
    }
    
    updateSummary();
}

function getColorCode(colorName) {
    const colors = {
        'black': '#000000', 'nero': '#000000',
        'white': '#FFFFFF', 'bianco': '#FFFFFF',
        'red': '#FF0000', 'rosso': '#FF0000',
        'blue': '#0000FF', 'blu': '#0000FF',
        'green': '#00FF00', 'verde': '#00FF00',
        'yellow': '#FFFF00', 'giallo': '#FFFF00',
        'orange': '#FFA500', 'arancione': '#FFA500',
        'purple': '#800080', 'viola': '#800080',
        'pink': '#FFC0CB', 'rosa': '#FFC0CB',
        'brown': '#8B4513', 'marrone': '#8B4513',
        'gray': '#808080', 'grigio': '#808080',
        'grey': '#808080'
    };
    return colors[colorName.toLowerCase()] || '#CCCCCC';
}

function toggleCenterServing() {
    const checkbox = document.getElementById('include-center-serving');
    const options = document.getElementById('center-serving-options');
    selectedConfig.centerServing = checkbox.checked;
    options.style.display = checkbox.checked ? 'block' : 'none';
    updateSummary();
}

function toggleCustomPosition() {
    const position = document.getElementById('center-serving-position').value;
    const customSection = document.getElementById('custom-position-section');
    customSection.style.display = position === 'custom' ? 'block' : 'none';
    updateSummary();
}

function updateSummary() {
    // Collect all configuration values
    selectedConfig.stringType = document.getElementById('string-type').value;
    selectedConfig.length = parseFloat(document.getElementById('string-length').value) || null;
    selectedConfig.strandCount = parseInt(document.getElementById('strand-count').value) || null;
    selectedConfig.nockSize = document.getElementById('nock-size').value;
    selectedConfig.endServingLength = parseFloat(document.getElementById('end-serving-length').value) || 2.5;
    selectedConfig.centerServingLength = parseFloat(document.getElementById('center-serving-length')?.value) || 6;
    selectedConfig.centerServingPosition = document.getElementById('center-serving-position')?.value || 'middle';
    selectedConfig.centerServingCustomPosition = parseFloat(document.getElementById('custom-position')?.value) || null;
    selectedConfig.preStretch = document.getElementById('pre-stretch').checked;
    selectedConfig.haveExistingString = document.getElementById('have-existing-string').checked;
    selectedConfig.instructions = document.getElementById('special-instructions').value;
    
    // Build summary HTML
    const summaryDiv = document.getElementById('summary-content');
    let html = '';
    
    if (selectedConfig.stringType) {
        html += `<div><span class="font-semibold">Type:</span> ${selectedConfig.stringType}</div>`;
    }
    if (selectedConfig.length) {
        html += `<div><span class="font-semibold">Length:</span> ${selectedConfig.length}"</div>`;
    }
    if (selectedConfig.stringMaterial && selectedConfig.stringColor) {
        html += `<div><span class="font-semibold">String:</span> ${selectedConfig.stringMaterial} - ${selectedConfig.stringColor}</div>`;
    }
    if (selectedConfig.strandCount) {
        html += `<div><span class="font-semibold">Strands:</span> ${selectedConfig.strandCount}</div>`;
    }
    if (selectedConfig.nockSize) {
        html += `<div><span class="font-semibold">Nock:</span> ${selectedConfig.nockSize === '1' ? 'Small' : 'Large'}</div>`;
    }
    if (selectedConfig.endServingMaterial && selectedConfig.endServingColor) {
        html += `<div><span class="font-semibold">End Serving:</span> ${selectedConfig.endServingMaterial} - ${selectedConfig.endServingColor} (${selectedConfig.endServingLength}")</div>`;
    }
    if (selectedConfig.centerServing) {
        const centerMat = selectedConfig.centerServingMaterial || selectedConfig.endServingMaterial;
        const centerCol = selectedConfig.centerServingColor || selectedConfig.endServingColor;
        html += `<div><span class="font-semibold">Center Serving:</span> ${centerMat} - ${centerCol} (${selectedConfig.centerServingLength}")</div>`;
    }
    if (selectedConfig.preStretch) {
        html += `<div class="text-blue-600 dark:text-blue-400"><i class="fas fa-check mr-1"></i>Pre-stretched</div>`;
    }
    if (selectedConfig.haveExistingString) {
        html += `<div class="text-blue-600 dark:text-blue-400"><i class="fas fa-copy mr-1"></i>1:1 copy of existing string</div>`;
    }
    
    summaryDiv.innerHTML = html || '<p class="text-gray-500 dark:text-gray-400 italic">Select options to see your configuration</p>';
    
    // Check if all required fields are filled
    const isValid = selectedConfig.stringType && 
                    selectedConfig.length && 
                    selectedConfig.stringMaterial && 
                    selectedConfig.stringColor && 
                    selectedConfig.strandCount && 
                    selectedConfig.nockSize &&
                    selectedConfig.endServingMaterial && 
                    selectedConfig.endServingColor;
    
    document.getElementById('add-to-cart-btn').disabled = !isValid;
    
    // Update pricing
    updatePrice();
    
    // Redraw canvas
    drawStringPreview();
}

function updatePrice() {
    let price = basePrice;
    let customizationCost = 0;
    
    // Count unique colors (for extra cost calculation)
    const colors = new Set();
    if (selectedConfig.stringColor) colors.add(selectedConfig.stringColor);
    if (selectedConfig.endServingColor) colors.add(selectedConfig.endServingColor);
    if (selectedConfig.centerServingColor) colors.add(selectedConfig.centerServingColor);
    
    // Extra cost for 3+ colors
    if (colors.size >= 3) {
        customizationCost += 3.00;
    }
    
    // Extra cost for different loop/center serving colors
    if (selectedConfig.centerServing && 
        selectedConfig.centerServingColor && 
        selectedConfig.centerServingColor !== selectedConfig.endServingColor) {
        customizationCost += 2.00;
    }
    
    // Extra cost for longer strings
    if (selectedConfig.length && selectedConfig.length > 68) {
        customizationCost += (selectedConfig.length - 68) * 0.50;
    }
    
    // Extra cost for more strands
    if (selectedConfig.strandCount && selectedConfig.strandCount > 16) {
        customizationCost += (selectedConfig.strandCount - 16) * 0.25;
    }
    
    // Extra cost for pre-stretch
    if (selectedConfig.preStretch) {
        customizationCost += 2.00;
    }
    
    // Extra cost for custom center serving position
    if (selectedConfig.centerServing && selectedConfig.centerServingPosition === 'custom') {
        customizationCost += 1.00;
    }
    
    const totalPrice = price + customizationCost;
    
    document.getElementById('base-price').textContent = `€${price.toFixed(2)}`;
    document.getElementById('custom-price').textContent = `€${customizationCost.toFixed(2)}`;
    document.getElementById('total-price').textContent = `€${totalPrice.toFixed(2)}`;
}

function drawStringPreview() {
    const canvas = document.getElementById('string-canvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas
    const isDark = document.documentElement.classList.contains('dark');
    ctx.fillStyle = isDark ? '#111827' : '#F9FAFB';
    ctx.fillRect(0, 0, width, height);
    
    // Get configuration
    const strandCount = selectedConfig.strandCount || 16;
    const stringColor = selectedConfig.stringColor ? getColorCode(selectedConfig.stringColor) : '#8B4513';
    const servingColor = selectedConfig.endServingColor ? getColorCode(selectedConfig.endServingColor) : '#000000';
    const centerServingColor = selectedConfig.centerServingColor ? getColorCode(selectedConfig.centerServingColor) : servingColor;
    
    // Drawing parameters (from C# reference)
    const w = width * 0.8;
    const h = 120;
    const offsetX = (width - w) / 2;
    const offsetY = 15;
    const y1 = offsetY;
    const y0 = -h - 90;
    const off = 8;
    const length = off * strandCount;
    
    // Draw twisted string (4 passes from C# algorithm)
    ctx.lineCap = 'round';
    ctx.lineWidth = 4;
    ctx.globalAlpha = 0.8;
    
    for (let j = 0; j < 4; j++) {
        for (let i = 0; i < strandCount; i++) {
            const xi = offsetX - 30;
            const yi = y0 + i * off + j * length;
            const xf = offsetX + w + 30;
            const yf = y1 + i * off + j * length;
            
            ctx.strokeStyle = stringColor;
            ctx.beginPath();
            ctx.moveTo(xi, yi);
            ctx.lineTo(xf, yf);
            ctx.stroke();
        }
    }
    
    ctx.globalAlpha = 1.0;
    
    // Draw end servings (rectangular shape as requested)
    const endServingLen = (selectedConfig.endServingLength / (selectedConfig.length || 68)) * w;
    drawRectServing(ctx, offsetX, offsetY, endServingLen, 30, servingColor);
    drawRectServing(ctx, offsetX + w - endServingLen, offsetY, endServingLen, 30, servingColor);
    
    // Draw center serving if enabled
    if (selectedConfig.centerServing) {
        const centerLen = (selectedConfig.centerServingLength / (selectedConfig.length || 68)) * w;
        let centerX = offsetX + (w - centerLen) / 2; // default middle
        
        if (selectedConfig.centerServingPosition === 'upper') {
            centerX = offsetX + w * 0.3 - centerLen / 2;
        } else if (selectedConfig.centerServingPosition === 'lower') {
            centerX = offsetX + w * 0.7 - centerLen / 2;
        } else if (selectedConfig.centerServingPosition === 'custom' && selectedConfig.centerServingCustomPosition) {
            const customPos = (selectedConfig.centerServingCustomPosition / (selectedConfig.length || 68));
            centerX = offsetX + w * customPos - centerLen / 2;
        }
        
        drawRectServing(ctx, centerX, offsetY, centerLen, 30, centerServingColor);
    }
    
    // Draw labels
    ctx.font = '12px Arial';
    ctx.fillStyle = isDark ? '#9CA3AF' : '#4B5563';
    ctx.textAlign = 'left';
    
    const labelY = offsetY + 50;
    ctx.fillText(`${selectedConfig.stringType || 'String'} - ${strandCount} strands`, offsetX, labelY);
    
    if (selectedConfig.length) {
        ctx.textAlign = 'center';
        ctx.fillText(`${selectedConfig.length}"`, width / 2, offsetY - 5);
        
        // Draw arrows for length
        ctx.strokeStyle = isDark ? '#9CA3AF' : '#4B5563';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(offsetX, offsetY - 10);
        ctx.lineTo(offsetX + w, offsetY - 10);
        ctx.stroke();
        
        // Arrow heads
        ctx.beginPath();
        ctx.moveTo(offsetX, offsetY - 10);
        ctx.lineTo(offsetX + 5, offsetY - 13);
        ctx.moveTo(offsetX, offsetY - 10);
        ctx.lineTo(offsetX + 5, offsetY - 7);
        ctx.moveTo(offsetX + w, offsetY - 10);
        ctx.lineTo(offsetX + w - 5, offsetY - 13);
        ctx.moveTo(offsetX + w, offsetY - 10);
        ctx.lineTo(offsetX + w - 5, offsetY - 7);
        ctx.stroke();
    }
}

function drawRectServing(ctx, x, y, width, height, color) {
    // Draw rectangular serving area
    ctx.fillStyle = color;
    ctx.globalAlpha = 0.9;
    ctx.fillRect(x, y, width, height);
    
    // Add texture lines
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
    ctx.lineWidth = 1;
    for (let i = x; i < x + width; i += 2) {
        ctx.beginPath();
        ctx.moveTo(i, y);
        ctx.lineTo(i, y + height);
        ctx.stroke();
    }
    
    ctx.globalAlpha = 1.0;
}

function addToCart() {
    // Validate configuration
    if (!document.getElementById('add-to-cart-btn').disabled) {
        // Create cart item
        const cartItem = {
            productId: {{ product.id }},
            name: '{{ product.name_en }}',
            type: 'custom_string',
            config: selectedConfig,
            price: parseFloat(document.getElementById('total-price').textContent.replace('€', ''))
        };
        
        // Get existing cart
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.push(cartItem);
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Show notification and redirect
        showNotification('String configuration added to cart!');
        setTimeout(() => {
            window.location.href = '/shop/cart';
        }, 1500);
    }
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>

{% endblock %}
